### 2.5 AI Knowledge Engine

> **架构决策**：AI 功能**必须**通过 REST API 实现（非 PowerSync），因为：
> 1. AI 功能需要网络连接才能使用
> 2. SSE 流式响应无法通过 PowerSync 实现
> 3. 需要服务端计费和限流控制
>
> **对话记录存储**：AI 对话历史通过 PowerSync 同步到本地 SQLite，实现离线查看历史对话。

#### A. 技术栈
| 组件 | 技术选型 | 说明 |
|------|---------|------|
| 后端框架 | **FastAPI** | 异步支持、SSE 流式响应 |
| RAG 框架 | **LlamaIndex** | 向量检索、Query Rewrite、Rerank |
| PDF 解析 | **IBM Docling** | 提取章节结构、表格、图表 |
| 前端 AI SDK | **Vercel AI SDK** | 统一流式接口、`onFinish` Token 计数 |
| 向量存储 | **PostgreSQL + pgvector** | 与主数据库统一 |
| LLM 调用 | **OpenAI / Claude API** | 可配置模型 |

#### B. 三种 AI 模式

| 模式 | 触发场景 | 技术实现 | 费用 |
|------|---------|----------|------|
| **聊天模式** | 通用对话/闲聊 | 纯 LLM，无 RAG，无书库上下文 | 低 (约 0.3-1 Credits/次) |
| **翻译模式** | 选中文本 → 翻译 | 纯 LLM，无 RAG | 低 (约 0.5 Credits/次) |
| **问答模式** | 书籍内对话/提问 | RAG Pipeline | 中 (约 2-5 Credits/次) |

**聊天模式流程**：
```
用户在 AI 助手界面发起对话（未关联书籍）
    ↓
POST /api/v1/ai/chat
    ↓
直接调用 LLM (无向量检索，无书库上下文)
    ↓
SSE 流式返回回答
```

> **聊天模式说明**：
> - 不涉及用户书库内容，纯通用 AI 对话
> - 适用于：写作辅助、知识问答、头脑风暴等通用场景
> - 入口：AI 助手面板 → 新建对话（不关联书籍）

**翻译模式流程**：
```
用户选中文本 → 点击"翻译"按钮
    ↓
POST /api/v1/ai/translate
    ↓
直接调用 LLM (无向量检索)
    ↓
SSE 流式返回翻译结果
```

**问答模式 RAG 流程**：
```
用户提问
    ↓
1. Query Rewrite (基于上下文重写查询)
    ↓
2. Vector Search (pgvector Top-K 检索)
    ↓
3. IBM Docling 解析 (提取章节/表格结构)
    ↓
4. Rerank (Cross-Encoder 重排序)
    ↓
5. LLM 生成回答 (含引用与跳转锚点)
    ↓
6. SSE 流式输出
    ↓
7. onFinish: Token 计数 → Credits 扣费
```

#### C. IBM Docling 集成

> **用途**：将 PDF 解析为结构化文档，提取章节、表格、图表。

```python
from docling.document_converter import DocumentConverter

converter = DocumentConverter()

def parse_book_for_rag(book_id: str, pdf_path: str) -> list[dict]:
    """解析书籍为 RAG 可用的结构化块"""
    result = converter.convert(pdf_path)
    document = result.document
    
    chunks = []
    for item in document.iterate_items():
        if item.label in ["paragraph", "table", "figure"]:
            chunks.append({
                "book_id": book_id,
                "content": item.text,
                "type": item.label,
                "page": item.prov[0].page if item.prov else None,
                "bbox": item.prov[0].bbox if item.prov else None,
            })
    return chunks
```

#### D. Vercel AI SDK 前端集成

> **Token 计数**：使用 `onFinish` 回调获取真实 Token 消耗，用于 Credits 扣费。

```typescript
import { useChat } from 'ai/react';

function AIChat({ conversationId }: { conversationId: string }) {
  const { messages, input, handleInputChange, handleSubmit } = useChat({
    api: '/api/v1/ai/conversations/' + conversationId + '/messages',
    onFinish: (message, { usage }) => {
      // usage.totalTokens 包含真实 Token 消耗
      console.log('Token usage:', usage?.totalTokens);
      // 后端已在 SSE 结束时扣费，此处仅用于 UI 显示
    },
  });
  
  return (/* UI 组件 */);
}
```

#### A. 数据库模型（Database Schema）

**`ai_conversations` 表**（启用 RLS）：
| 字段 | 类型 | 说明 |
|:-----|:-----|:-----|
| `id` | UUID, PK | 会话 ID |
| `user_id` | UUID, FK | 用户 ID |
| `title` | TEXT | 会话标题 |
| `book_id` | UUID, Nullable | 关联书籍（可选） |
| `related_context` | JSONB | 上下文（选中文本、笔记引用等） |
| `conversation_history` | JSONB | 消息历史数组 |
| `version` | INTEGER, Default: 1 | 乐观锁版本号（用于 ETag/If-Match） |
| `deleted_at` | TIMESTAMPTZ, Nullable | 软删除时间 |
| `created_at` | TIMESTAMPTZ | 创建时间 |
| `updated_at` | TIMESTAMPTZ | 更新时间 |

**消息结构**（存储在 `conversation_history` JSONB 中）：
```typescript
interface AIMessage {
  role: 'user' | 'assistant' | 'system';
  text: string;
  refs?: Array<{
    type: 'highlight' | 'note' | 'location';
    cfi?: string;
    bookId?: string;
    content?: string;
  }>;
  created_at: string; // ISO8601
}
```

**RLS 策略**（用户隔离）：
```sql
ALTER TABLE ai_conversations ENABLE ROW LEVEL SECURITY;
CREATE POLICY ai_conversations_user ON ai_conversations
  FOR ALL USING (user_id = current_setting('app.user_id')::uuid);
```

#### B. 后端逻辑与 API 契约（Backend & Contract）

**端点清单**（详见 05 契约）：
| 端点 | 方法 | 说明 |
|:-----|:-----|:-----|
| `/api/v1/ai/conversations` | GET | 列出会话（分页，cursor-based） |
| `/api/v1/ai/conversations` | POST | 创建会话 + 首条消息 |
| `/api/v1/ai/conversations/{id}` | GET | 获取会话详情（返回 ETag） |
| `/api/v1/ai/conversations/{id}` | PATCH | 修改标题/元数据（需 If-Match） |
| `/api/v1/ai/conversations/{id}` | DELETE | 软删除会话 |
| `/api/v1/ai/conversations/{id}/messages` | POST | 追加消息（触发 AI 回复，SSE 流式） |
- 规则：
  - AI Chat 不受只读锁影响。
  - Credits 不足 → 返回 `INSUFFICIENT_CREDITS`。
  - 计费顺序：月度赠礼 → 加油包 → Wallet → 拒绝。
  - 会话版本冲突：使用 `ETag/If-Match` 或 Session Version，冲突返回 409。
- RAG 流程：
  1) Query Rewrite：基于用户上下文重写查询 (LlamaIndex QueryTransform)。
  2) Vector Search：PostgreSQL pgvector 检索 Top-K 片段。
  3) Docling Parse：对 PDF 源提取章节/表格结构。
  4) Re-rank：LlamaIndex Reranker + Cross-Encoder 重排序。
  4) LLM 生成：以重排后的证据生成回答，包含引用与跳转锚点。
  5) 流式输出：使用 SSE/WebSocket 推送；支持“停止/继续”。
  7) Token 计费：onFinish 回调获取 Token 数，扣除 Credits。
> Status: Contract Available；Backend = To Implement（按此管线实现）。

#### F. 前端组件契约（Frontend Contract）
- 组件：`AIConversationsPanel`
  - Props：
    ```ts
    interface AIConversationsPanelProps {
      sessionId?: string
      onMessage?: (msg: { id: string; role: 'user' | 'assistant'; content: string }) => void
      onStop?: () => void
    }
    ```

### ✔ Definition of Done (DoD)
- [ ] API 契约与 SSE/WebSocket 行为对齐
- [ ] Credits 扣费顺序与不足错误用例
- [ ] RAG 各阶段可替换/Mock 的测试策略
- [ ] ETag/Session Version 冲突处理测试
- [ ] 前端消息流与停止/继续契约实现
- [ ] 账单联动与台账记录验证
---