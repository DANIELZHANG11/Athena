# 02 - åŠŸèƒ½è§„æ ¼ä¸å‚ç›´åˆ‡ç‰‡ (Functional Specifications PRD)

> **ç‰ˆæœ¬**ï¼šv2.1 (App-First Edition)
> **å®šä½**ï¼šäº§å“åŠŸèƒ½éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰ï¼Œå®šä¹‰å„åŠŸèƒ½æ¨¡å—çš„å®ç°è§„æ ¼ä¸ App-First æ¶æ„çº¦æŸã€‚

## 1. æ ¸å¿ƒåŠŸèƒ½æ¦‚è§ˆ
- User & Authï¼ˆç™»å½•/æ³¨å†Œ/JWTï¼‰
- Books & Shelvesï¼ˆä¸Šä¼ /åˆ—è¡¨/OCR è§¦å‘/ä¹¦æ¶ï¼‰
- Reader Coreï¼ˆé˜…è¯»å™¨ä¸ PowerSync è¿›åº¦åŒæ­¥ï¼‰
- Notes & Highlightsï¼ˆç¬”è®°/é«˜äº®/æ ‡ç­¾/æœç´¢ï¼‰
- AI Knowledge Engineï¼ˆRAG å¯¹è¯/æµå¼è¾“å‡ºï¼‰
- Billing & Accountï¼ˆå……å€¼/é…é¢/åªè¯»é”é€»è¾‘ï¼‰

è¯´æ˜ï¼šæ¥å£å®šä¹‰ä»¥ 05 å·æ–‡æ¡£ï¼ˆAPI å¥‘çº¦ï¼‰ä¸ºå‡†ï¼›æ•°æ®åº“ç»“æ„ä»¥ 04 å·æ–‡æ¡£ï¼ˆDBï¼‰ä¸ºå‡†ã€‚å“åº”æ ¼å¼ä»¥ã€Š00_AI_Coding_Constitution_and_Rules.mdã€‹çš„é”™è¯¯ç  Schema ä¸ºå‡†ï¼›æˆåŠŸå“åº”ä»¥ 05 å¥‘çº¦ä¸ºå‡†ï¼ˆé€šå¸¸ä¸º `{ data: ... }`ï¼‰ã€‚

### 1.1 App-First å®æ–½åŸåˆ™

1. **æ•°æ®æ€»çº¿**ï¼šæ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»éµå¾ª `UI â†’ SQLite (PowerSync SDK) â†’ PowerSync Service â†’ PostgreSQL` çš„é—­ç¯ã€‚å‰ç«¯ç»„ä»¶ç¦æ­¢ç›´æ¥ä¾èµ– REST API æ¸²æŸ“ã€‚
2. **æœ¬åœ°ä¼˜å…ˆå†™å…¥**ï¼šCUD æ“ä½œé€šè¿‡ PowerSync Repository å†™å…¥æœ¬åœ° SQLite å¹¶ç”± SDK è‡ªåŠ¨ä¸Šä¼ ï¼ŒREST API ä»…ä¿ç•™é‰´æƒã€è®¡è´¹ã€AI SSEã€ä¸Šä¼ åˆå§‹åŒ–ç­‰åœºæ™¯ã€‚
3. **Feature Flag**ï¼š`APP_FIRST_ENABLED` æ§åˆ¶ PowerSync Provider æ³¨å…¥ï¼ˆå·²å¯ç”¨ï¼‰ã€‚
4. **å†²çªç­–ç•¥**ï¼šé˜…è¯»è¿›åº¦ä½¿ç”¨ LWWï¼Œç¬”è®°/é«˜äº®é‡‡ç”¨ Conflict Copyï¼Œä¹¦æ¶/è®¾ç½®å­—æ®µæŒ‰åˆ—åˆå¹¶ã€‚
5. **ç«¯å·®å¼‚åŒ–**ï¼š
  * Mobileï¼šé€šè¿‡ `capacitor-community/sqlite` è°ƒç”¨åŸç”Ÿ SQLite å¼•æ“ã€‚
  * Webï¼šé€šè¿‡ `sqlite-wasm` + OPFS æä¾›ä¸€è‡´ä½“éªŒã€‚
6. **è§‚æµ‹**ï¼šPowerSync Service å¿…é¡»æ¥å…¥ Prometheus/Grafana ç›‘æ§ã€‚

### 1.2 App-First ç”¨æˆ·æ•…äº‹ (App-First User Stories)

> **æ ¸å¿ƒä»·å€¼**ï¼šæè‡´çš„å“åº”é€Ÿåº¦ä¸æ— ç¼çš„ç¦»çº¿ä½“éªŒã€‚

#### Story 1: æ— ç½‘ç¯å¢ƒä¸‹çš„æ²‰æµ¸é˜…è¯»
**åœºæ™¯**ï¼šç”¨æˆ·åœ¨é£å¾€çº½çº¦çš„èˆªç­ä¸Šï¼ˆæ— ç½‘ç»œï¼‰ã€‚
- **è¡Œä¸º**ï¼šç”¨æˆ·æ‰“å¼€é›…å…¸å¨œ Appï¼Œ**é›¶å»¶è¿Ÿ**è¿›å…¥ä¹¦æ¶ï¼Œæ‰“å¼€ã€ŠThinking Fast and Slowã€‹ã€‚
- **æ“ä½œ**ï¼šç”¨æˆ·é˜…è¯»äº† 50 é¡µï¼Œå¹¶æ·»åŠ äº† 3 æ¡ç¬”è®°å’Œ 5 ä¸ªé«˜äº®ã€‚
- **ç³»ç»Ÿ**ï¼šæ‰€æœ‰æ•°æ®ç›´æ¥å†™å…¥æœ¬åœ° SQLiteï¼Œç•Œé¢æ— ä»»ä½• Loadingã€‚
- **ç»“æœ**ï¼šé£æœºé™è½è¿æ¥ Wi-Fi åï¼ŒPowerSync åå°è‡ªåŠ¨é™é»˜åŒæ­¥ï¼Œè¿›åº¦å’Œç¬”è®°å‡ºç°åœ¨ç”¨æˆ·çš„ iPad ä¸Šã€‚

#### Story 2: å¤šç«¯å†²çªçš„ä¼˜é›…å¤„ç†
**åœºæ™¯**ï¼šç”¨æˆ·åŒæ—¶åœ¨ iPhoneï¼ˆç¦»çº¿ï¼‰å’Œ Webï¼ˆåœ¨çº¿ï¼‰ä¸Šä¿®æ”¹äº†åŒä¸€æ¡ç¬”è®°ã€‚
- **è¡Œä¸º**ï¼š
  1. iPhone ä¸Šä¿®æ”¹ç¬”è®°ï¼š"è¿™æ˜¯ä¸€æœ¬å¥½ä¹¦ã€‚" -> "è¿™æ˜¯ä¸€æœ¬**ç»å¦™çš„**ä¹¦ã€‚"ï¼ˆç¦»çº¿ä¿å­˜ï¼‰
  2. Web ä¸Šä¿®æ”¹ç¬”è®°ï¼š"è¿™æ˜¯ä¸€æœ¬å¥½ä¹¦ã€‚" -> "è¿™æ˜¯ä¸€æœ¬**å……æ»¡æ™ºæ…§çš„**ä¹¦ã€‚"ï¼ˆåœ¨çº¿ä¿å­˜ï¼‰
- **ç³»ç»Ÿ**ï¼šå½“ iPhone æ¢å¤ä¸Šçº¿æ—¶ï¼ŒPowerSync æ£€æµ‹åˆ°ç‰ˆæœ¬å†²çªï¼Œä¸è¦†ç›–ä»»ä½•ä¸€æ–¹ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª "Conflict Copy"ã€‚
- **ç»“æœ**ï¼šç”¨æˆ·åœ¨ç¬”è®°åˆ—è¡¨çœ‹åˆ°ä¸¤æ¡ç¬”è®°ï¼Œå¹¶é™„å¸¦ "âš ï¸ ç‰ˆæœ¬å†²çª" æ ‡è®°ï¼Œç”¨æˆ·ç‚¹å‡» "åˆå¹¶"ï¼Œæ‰‹åŠ¨æ•´åˆæˆ "è¿™æ˜¯ä¸€æœ¬**ç»å¦™ä¸”å……æ»¡æ™ºæ…§çš„**ä¹¦ã€‚"

#### Story 3: ç§’çº§å¯åŠ¨ä¸å…¨å±€æœç´¢
**åœºæ™¯**ï¼šç”¨æˆ·æ‹¥æœ‰ 10,000 æ¡ç¬”è®°ã€‚
- **è¡Œä¸º**ï¼šç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥ "ç»æµå­¦"ã€‚
- **ç³»ç»Ÿ**ï¼šä½¿ç”¨ SQLite FTS5 æœ¬åœ°å…¨æ–‡æ£€ç´¢ï¼Œ**10ms å†…** è¿”å›ç»“æœï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚ã€‚
- **ç»“æœ**ï¼šç»“æœå³æ—¶å±•ç¤ºï¼Œç‚¹å‡»ä»»æ„æœç´¢ç»“æœç›´æ¥è·³è½¬åˆ°ä¹¦ç±å¯¹åº”æ®µè½ï¼Œä½“éªŒå¦‚åŸç”Ÿ App èˆ¬ä¸æ»‘ã€‚

#### Story 4: è·¨è®¾å¤‡æ— ç¼æ¥åŠ›
**åœºæ™¯**ï¼šç”¨æˆ·åœ¨é€šå‹¤åœ°é“ä¸Šä½¿ç”¨æ‰‹æœºé˜…è¯»ã€‚
- **è¡Œä¸º**ï¼šç”¨æˆ·çœ‹åˆ°ç¬¬ 125 é¡µï¼Œåœ°é“åˆ°ç«™ï¼Œç”¨æˆ·é”å±æ‰‹æœºã€‚
- **ç³»ç»Ÿ**ï¼šPowerSync åœ¨åå°ï¼ˆæˆ–ä¸‹æ¬¡æ‰“å¼€æ—¶ï¼‰æé€Ÿä¸Šä¼ æœ€åé˜…è¯»ä½ç½® CFIã€‚
- **ç»“æœ**ï¼šç”¨æˆ·å›åˆ°å®¶æ‰“å¼€ iPadï¼Œä¹¦ç±å°é¢æ˜¾ç¤ºè¿›åº¦æ¡å·²æ›´æ–°ï¼Œç‚¹å‡»ç›´æ¥è·³è½¬åˆ°ç¬¬ 125 é¡µï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚


## 2. å‚ç›´åˆ‡ç‰‡è¯¦æƒ…ï¼ˆVertical Slicesï¼‰

### 2.1 User & Auth

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰
- `users`ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`email (LOWERCASE, UNIQUE)`ã€`display_name (TEXT)`ã€`avatar_url (TEXT, Nullable)`ã€`is_active (BOOL)`ã€`language (TEXT)`ã€`timezone (TEXT)`ã€`membership_expire_at (TIMESTAMPTZ)`ã€`monthly_gift_reset_at (TIMESTAMPTZ)`ã€`free_ocr_usage (INT DEFAULT 0)`ã€`updated_at (TIMESTAMPTZ)`ã€‚
  - æƒé™å­—æ®µï¼š`user_id` ä¸é€‚ç”¨ï¼ˆç”¨æˆ·ä¸»è¡¨ï¼‰ï¼›RLS ä¾èµ–ä¼šè¯å˜é‡ `app.user_id`ã€‚
- `user_sessions`ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`user_id (UUID, FK users.id)`ã€`revoked (BOOL)`ã€`created_at (TIMESTAMPTZ)`ã€‚
  - å…³ç³»ï¼š`users (1) â€” (N) user_sessions`ã€‚
- `user_oauth_accounts` ğŸ†•ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`user_id (UUID, FK users.id)`ã€`provider (VARCHAR(20))`ã€`provider_user_id (TEXT)`ã€`provider_email (TEXT, Nullable)`ã€`access_token (TEXT, Encrypted)`ã€`refresh_token (TEXT, Nullable, Encrypted)`ã€`token_expires_at (TIMESTAMPTZ, Nullable)`ã€`raw_profile (JSONB)`ã€`created_at (TIMESTAMPTZ)`ã€`updated_at (TIMESTAMPTZ)`ã€‚
  - çº¦æŸï¼šUNIQUE (`provider`, `provider_user_id`)ï¼›UNIQUE (`user_id`, `provider`)ã€‚
  - å…³ç³»ï¼š`users (1) â€” (N) user_oauth_accounts`ã€‚
  - **Provider æšä¸¾**ï¼š`wechat`ã€`google`ã€`microsoft`ã€`apple`ã€‚

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰

##### B.1 é‚®ç®±éªŒè¯ç ç™»å½•
- ç«¯ç‚¹ï¼š`POST /auth/email/send-code`ã€`POST /auth/email/verify-code`ã€`POST /auth/refresh`ã€`POST /auth/logout`ã€`GET /auth/sessions`ã€`GET /auth/me`ã€‚
- **æ–°å¢ç«¯ç‚¹**ï¼š`DELETE /auth/sessions/{id}` (è¸¢å‡ºæŒ‡å®šè®¾å¤‡)ã€‚
- è§„åˆ™ï¼šæˆåŠŸç™»å½•ååˆ›å»º `user_sessions` å¹¶ç­¾å‘ `access_token/refresh_token`ï¼›å—ä¿æŠ¤ç«¯ç‚¹éœ€ `Authorization: Bearer`ã€‚

##### B.2 ç¬¬ä¸‰æ–¹ OAuth ç™»å½• ğŸ†•

> **æ”¯æŒå¹³å°**ï¼šå¾®ä¿¡ï¼ˆWeChatï¼‰ã€Googleã€Microsoftã€Apple

**OAuth è®¤è¯ç«¯ç‚¹**ï¼š
| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|:-----|:----|:-----|
| `/auth/oauth/{provider}/authorize` | GET | è·å– OAuth æˆæƒ URLï¼ˆé‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹ï¼‰ |
| `/auth/oauth/{provider}/callback` | GET | OAuth å›è°ƒç«¯ç‚¹ï¼ˆå¤„ç†æˆæƒç ï¼‰ |
| `/auth/oauth/{provider}/token` | POST | ç§»åŠ¨ç«¯ç”¨ï¼šç›´æ¥äº¤æ¢ OAuth Token |

**æ”¯æŒçš„ Provider æšä¸¾**ï¼š
```typescript
type OAuthProvider = 'wechat' | 'google' | 'microsoft' | 'apple';
```

**å„å¹³å°ç‰¹æ®Šå¤„ç†**ï¼š
| å¹³å° | ç‰¹æ®Šé…ç½® | è¯´æ˜ |
|:-----|:--------|:-----|
| **å¾®ä¿¡** | éœ€åŒºåˆ† App/Web | App ä½¿ç”¨ `open.weixin.qq.com`ï¼ŒWeb ä½¿ç”¨ `api.weixin.qq.com` |
| **Google** | ID Token éªŒè¯ | ç§»åŠ¨ç«¯å¯ç›´æ¥å‘é€ Google ID Token |
| **Microsoft** | Azure AD B2C | æ”¯æŒä¸ªäººè´¦å·å’Œå·¥ä½œè´¦å· |
| **Apple** | Sign in with Apple | iOS å¿…é¡»æ”¯æŒï¼ˆApp Store å®¡æ ¸è¦æ±‚ï¼‰|

**OAuth ç™»å½•æµç¨‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯   â”‚ â”€â”€â†’  â”‚ /authorize  â”‚ â”€â”€â†’  â”‚ ç¬¬ä¸‰æ–¹ OAuth â”‚
â”‚         â”‚      â”‚ è·å–æˆæƒ URL â”‚      â”‚ æˆæƒé¡µé¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â†“ ç”¨æˆ·æˆæƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯   â”‚ â†â”€â”€  â”‚ /callback   â”‚ â†â”€â”€  â”‚ å›è°ƒ + code  â”‚
â”‚ è·å– JWTâ”‚      â”‚ éªŒè¯ + ç­¾å‘  â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç§»åŠ¨ç«¯ Token äº¤æ¢**ï¼ˆé€‚ç”¨äº Google/Apple åŸç”Ÿ SDKï¼‰ï¼š
```json
POST /auth/oauth/google/token
{
  "id_token": "<Google ID Token from native SDK>",
  "device_id": "uuid"
}

Response 200:
{
  "access_token": "...",
  "refresh_token": "...",
  "user": { "id": "...", "email": "...", "is_new": true }
}
```

**è´¦å·ç»‘å®šè§„åˆ™**ï¼š
1. **é¦–æ¬¡ç™»å½•**ï¼šè‡ªåŠ¨åˆ›å»ºè´¦å·ï¼ŒOAuth ID ä½œä¸ºä¸»æ ‡è¯†
2. **é‚®ç®±åŒ¹é…**ï¼šå¦‚æœ OAuth é‚®ç®±å·²æ³¨å†Œï¼Œè‡ªåŠ¨ç»‘å®šåˆ°ç°æœ‰è´¦å·
3. **å¤šæ¸ é“ç»‘å®š**ï¼šåŒä¸€è´¦å·å¯ç»‘å®šå¤šä¸ª OAuth æ¸ é“
4. **è§£ç»‘é™åˆ¶**ï¼šè‡³å°‘ä¿ç•™ä¸€ç§ç™»å½•æ–¹å¼ï¼ˆé‚®ç®±æˆ– OAuthï¼‰

#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`AuthForm`
  - Propsï¼š
    ```ts
    interface AuthFormProps {
      onSuccess: (tokens: { accessToken: string; refreshToken: string }) => void
      onError: (message: string) => void
      /** å½“è§¦å‘ 429 æ—¶è°ƒç”¨ï¼ŒUI åº”å†»ç»“å‘é€æŒ‰é’®å¹¶æ˜¾ç¤ºå€’è®¡æ—¶ */
      onRateLimit: (retryAfterSeconds: number) => void
    }
    ```
  - äº¤äº’ï¼šè¾“å…¥é‚®ç®±â†’å‘é€éªŒè¯ç â†’**å¼¹å‡º"é‚®ç®±ç¡®è®¤"å¯¹è¯æ¡†**â†’è¾“å…¥éªŒè¯ç â†’éªŒè¯â†’æˆåŠŸå›è°ƒå¹¶è·³è½¬ï¼›å¤±è´¥å±•ç¤ºé”™è¯¯ã€‚
  - **é˜²è¾“é”™æœºåˆ¶ (Heads-up Confirmation)**ï¼š
    - ç”¨æˆ·ç‚¹å‡»"è·å–éªŒè¯ç "åï¼Œ**ä¸ç«‹å³å‘é€**ã€‚
    - UI å¼¹å‡ºæ¨¡æ€æ¡†ï¼ŒèƒŒæ™¯å˜æš—ï¼Œä»¥**è¶…å¤§å­—å·**æ˜¾ç¤ºåˆšæ‰è¾“å…¥çš„é‚®ç®± `bob@exampl.com`ã€‚
    - è¯¢é—®ï¼š"æˆ‘ä»¬å°†å‘æ­¤é‚®ç®±å‘é€éªŒè¯ç ï¼Œè¯·ç¡®è®¤æ‹¼å†™æ— è¯¯ï¼Ÿ"
    - æŒ‰é’®ï¼š[å†™é”™äº†ï¼Œå»ä¿®æ”¹] [ç¡®è®¤æ— è¯¯ï¼Œå‘é€]
    - *è®¾è®¡ç›®çš„*ï¼šå¢åŠ ä¸€æ­¥"æœ‰ç›Šæ‘©æ“¦"ï¼Œå¼ºåˆ¶ç”¨æˆ·æ£€æŸ¥æ‹¼å†™ï¼Œé˜²æ­¢åƒµå°¸å·äº§ç”Ÿã€‚

#### D. ä¸šåŠ¡è§„åˆ™ï¼ˆBusiness Rulesï¼‰
- æ‰€æœ‰ POST å¿…é¡»æºå¸¦ `Idempotency-Key`ã€‚
- æ‰€æœ‰ PATCH å¿…é¡»æºå¸¦ `If-Match`ã€‚
- æ‰€æœ‰ PATCH å¿…é¡»æºå¸¦ `If-Match`ã€‚
- æ‰€æœ‰ GET å»ºè®®æºå¸¦ `If-None-Match`ï¼ˆå¼±ç¼“å­˜ï¼‰ã€‚
- **å…æ³¨å†Œæœºåˆ¶ (Auto-Registration)**ï¼š
  - ç”¨æˆ·è¾“å…¥é‚®ç®±éªŒè¯ç é€šè¿‡åï¼Œè‹¥æ•°æ®åº“ä¸­ä¸å­˜åœ¨è¯¥é‚®ç®±ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·ã€‚
  - **é£é™©æç¤º**ï¼šå‰ç«¯å¿…é¡»åœ¨ç™»å½•é¡µæ˜¾å¼å£°æ˜ "ç™»å½•å³ä»£è¡¨æ‚¨åŒæ„ã€ŠæœåŠ¡æ¡æ¬¾ã€‹ä¸ã€Šéšç§åè®®ã€‹"ã€‚
- **é¢‘ç‡é™åˆ¶ (Rate Limiting)**ï¼š
  - å‘é€éªŒè¯ç ï¼šå• IP/å•é‚®ç®± 60ç§’å†… 1 æ¬¡ï¼Œ1å°æ—¶å†… 10 æ¬¡ã€‚
  - éªŒè¯å¤±è´¥ï¼šè¿ç»­ 5 æ¬¡å¤±è´¥é”å®š 15 åˆ†é’Ÿã€‚

### âœ” Definition of Done (DoD)
- [ ] API å¥‘çº¦å·²æ›´æ–°å¹¶é€šè¿‡åˆè§„æ ¡éªŒ
- [ ] RLS æµ‹è¯•è¦†ç›–ç™»å½•æ€ä¸å¤šç§Ÿæˆ·éš”ç¦»
- [ ] ETag/Idempotency è§„èŒƒåœ¨å‰åç«¯ä¸€è‡´
- [ ] å‰ç«¯ç»„ä»¶å¥‘çº¦ä¸é”™è¯¯ç æ˜ å°„å¯¹é½
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆå¦‚ä¼šè¯è¡¨å˜æ›´ï¼‰é½å¤‡
- [ ] å•å…ƒ/é›†æˆæµ‹è¯•è¦†ç›–ç™»å½•/åˆ·æ–°/æ³¨é”€

---

### 2.2 Books & Shelves

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰
- `books`ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`user_id (UUID, FK)`ã€`title (TEXT)`ã€`author (TEXT)`ã€`language (TEXT)`ã€`original_format (TEXT)`ã€`minio_key (TEXT)`ã€`size (BIGINT)`ã€`has_text_layer (BOOL)`ã€`text_layer_confidence (FLOAT)`ã€`source_etag (TEXT)`ã€`meta (JSONB)`ã€`digitalize_report_key (TEXT)`ã€`cover_image_key (TEXT)`ã€`converted_epub_key (TEXT)`ã€`updated_at (TIMESTAMPTZ)`ã€‚
  - æƒé™å­—æ®µï¼š`user_id`ï¼ˆRLSï¼‰ã€‚
  - **å»é‡ç›¸å…³å­—æ®µ (SHA256)**ï¼š
    - `content_sha256 (VARCHAR(64))`ï¼šæ–‡ä»¶å†…å®¹ SHA256 å“ˆå¸Œï¼Œç”¨äºå…¨å±€å»é‡
    - `storage_ref_count (INTEGER, DEFAULT 1)`ï¼šå­˜å‚¨å¼•ç”¨è®¡æ•°ï¼Œåˆå§‹å€¼ 1 ä»£è¡¨åŸä¹¦è‡ªå·±
    - `canonical_book_id (UUID, FK books.id)`ï¼šå»é‡å¼•ç”¨æŒ‡å‘çš„åŸå§‹ä¹¦ç± IDï¼Œéç©ºè¡¨ç¤ºæ˜¯å¼•ç”¨ä¹¦
    - `deleted_at (TIMESTAMPTZ)`ï¼šè½¯åˆ é™¤æ—¶é—´æˆ³ï¼Œéç©ºè¡¨ç¤ºå·²è½¯åˆ é™¤
  - **OCR ç›¸å…³å­—æ®µ**ï¼š
    - `ocr_status (VARCHAR(20))`ï¼šOCR çŠ¶æ€ (NULL/pending/processing/completed/failed)
    - `ocr_requested_at (TIMESTAMPTZ)`ï¼šç”¨æˆ·è¯·æ±‚ OCR çš„æ—¶é—´
    - `ocr_pdf_key (TEXT)`ï¼šOCR äº§å‡ºçš„**åŒå±‚ PDF**ï¼ˆDual-Layer PDFï¼‰æ–‡ä»¶åœ¨ MinIO ä¸­çš„ Keyï¼ˆåºŸå¼ƒåŸ JSON Sidecar æ–¹æ¡ˆï¼‰
    - `vector_indexed_at (TIMESTAMPTZ)`ï¼šå‘é‡ç´¢å¼•å®Œæˆæ—¶é—´
  - **å…ƒæ•°æ®å­—æ®µ**ï¼š
    - `metadata_confirmed (BOOLEAN, DEFAULT FALSE)`ï¼šç”¨æˆ·æ˜¯å¦å·²ç¡®è®¤å…ƒæ•°æ®
    - `metadata_confirmed_at (TIMESTAMPTZ)`ï¼šå…ƒæ•°æ®ç¡®è®¤æ—¶é—´
  - å…¶ä»–å­—æ®µè¯´æ˜ï¼š
    - `cover_image_key`ï¼šå°é¢å›¾ç‰‡åœ¨ MinIO ä¸­çš„å­˜å‚¨è·¯å¾„ï¼ˆWebP æ ¼å¼ï¼Œ400Ã—600ï¼‰
    - `converted_epub_key`ï¼šCalibre è½¬æ¢åçš„ EPUB è·¯å¾„ï¼ˆæ ‡è®°å·²è½¬æ¢ï¼‰
- `shelves`ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`user_id (UUID, FK users.id)`ã€`name (TEXT)`ã€`parent_shelf_id (UUID, NULLABLE, FK shelves.id)`ã€`updated_at (TIMESTAMPTZ)`ã€`version (INT)`ã€‚
  - å…³ç³»ï¼š`users (1) â€” (N) shelves`ï¼›æ”¯æŒå±‚çº§ç»“æ„ï¼ˆçˆ¶å­æ¶ï¼‰ã€‚
- `shelf_books`ï¼ˆå…³è”è¡¨ï¼‰ï¼š
  - å­—æ®µï¼š`id (UUID, PK)`ã€`book_id (UUID, FK books.id)`ã€`shelf_id (UUID, FK shelves.id)`ã€`user_id (UUID, FK users.id)`ã€`sort_order (INT)`ã€`added_at (TIMESTAMPTZ)`ã€‚
  - çº¦æŸï¼šå”¯ä¸€çº¦æŸï¼ˆ`book_id`, `shelf_id`ï¼‰ï¼›`ON CONFLICT DO NOTHING` ç”¨äºå»é‡ã€‚
> Status: Backend Implementedï¼ˆBooks ä¸Šä¼ ã€è½¬æ¢ã€å°é¢æå–ã€å…ƒæ•°æ®æå–ï¼‰ï¼›Shelves = Implementedã€‚

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰
- ç«¯ç‚¹ï¼š`POST /books/upload_init`ã€`POST /books/upload_complete`ã€`GET /books`ã€`GET /books/{id}`ã€`DELETE /books/{id}`ã€‚
- è§„åˆ™ï¼š
  - ä¸Šä¼ å‰æ ¡éªŒé…é¢ï¼›å®Œæˆåè½åº“ä¸ç´¢å¼•åŒæ­¥ï¼›æ”¯æŒ `Idempotency-Key`ã€‚
  - @if (`user_stats.is_readonly`)ï¼š
    - `POST /books/upload_init` â†’ 403 `quota_exceeded`
    - Shelves å…¨é‡ CRUD ç¦æ­¢ï¼ˆ`POST/PUT/PATCH/DELETE` è¿”å› 403ï¼‰

#### B.1 ä¹¦ç±ä¸Šä¼ ä¸å¤„ç†æµæ°´çº¿ï¼ˆUpload & Processing Pipelineï¼‰

**å®Œæ•´æµç¨‹å›¾**ï¼š
```
å‰ç«¯é€‰æ‹©æ–‡ä»¶
    â†“
è®¡ç®— SHA256 æŒ‡çº¹ (content_sha256)
    â†“
POST /books/upload_init { content_sha256, filename, size }
    â†“
PUT ç›´ä¼  MinIO (If distinct)
    â†“
POST /books/upload_complete
    â†“
Server Processing (Calibre, etc.)
    â†“
Server Updates `books` table (PostgreSQL)
    â†“
PowerSync Pushes update to Client `books` table (SQLite)
    â†“
UI Reacts to SQLite change (Book appears in Library)
```

#### B.1.1 SHA256 å…¨å±€å»é‡æœºåˆ¶ï¼ˆADR-008ï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **å­˜å‚¨å»é‡**ï¼šç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½ï¼Œé€šè¿‡å¼•ç”¨è®¡æ•°ç®¡ç†
2. **OCR å¤ç”¨**ï¼šç›¸åŒæ–‡ä»¶åªéœ€ä¸€æ¬¡çœŸå® OCRï¼Œåç»­ç”¨æˆ·ç§’çº§å¤ç”¨
3. **æ™ºèƒ½åˆ é™¤**ï¼šåŒºåˆ†å…¬å…±æ•°æ®å’Œç§äººæ•°æ®ï¼Œå®ç°è½¯åˆ é™¤/ç¡¬åˆ é™¤åˆ†å±‚

**æ•°æ®åº“å­—æ®µ**ï¼š
```sql
-- æ ¸å¿ƒå­—æ®µå®šä¹‰
content_sha256 VARCHAR(64)     -- æ–‡ä»¶å†…å®¹ SHA256 å“ˆå¸Œ
storage_ref_count INTEGER      -- å­˜å‚¨å¼•ç”¨è®¡æ•°ï¼ˆåˆå§‹å€¼ 1ï¼‰
canonical_book_id UUID         -- å»é‡å¼•ç”¨æŒ‡å‘çš„åŸå§‹ä¹¦ç± ID
deleted_at TIMESTAMPTZ         -- è½¯åˆ é™¤æ—¶é—´æˆ³

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_books_content_sha256 ON books(content_sha256) 
    WHERE content_sha256 IS NOT NULL;
```

**å»é‡æ£€æŸ¥æµç¨‹**ï¼š
```
POST /books/upload_init
    â†“
æ£€æŸ¥ content_sha256 æ˜¯å¦å­˜åœ¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ— å‘½ä¸­                       â”‚ æœ‰å‘½ä¸­                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ dedup_available: false      â”‚ æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„ä¹¦             â”‚
â”‚ è¿”å› presigned URL          â”‚ â”œâ”€ æ˜¯ â†’ dedup_hit: "own"          â”‚
â”‚ ç»§ç»­æ­£å¸¸ä¸Šä¼ æµç¨‹              â”‚ â”‚     è¿”å›å·²æœ‰ä¹¦ç± ID             â”‚
â”‚                             â”‚ â””â”€ å¦ â†’ dedup_available: true     â”‚
â”‚                             â”‚         canonical_id: åŸä¹¦ ID     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç§’ä¼ æ¥å£**ï¼š
```
POST /api/v1/books/dedup_reference
â”œâ”€ è¯·æ±‚ä½“ï¼š
â”‚   {
â”‚     "filename": "å°è¯´çš„è‰ºæœ¯.pdf",
â”‚     "content_sha256": "6f4c24abd60a55d3...",
â”‚     "size": 12345678
â”‚   }
â”œâ”€ å¤„ç†é€»è¾‘ï¼š
â”‚   1. æŸ¥æ‰¾ canonical_bookï¼ˆåŸå§‹ä¹¦ç±ï¼‰
â”‚   2. å¢åŠ åŸä¹¦ storage_ref_count
â”‚   3. åˆ›å»ºæ–°ä¹¦ç±è®°å½•ï¼Œè®¾ç½® canonical_book_id
â”‚   4. å¤åˆ¶åŸä¹¦çš„ï¼šminio_key, cover_image_key, meta
â”‚   5. å¦‚æœåŸä¹¦å·² OCRï¼š
â”‚      - è®¾ç½® has_text_layer = true, text_layer_confidence = 0.1
â”‚      - ç”¨æˆ·å¯ç‚¹å‡» OCR è§¦å‘"å‡ OCR"å¤ç”¨
â”œâ”€ å“åº” 201ï¼š
â”‚   {
â”‚     "id": "new-book-uuid",
â”‚     "dedup_type": "global",
â”‚     "canonical_book_id": "original-book-uuid",
â”‚     "has_ocr": true
â”‚   }
â””â”€ å“åº” 404ï¼šCANONICAL_NOT_FOUND (åŸä¹¦ä¸å­˜åœ¨)
```

**å¼•ç”¨è®¡æ•°è§„åˆ™**ï¼š
| æ“ä½œ | storage_ref_count å˜åŒ– |
|-----|----------------------|
| åŸä¹¦ä¸Šä¼ å®Œæˆ | åˆå§‹å€¼ = 1ï¼ˆä»£è¡¨è‡ªå·±ï¼‰ |
| ç§’ä¼ åˆ›å»ºå¼•ç”¨ä¹¦ | åŸä¹¦ +1 |
| å¼•ç”¨ä¹¦åˆ é™¤ | åŸä¹¦ -1 |
| åˆ¤æ–­æ˜¯å¦æœ‰å¼•ç”¨ | `> 1` è¡¨ç¤ºæœ‰å…¶ä»–ç”¨æˆ·å…±äº« |

#### B.1.2 ä¹¦ç±åˆ é™¤ç­–ç•¥ï¼ˆSoft Delete & Hard Deleteï¼‰

**åˆ é™¤å†³ç­–æµç¨‹**ï¼š
```
ç”¨æˆ·åˆ é™¤ä¹¦ç±
    â†“
åˆ¤æ–­ä¹¦ç±ç±»å‹
    â”œâ”€ å¼•ç”¨ä¹¦ (canonical_book_id IS NOT NULL)
    â”‚   â”œâ”€ åˆ é™¤ç”¨æˆ·ç§æœ‰æ•°æ®ï¼ˆç¬”è®°/è¿›åº¦/ä¹¦æ¶ï¼‰
    â”‚   â”œâ”€ ç‰©ç†åˆ é™¤ä¹¦ç±è®°å½•
    â”‚   â”œâ”€ å‡å°‘åŸä¹¦ storage_ref_count
    â”‚   â””â”€ æ£€æŸ¥åŸä¹¦æ˜¯å¦éœ€è¦æ¸…ç†
    â”‚       â””â”€ å¦‚æœåŸä¹¦å·²è½¯åˆ é™¤ + ref_count â‰¤ 1 â†’ ç‰©ç†åˆ é™¤åŸä¹¦
    â”‚
    â””â”€ åŸä¹¦ (canonical_book_id IS NULL)
        â”œâ”€ åˆ é™¤ç”¨æˆ·ç§æœ‰æ•°æ®
        â””â”€ æ£€æŸ¥å¼•ç”¨è®¡æ•°
            â”œâ”€ ref_count > 1 â†’ è½¯åˆ é™¤
            â”‚   â””â”€ è®¾ç½® deleted_atï¼Œä¿ç•™å…¬å…±æ•°æ®
            â””â”€ ref_count â‰¤ 1 â†’ ç¡¬åˆ é™¤
                â”œâ”€ åˆ é™¤ MinIO æ–‡ä»¶ï¼ˆPDF/å°é¢/åŒå±‚ PDFï¼‰
                â”œâ”€ åˆ é™¤å‘é‡ç´¢å¼•
                â””â”€ ç‰©ç†åˆ é™¤æ•°æ®åº“è®°å½•
```

**å…¬å…±æ•°æ® vs ç§äººæ•°æ®**ï¼š
| æ•°æ®ç±»å‹ | æ‰€æœ‰è€… | è½¯åˆ é™¤æ—¶ | ç¡¬åˆ é™¤æ—¶ |
|---------|-------|---------|---------|
| MinIO/EPUB æ–‡ä»¶ | å…±äº« | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| å°é¢å›¾ç‰‡ | å…±äº« | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| OCR åŒå±‚ PDF | å…±äº« | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| å‘é‡ç´¢å¼• | å…±äº« | âœ… ä¿ç•™ | âŒ åˆ é™¤ |
| ç¬”è®°/é«˜äº® | ç”¨æˆ·ç§æœ‰ | âŒ ç«‹å³åˆ é™¤ | âŒ ç«‹å³åˆ é™¤ |
| é˜…è¯»è¿›åº¦ | ç”¨æˆ·ç§æœ‰ | âŒ ç«‹å³åˆ é™¤ | âŒ ç«‹å³åˆ é™¤ |
| ä¹¦æ¶å…³è” | ç”¨æˆ·ç§æœ‰ | âŒ ç«‹å³åˆ é™¤ | âŒ ç«‹å³åˆ é™¤ |

#### B.1.3 æœ€è¿‘åˆ é™¤åŠŸèƒ½ï¼ˆRecently Deletedï¼‰

**åŠŸèƒ½æ¦‚è¿°**ï¼š
- ç”¨æˆ·åˆ é™¤ä¹¦ç±åï¼Œä¹¦ç±è¿›å…¥"æœ€è¿‘åˆ é™¤"çŠ¶æ€ï¼ˆè½¯åˆ é™¤ï¼‰
- ä¹¦ç±ä¿ç•™ 30 å¤©ï¼ŒæœŸé—´å¯æ¢å¤
- è¶…è¿‡ 30 å¤©åç”±åå°ä»»åŠ¡è‡ªåŠ¨æ¸…ç†

**é¡µé¢å…¥å£**ï¼šä¾§è¾¹æ  â†’ æœ€è¿‘åˆ é™¤

**é¡µé¢åŠŸèƒ½**ï¼š
| åŠŸèƒ½ | æ“ä½œ | ä¸šåŠ¡é€»è¾‘ |
|-----|------|---------|
| æŸ¥çœ‹å·²åˆ é™¤ä¹¦ç± | æ˜¾ç¤ºåˆ—è¡¨ | æŸ¥è¯¢ `deleted_at IS NOT NULL` |
| æ¢å¤ä¹¦ç± | å•é€‰/æ‰¹é‡ | è®¾ç½® `deleted_at = NULL` |
| æ°¸ä¹…åˆ é™¤ | å•é€‰/æ‰¹é‡ | è§ä¸‹æ–¹è¯¦ç»†é€»è¾‘ |
| æ¸…ç©ºå…¨éƒ¨ | æ‰¹é‡ | å¯¹æ‰€æœ‰ä¹¦ç±æ‰§è¡Œæ°¸ä¹…åˆ é™¤ |

**âš ï¸ æ°¸ä¹…åˆ é™¤ä¸šåŠ¡é€»è¾‘ï¼ˆä»…åˆ é™¤ç§äººæ•°æ®ï¼‰**ï¼š

> **é‡è¦å†³ç­–**ï¼šæ°¸ä¹…åˆ é™¤**ä¸ä¼š**åˆ é™¤å…±äº«èµ„æºï¼ˆMinIO æ–‡ä»¶ã€OCR ç»“æœã€å‘é‡ç´¢å¼•ï¼‰ï¼Œ  
> å› ä¸ºå…¶ä»–ç”¨æˆ·å¯èƒ½é€šè¿‡ç§’ä¼ å¼•ç”¨äº†ç›¸åŒæ–‡ä»¶ã€‚åªåˆ é™¤å½“å‰ç”¨æˆ·çš„ç§äººæ•°æ®ã€‚

```
ç”¨æˆ·ç‚¹å‡»"æ°¸ä¹…åˆ é™¤"
    â†“
1. åˆ é™¤ç§äººæ•°æ®ï¼ˆç«‹å³æ‰§è¡Œï¼‰
    â”œâ”€ notes: DELETE WHERE book_id = :id AND user_id = :uid
    â”œâ”€ highlights: DELETE WHERE book_id = :id AND user_id = :uid
    â”œâ”€ bookmarks: DELETE WHERE book_id = :id AND user_id = :uid
    â”œâ”€ book_position: DELETE WHERE book_id = :id AND user_id = :uid
    â”œâ”€ reading_time_log: DELETE WHERE book_id = :id AND user_id = :uid
    â””â”€ shelf_books: DELETE WHERE book_id = :id AND user_id = :uid
    â†“
2. æ›´æ–°ä¹¦ç±è®°å½•
    â””â”€ books: ç‰©ç†åˆ é™¤è®°å½• (DELETE WHERE id = :id)
    â†“
3. æ›´æ–°å¼•ç”¨è®¡æ•°ï¼ˆå¦‚æœæ˜¯å¼•ç”¨ä¹¦ï¼‰
    â””â”€ åŸä¹¦ storage_ref_count -= 1
    â†“
4. ä¸æ‰§è¡Œçš„æ“ä½œï¼ˆå…±äº«èµ„æºä¿æŠ¤ï¼‰
    â”œâ”€ âŒ ä¸åˆ é™¤ MinIO æ–‡ä»¶ (minio_key)
    â”œâ”€ âŒ ä¸åˆ é™¤å°é¢ (cover_image_key)
    â”œâ”€ âŒ ä¸åˆ é™¤ OCR åŒå±‚ PDF (ocr_pdf_key)
    â””â”€ âŒ ä¸åˆ é™¤å‘é‡ç´¢å¼• (PostgreSQL pgvector)
```

**å…±äº«èµ„æºæ¸…ç†è§„åˆ™**ï¼ˆç”±åå°å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼‰ï¼š
```sql
-- æ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼Œæ¸…ç†å­¤ç«‹çš„å…±äº«èµ„æº
DELETE FROM books_storage_cleanup_queue
WHERE content_sha256 IN (
    SELECT content_sha256 
    FROM books 
    WHERE deleted_at < NOW() - INTERVAL '30 days'
    GROUP BY content_sha256
    HAVING COUNT(*) = SUM(CASE WHEN deleted_at IS NOT NULL THEN 1 ELSE 0 END)
);
-- å³ï¼šåªæœ‰å½“è¯¥ SHA256 çš„æ‰€æœ‰ä¹¦ç±éƒ½å·²è½¯åˆ é™¤è¶…è¿‡30å¤©ï¼Œæ‰æ¸…ç†å­˜å‚¨
```

**API ç«¯ç‚¹**ï¼š
| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/api/v1/books/deleted` | GET | è·å–å·²åˆ é™¤ä¹¦ç±åˆ—è¡¨ |
| `/api/v1/books/{id}/restore` | POST | æ¢å¤å•æœ¬ä¹¦ç± |
| `/api/v1/books/restore` | POST | æ‰¹é‡æ¢å¤ `{ids: []}` |
| `/api/v1/books/{id}/permanent` | DELETE | æ°¸ä¹…åˆ é™¤å•æœ¬ |
| `/api/v1/books/permanent` | DELETE | æ‰¹é‡æ°¸ä¹…åˆ é™¤ `{ids: []}` |

**å‰ç«¯å®ç°è¦ç‚¹**ï¼š
1. é€šè¿‡ PowerSync æŸ¥è¯¢ `SELECT * FROM books WHERE deleted_at IS NOT NULL`
2. æ¢å¤æ“ä½œï¼šPowerSync UPDATE `deleted_at = NULL`
3. æ°¸ä¹…åˆ é™¤ï¼š**å¿…é¡»è°ƒç”¨ REST API**ï¼ˆé PowerSyncï¼‰ï¼Œå› ä¸ºéœ€è¦å¤„ç†ç§äººæ•°æ®å’Œå¼•ç”¨è®¡æ•°

#### B.2 OCR ä¸å‘é‡ç´¢å¼•è§¦å‘æœºåˆ¶ï¼ˆâš ï¸ é‡è¦æ¶æ„å†³ç­–ï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **å‘é‡ç´¢å¼•æ˜¯å…è´¹æœåŠ¡**ï¼Œå¯¹æ‰€æœ‰ä¹¦ç±è‡ªåŠ¨æ‰§è¡Œ
2. **OCR æ˜¯æ”¶è´¹/é™é¢æœåŠ¡**ï¼Œç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘
3. å›¾ç‰‡å‹ PDF æœªç» OCR å‰ï¼Œæ— æ³•ç”Ÿæˆå‘é‡ç´¢å¼•
4. **OCR ç»“æœå¯å¤ç”¨**ï¼šç›¸åŒæ–‡ä»¶åªéœ€ä¸€æ¬¡çœŸå® OCRï¼ˆADR-008ï¼‰

**ä¹¦ç±ç±»å‹åˆ¤æ–­**ï¼š
| ç±»å‹ | åˆ¤æ–­æ¡ä»¶ | åç»­å¤„ç† |
|-----|---------|---------|
| æ–‡å­—å‹ EPUB | `original_format = 'epub'` | ç›´æ¥å‘é‡ç´¢å¼• |
| æ–‡å­—å‹ PDF | åˆæ£€æœ‰æ–‡å­—å±‚ (`has_text_layer = true, text_layer_confidence >= 0.8`) | ç›´æ¥å‘é‡ç´¢å¼• |
| å›¾ç‰‡å‹ PDF | åˆæ£€æ— æ–‡å­—å±‚ (`has_text_layer = true, text_layer_confidence < 0.8`) | ç­‰å¾…ç”¨æˆ·è§¦å‘ OCR |
| è½¬æ¢å EPUB | MOBI/AZW3/FB2 è½¬æ¢è€Œæ¥ | ç›´æ¥å‘é‡ç´¢å¼• |
| ç§’ä¼ å¼•ç”¨ä¹¦ | `canonical_book_id IS NOT NULL` | ç»§æ‰¿åŸä¹¦çŠ¶æ€ï¼Œå¯è§¦å‘å‡ OCR |

**is_image_based åˆ¤æ–­é€»è¾‘**ï¼ˆå‰ç«¯ç”¨äºæ˜¾ç¤º OCR æŒ‰é’®ï¼‰ï¼š
```python
# éœ€è¦æ˜¾ç¤º OCR æŒ‰é’®çš„æ¡ä»¶
is_image_based = (
    (has_text_layer == True AND text_layer_confidence < 0.8)  # å›¾ç‰‡å‹ PDF
    OR ocr_status == 'completed'  # å·²å®Œæˆ OCR çš„ä¹¦ç±ï¼ˆå¯èƒ½éœ€è¦é‡åšï¼‰
)
```

**å›¾ç‰‡å‹ PDF å¤„ç†æµç¨‹**ï¼š
```
åˆæ£€å‘ç°å›¾ç‰‡å‹ PDF (has_text_layer = true, text_layer_confidence < 0.8)
    â†“
PowerSync Service æ¨é€ `ocr_detection` äº‹ä»¶åˆ°å®¢æˆ·ç«¯
    â†“
å‰ç«¯å¼¹å‡ºæç¤ºå¯¹è¯æ¡†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– ä¹¦ç±åˆæ£€å®Œæˆ                                              â”‚
â”‚                                                              â”‚
â”‚  æ‚¨ä¸Šä¼ çš„ã€Šç»æµå­¦åŸç†ã€‹ç»è¿‡é›…å…¸å¨œåˆæ­¥æ£€æŸ¥ï¼Œæ­¤ä¹¦ä¸ºå›¾ç‰‡å½¢å¼çš„      â”‚
â”‚  PDF ç”µå­ä¹¦ã€‚ä¸ºäº†è·å¾—æ›´å¥½çš„é˜…è¯»ã€ç¬”è®°ä»¥åŠ AI æé—®ä½“éªŒï¼Œ        â”‚
â”‚  æˆ‘ä»¬å»ºè®®æ‚¨å¯¹æ­¤ä¹¦è¿›è¡Œå›¾ç‰‡è½¬æ–‡æœ¬ï¼ˆOCRï¼‰æœåŠ¡ã€‚                   â”‚
â”‚                                                              â”‚
â”‚  [ç¨åå†å¤„ç†]                            [ğŸš€ é©¬ä¸Šè½¬æ¢]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»"é©¬ä¸Šè½¬æ¢"   â”‚ ç”¨æˆ·ç‚¹å‡»"ç¨åå†å¤„ç†"                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /books/{id}/ocrâ”‚ å…³é—­å¯¹è¯æ¡†                             â”‚
â”‚       â†“             â”‚       â†“                               â”‚
â”‚ æ£€æŸ¥ç”¨æˆ· OCR é…é¢    â”‚ ä¹¦ç±å¡ç‰‡ â‹® èœå•æ˜¾ç¤º "OCR æœåŠ¡" é€‰é¡¹    â”‚
â”‚       â†“             â”‚       â†“                               â”‚
â”‚ ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—         â”‚ ç”¨æˆ·éšæ—¶å¯ä»èœå•è§¦å‘ OCR               â”‚
â”‚       â†“             â”‚                                       â”‚
â”‚ å‰ç«¯æç¤ºï¼š           â”‚                                       â”‚
â”‚ "OCR å·²è¿›å…¥æ’é˜Ÿï¼Œ    â”‚                                       â”‚
â”‚  é¢„è®¡ XX åˆ†é’Ÿå®Œæˆï¼Œ  â”‚                                       â”‚
â”‚  ç°åœ¨å¯ç»§ç»­é˜…è¯»ï¼Œ    â”‚                                       â”‚
â”‚  ä½†æš‚æ— æ³•åšç¬”è®°å’Œ    â”‚                                       â”‚
â”‚  ä½¿ç”¨ AI æœåŠ¡"      â”‚                                       â”‚
â”‚       â†“             â”‚                                       â”‚
â”‚ OCR å®Œæˆåè‡ªåŠ¨è§¦å‘   â”‚                                       â”‚
â”‚ å‘é‡ç´¢å¼•             â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API ç«¯ç‚¹**ï¼š
```
POST /api/v1/books/{book_id}/ocr
â”œâ”€ æƒé™ï¼šç”¨æˆ·å·²ç™»å½•
â”œâ”€ å‰ç½®æ£€æŸ¥ï¼š
â”‚   â”œâ”€ ä¹¦ç±å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
â”‚   â”œâ”€ ä¹¦ç±æ˜¯å›¾ç‰‡å‹ (has_text_layer = true AND text_layer_confidence < 0.8)
â”‚   â”‚   æˆ– has_text_layer = false (æœªæ£€æµ‹)
â”‚   â””â”€ ç”¨æˆ· OCR é…é¢å……è¶³ (é˜¶æ¢¯è®¡è´¹è§„åˆ™)
â”œâ”€ OCR å¤ç”¨æ£€æŸ¥ï¼š
â”‚   SELECT id, ocr_pdf_key FROM books 
â”‚   WHERE content_sha256 = :sha256 
â”‚   AND ocr_status = 'completed' LIMIT 1
â”‚   â”œâ”€ æ‰¾åˆ° â†’ å‡ OCRï¼Œå¤åˆ¶åŒå±‚ PDF Keyï¼Œç§’çº§å®Œæˆ
â”‚   â””â”€ æœªæ‰¾åˆ° â†’ çœŸå® OCR (OCRmyPDF + PaddleOCR)ï¼Œæäº¤ Celery ä»»åŠ¡
â”œâ”€ å“åº” 200 (å‡ OCR)ï¼š
â”‚   {
â”‚     "status": "instant_completed",
â”‚     "ocr_pdf_key": "books/{user_id}/{book_id}/ocr.pdf",
â”‚     "message": "å·²å¤ç”¨ç›¸åŒä¹¦ç±çš„åŒå±‚ PDF"
â”‚   }
â”œâ”€ å“åº” 200 (çœŸå® OCR)ï¼š
â”‚   {
â”‚     "status": "queued",
â”‚     "queue_position": 3,
â”‚     "estimated_minutes": 15
â”‚   }
â”œâ”€ å“åº” 403ï¼šquota_exceeded (OCR é…é¢ä¸è¶³)
â”œâ”€ å“åº” 400ï¼šalready_digitalized (confidence >= 0.8ï¼Œå·²æ˜¯æ–‡å­—å‹)
â””â”€ å“åº” 400ï¼šocr_max_pages_exceeded (è¶…è¿‡ 2000 é¡µ)
```

**OCR å¤ç”¨æœºåˆ¶ï¼ˆå‡ OCRï¼‰**ï¼š
> **å•†ä¸šé€»è¾‘ï¼ˆâš ï¸ é‡è¦ï¼‰**ï¼š
> - ç”¨æˆ·**å¿…é¡»**ç‚¹å‡» OCR æŒ‰é’®æ‰èƒ½çœ‹åˆ° OCR ç»“æœï¼ˆå•†ä¸šé—­ç¯ï¼‰
> - å³ä½¿æ˜¯å¤ç”¨ï¼Œä¹Ÿ**å¿…é¡»**æ‰£é™¤é…é¢ï¼ˆç»´æŠ¤å•†ä¸šå…¬å¹³æ€§ï¼‰
> - ä½†ä¸æ¶ˆè€— GPU ç®—åŠ›ï¼ˆé™ä½è¿è¥æˆæœ¬ï¼‰

```
ç”¨æˆ·ç‚¹å‡» OCR æŒ‰é’®
    â†“
æ­£å¸¸é…é¢æ£€æŸ¥å’Œæ‰£è´¹
    â†“
æ£€æŸ¥æ˜¯å¦å¯å¤ç”¨ï¼ˆç›¸åŒ SHA256 å·²æœ‰åŒå±‚ PDFï¼‰
    â”œâ”€ å¯å¤ç”¨ â†’ å¤åˆ¶åŒå±‚ PDF åˆ°ç”¨æˆ·ç›®å½•ï¼Œè¿”å› instant_completed
    â””â”€ ä¸å¯å¤ç”¨ â†’ æäº¤ Celery OCR ä»»åŠ¡ï¼ˆOCRmyPDF + PaddleOCRï¼‰ï¼Œè¿”å› queued
```

> **åŒå±‚ PDF (Dual-Layer PDF) æŠ€æœ¯è¯´æ˜**ï¼š
> - **å®šä¹‰**ï¼šåŒå±‚ PDF åŒ…å«å¯è§å›¾åƒå±‚å’Œä¸å¯è§æ–‡å­—å±‚ï¼Œå‰ç«¯å¯ç›´æ¥ä½¿ç”¨ PDF.js è·å–æ–‡å­—å†…å®¹
> - **ä¼˜åŠ¿**ï¼šæ— éœ€ç»´æŠ¤ç‹¬ç«‹ JSON Sidecarï¼Œæ–‡å­—ä¸åæ ‡å¤©ç„¶å…³è”ï¼Œé˜…è¯»å™¨æ¸²æŸ“æ›´ç®€æ´
> - **ç”Ÿæˆ**ï¼šOCRmyPDF (CLI) è°ƒç”¨ PaddleOCR (è¯†åˆ«å¼•æ“)ï¼Œè¾“å‡ºè‡ªå¸¦æ–‡å­—å±‚çš„ PDF
> - **å‰ç«¯è¯»å–**ï¼šPDF.js `page.getTextContent()` ç›´æ¥æå–æ–‡å­—ï¼Œæ— éœ€é¢å¤–è¯·æ±‚
> - **å¤ç”¨**ï¼šåŒå±‚ PDF æœ¬èº«å¯å¤åˆ¶åˆ°æ–°ç”¨æˆ·ç›®å½•ï¼Œæ— éšç§é—®é¢˜ï¼ˆçº¯ PDFï¼Œæ— é¢å¤–å…ƒæ•°æ®ï¼‰

```sql
-- OCR çŠ¶æ€å­—æ®µ
ocr_status VARCHAR(20) DEFAULT NULL;
-- å¯é€‰å€¼: NULL (æœªæ£€æµ‹/æ–‡å­—å‹), 'pending' (å¾…å¤„ç†), 'processing' (å¤„ç†ä¸­), 'completed' (å·²å®Œæˆ), 'failed' (å¤±è´¥)

ocr_requested_at TIMESTAMPTZ;
ocr_pdf_key TEXT;  -- OCR äº§å‡ºçš„åŒå±‚ PDF (Dual-Layer PDF) MinIO Key
vector_indexed_at TIMESTAMPTZ;

-- SHA256 å»é‡ç›¸å…³å­—æ®µï¼ˆADR-008ï¼‰
content_sha256 VARCHAR(64);
storage_ref_count INTEGER DEFAULT 1;  -- âš ï¸ æ›´æ–°æ­¤å­—æ®µå¿…é¡»ä½¿ç”¨è¡Œçº§é” (SELECT FOR UPDATE)
canonical_book_id UUID REFERENCES books(id);
deleted_at TIMESTAMPTZ;

-- ç´¢å¼•
CREATE INDEX idx_books_content_sha256 ON books(content_sha256) WHERE content_sha256 IS NOT NULL;
CREATE INDEX idx_books_canonical_book_id ON books(canonical_book_id) WHERE canonical_book_id IS NOT NULL;
```

**ä»»åŠ¡é“¾è§¦å‘è§„åˆ™**ï¼š
| è§¦å‘æ¡ä»¶ | æ‰§è¡Œä»»åŠ¡ |
|---------|---------|
| æ–‡å­—å‹ä¹¦ç±ä¸Šä¼ å®Œæˆ | `tasks.index_book_vectors` |
| OCR ä»»åŠ¡å®Œæˆ | `tasks.index_book_vectors` (é“¾å¼è°ƒç”¨) |
| ç”¨æˆ·æ‰‹åŠ¨é‡å»ºç´¢å¼• | `tasks.reindex_book_vectors` (ç®¡ç†å‘˜åŠŸèƒ½) |

#### B.3 å…ƒæ•°æ®ç¡®è®¤æœºåˆ¶ï¼ˆMetadata Confirmationï¼‰

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **æ‰€æœ‰ä¹¦ç±ä¸Šä¼ åéƒ½éœ€è¦ç”¨æˆ·ç¡®è®¤å…ƒæ•°æ®**
2. å…ƒæ•°æ®ï¼ˆä¹¦åã€ä½œè€…ï¼‰ä¼šå½±å“ AI å¯¹è¯çš„å‡†ç¡®æ€§
3. ç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸å¡«å†™ï¼ˆç§äººèµ„æ–™åœºæ™¯ï¼‰ï¼Œä½†éœ€æ˜ç¡®å‘ŠçŸ¥å½±å“

**è§¦å‘æ—¶æœº**ï¼š
- åå°ä»»åŠ¡ `extract_book_metadata` å®Œæˆå
- æ— è®ºæ˜¯å¦æˆåŠŸæå–åˆ°å…ƒæ•°æ®ï¼Œéƒ½é€šçŸ¥å‰ç«¯å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†

**å‰ç«¯äº¤äº’æµç¨‹**ï¼š
```
å…ƒæ•°æ®æå–ä»»åŠ¡å®Œæˆ
    â†“
PowerSync Service æ¨é€ `metadata_extracted` äº‹ä»¶
    â†“
å‰ç«¯å¼¹å‡ºå…ƒæ•°æ®ç¡®è®¤å¯¹è¯æ¡†ï¼ˆæ ¹æ®æå–ç»“æœæ˜¾ç¤ºä¸åŒå†…å®¹ï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“š è¯·ç¡®è®¤ä¹¦ç±ä¿¡æ¯                                               â”‚
â”‚                                                                 â”‚
â”‚  [æƒ…å†µ A: æˆåŠŸæå–åˆ°å…ƒæ•°æ®]                                       â”‚
â”‚  é›…å…¸å¨œå·²ä»æ‚¨ä¸Šä¼ çš„æ–‡ä»¶ä¸­æå–åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼Œè¯·ç¡®è®¤æ˜¯å¦æ­£ç¡®ï¼š           â”‚
â”‚                                                                 â”‚
â”‚  ä¹¦ç±åç§°: [ç»æµå­¦åŸç†________________] â† å¯ç¼–è¾‘                  â”‚
â”‚  ä½œè€…:     [æ›¼æ˜†____________________] â† å¯ç¼–è¾‘                   â”‚
â”‚                                                                 â”‚
â”‚  [æƒ…å†µ B: æœªæå–åˆ°å…ƒæ•°æ®]                                         â”‚
â”‚  é›…å…¸å¨œæœªèƒ½ä»æ‚¨ä¸Šä¼ çš„æ–‡ä»¶ä¸­æå–åˆ°ä¹¦ç±ä¿¡æ¯ã€‚                        â”‚
â”‚  ä¸ºäº†è·å¾—æ›´å¥½çš„ AI å¯¹è¯ä½“éªŒï¼Œå»ºè®®æ‚¨å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š                   â”‚
â”‚                                                                 â”‚
â”‚  ä¹¦ç±åç§°: [________________________] â† ç©ºï¼Œå»ºè®®å¡«å†™              â”‚
â”‚  ä½œè€…:     [________________________] â† ç©ºï¼Œå¯é€‰                  â”‚
â”‚                                                                 â”‚
â”‚  â„¹ï¸ æç¤ºï¼šä¹¦ç±åç§°å’Œä½œè€…ä¿¡æ¯å°†å¸®åŠ© AI æä¾›æ›´ç²¾å‡†çš„å›ç­”ã€‚           â”‚
â”‚      å¦‚æœè¿™æ˜¯ç§äººèµ„æ–™è€Œéä¹¦ç±ï¼Œå¯è·³è¿‡æ­¤æ­¥éª¤ã€‚                       â”‚
â”‚                                                                 â”‚
â”‚  [è·³è¿‡]                                          [âœ“ ç¡®è®¤]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API ç«¯ç‚¹**ï¼š
```
PATCH /api/v1/books/{book_id}/metadata
â”œâ”€ æƒé™ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œä¹¦ç±å±äºå½“å‰ç”¨æˆ·
â”œâ”€ è¯·æ±‚ä½“ï¼š
â”‚   {
â”‚     "title": "ç»æµå­¦åŸç†",       // å¯é€‰
â”‚     "author": "æ›¼æ˜†",            // å¯é€‰
â”‚     "confirmed": true            // æ ‡è®°ç”¨æˆ·å·²ç¡®è®¤
â”‚   }
â”œâ”€ å“åº” 200ï¼š
â”‚   {
â”‚     "id": "uuid",
â”‚     "title": "ç»æµå­¦åŸç†",
â”‚     "author": "æ›¼æ˜†",
â”‚     "metadata_confirmed": true,
â”‚     "metadata_version": "sha256:abc123"
â”‚   }
â””â”€ æ”¯æŒ If-Match ä¹è§‚é”
```

**æ•°æ®åº“æ¨¡å‹æ›´æ–°**ï¼š
```sql
metadata_confirmed BOOLEAN DEFAULT FALSE; -- books è¡¨å­—æ®µ
metadata_confirmed_at TIMESTAMPTZ;        -- books è¡¨å­—æ®µ
```

**ä¹¦ç±å¡ç‰‡èœå•é€»è¾‘**ï¼š
```typescript
// BookCard ç»„ä»¶çš„ â‹® ä¸‹æ‹‰èœå•
const menuItems = [
  { label: 'æŸ¥çœ‹è¯¦æƒ…', action: 'view' },
  { label: 'æ·»åŠ åˆ°ä¹¦æ¶', action: 'shelf' },
  // ç¼–è¾‘å…ƒæ•°æ®é€‰é¡¹ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
  {
    label: 'âœï¸ ç¼–è¾‘ä¹¦ç±ä¿¡æ¯',
    action: 'edit_metadata',
    description: 'ä¿®æ”¹ä¹¦ç±åç§°å’Œä½œè€…'
  },
  // ä»…å½“ has_text_layer = false ä¸” ocr_status != 'processing' æ—¶æ˜¾ç¤º
  book.has_text_layer === false && book.ocr_status !== 'processing' && {
    label: 'ğŸ”¤ OCR æœåŠ¡',
    action: 'ocr',
    description: 'å°†å›¾ç‰‡è½¬æ¢ä¸ºå¯é€‰æ‹©æ–‡æœ¬'
  },
  // ä»…å½“ ocr_status = 'processing' æ—¶æ˜¾ç¤º
  book.ocr_status === 'processing' && {
    label: 'â³ OCR å¤„ç†ä¸­...',
    disabled: true
  },
  { label: 'åˆ é™¤', action: 'delete', danger: true },
].filter(Boolean);
```

**ä¸ AI å¯¹è¯çš„å…³ç³»**ï¼š
> âš ï¸ **é‡è¦**ï¼šä¹¦ç±çš„ `title` å’Œ `author` å­—æ®µä¼šä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™ä¸Šæ¸¸ AI æ¨¡å‹ã€‚
> 
> åœ¨ AI å¯¹è¯çš„ç³»ç»Ÿæç¤ºè¯ä¸­ï¼Œæˆ‘ä»¬ä¼šåŒ…å«ï¼š
> ```
> ç”¨æˆ·æ­£åœ¨é˜…è¯»çš„ä¹¦ç±ï¼šã€Š{book.title}ã€‹ï¼Œä½œè€…ï¼š{book.author}
> ```
> 
> è¿™æœ‰åŠ©äº AI æ¨¡å‹ï¼š
> 1. ç†è§£ç”¨æˆ·é—®é¢˜çš„èƒŒæ™¯ä¸Šä¸‹æ–‡
> 2. æä¾›ä¸ä¹¦ç±å†…å®¹ç›¸å…³çš„ç²¾å‡†å›ç­”
> 3. é¿å…æ··æ·†åŒåä½†ä¸åŒç‰ˆæœ¬çš„ä¹¦ç±
>
> å¦‚æœç”¨æˆ·ä¸Šä¼ çš„æ˜¯ç§äººèµ„æ–™ï¼ˆéä¹¦ç±ï¼‰ï¼Œå¯ä»¥è·³è¿‡å…ƒæ•°æ®ç¡®è®¤ï¼Œæ­¤æ—¶ AI å¯¹è¯å°†ä»…åŸºäºæ–‡æ¡£å†…å®¹æœ¬èº«ã€‚

**å…ƒæ•°æ®æå–è§„åˆ™**ï¼š
- æ ‡é¢˜æ›´æ–°åˆ¤æ–­æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€åˆ™è¦†ç›–ï¼‰ï¼š
  1. å½“å‰æ ‡é¢˜ä¸ºç©º
  2. å½“å‰æ ‡é¢˜åŒ…å«ä¸‹åˆ’çº¿ (`_`)
  3. å½“å‰æ ‡é¢˜ä»¥æ‰©å±•åç»“å°¾ (`.epub`, `.pdf`, `.mobi`, `.azw3`)
  4. å½“å‰æ ‡é¢˜ä¸º `ä¹¦å-ä½œè€…å` æ ¼å¼ï¼Œè€Œæå–çš„æ ‡é¢˜æ›´çŸ­ä¸”ä¸å«è¿å­—ç¬¦
- ä½œè€…ä»…åœ¨å½“å‰ä¸ºç©ºæ—¶æ›´æ–°

**å­˜å‚¨ç­–ç•¥**ï¼š
- æœ€ç»ˆ MinIO ä¸­åªä¿ç•™ EPUB å’Œ PDF æ ¼å¼
- é EPUB/PDF åœ¨ Calibre è½¬æ¢æˆåŠŸåè‡ªåŠ¨åˆ é™¤åŸå§‹æ–‡ä»¶
- `minio_key` å§‹ç»ˆæŒ‡å‘å¯é˜…è¯»æ–‡ä»¶

**æ”¯æŒæ ¼å¼**ï¼š
| æ ¼å¼ | å¤„ç†æ–¹å¼ |
|:---|:---|
| EPUB | ç›´æ¥å­˜å‚¨ï¼Œæå–å°é¢å’Œå…ƒæ•°æ® |
| PDF | ç›´æ¥å­˜å‚¨ï¼Œæå–å°é¢å’Œå…ƒæ•°æ® |
| MOBI | Calibre è½¬æ¢ä¸º EPUBï¼Œåˆ é™¤åŸå§‹æ–‡ä»¶ |
| AZW3 | Calibre è½¬æ¢ä¸º EPUBï¼Œåˆ é™¤åŸå§‹æ–‡ä»¶ |
| FB2 | Calibre è½¬æ¢ä¸º EPUBï¼Œåˆ é™¤åŸå§‹æ–‡ä»¶ |

#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`UploadManager`
  - Propsï¼š
    ```ts
    interface UploadManagerProps {
      onUploaded?: (book: { id: string; downloadUrl: string }) => void
      onError?: (code: 'quota_exceeded' | 'init_failed' | 'put_failed' | 'complete_failed' | 'unknown') => void
    }
    ```
  - äº¤äº’ï¼šé€‰æ‹©æ–‡ä»¶â†’è®¡ç®—æŒ‡çº¹â†’åˆå§‹åŒ–â†’PUT ä¸Šä¼ â†’å®Œæˆâ†’å›è°ƒï¼›403 è¶…é™æ˜ å°„åˆ°æ–‡æ¡ˆé”®ã€‚
  - çŠ¶æ€ï¼š`idle | hashing | initializing | uploading | completing | done | error`
- ç»„ä»¶ï¼š`ShelfList` / `ShelfEditor`ï¼ˆå·²å®ç°ï¼‰ã€‚

### âœ” Definition of Done (DoD)
- [x] API å¥‘çº¦è¦†ç›–ä¸Šä¼  init/complete ä¸ Shelves CRUD
- [x] ä¸Šä¼ å¹‚ç­‰ä¸åˆ†ç‰‡é‡è¯•ç”¨ä¾‹é€šè¿‡
- [x] Calibre è½¬æ¢æµæ°´çº¿å®ç°ä¸æµ‹è¯•
- [x] å°é¢æå–ä¸ WebP ä¼˜åŒ–å®ç°
- [x] å…ƒæ•°æ®æ™ºèƒ½æå–ä¸æ ‡é¢˜æ›´æ–°é€»è¾‘
- [x] RLS ç­–ç•¥ä¸åªè¯»é”æ‹¦æˆªæµ‹è¯•é€šè¿‡
- [x] å‰ç«¯ä¸Šä¼ ç»„ä»¶ä¸çŠ¶æ€ç®¡ç†å¯¹é½
- [x] **SHA256 å…¨å±€å»é‡æœºåˆ¶å®ç°ä¸æµ‹è¯•ï¼ˆADR-008ï¼‰**
- [x] **ç§’ä¼ æ¥å£ dedup_reference å®ç°**
- [x] **OCR å¤ç”¨ï¼ˆå‡ OCRï¼‰æœºåˆ¶å®ç°**
- [x] **è½¯åˆ é™¤/ç¡¬åˆ é™¤åˆ†å±‚ç­–ç•¥å®ç°**
- [x] **å¼•ç”¨è®¡æ•°ä¸åˆ é™¤è”åŠ¨æµ‹è¯•é€šè¿‡**
- [ ] Shelves æ ‘å½¢ç»“æ„å‰ç«¯å®Œå–„ï¼ˆå¾…å®ç°ï¼‰

---

### 2.3 Reader Core

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰
- **Core Principle**: **App-First & Local-First**. 
- **Server Database**: `book_position` (PostgreSQL) - Source of Truth for "Last Read Position" across devices.
- **Local Database**: `book_position` (SQLite) - The only DB the UI interacts with directly.
- **Sync**: PowerSync syncs `book_position` (Server) <--> `book_position` (Local). é˜…è¯»æ—¶é•¿é€šè¿‡ `reading_time_log` è¡¨å•ç‹¬è®°å½•ã€‚

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰
- **Sync Architecture (PowerSync)**:
  - åç«¯ä¸æä¾›ç›´æ¥çš„ Restful API ç»™é˜…è¯»å™¨ UIã€‚
  - **Reading Position** é€šè¿‡ PowerSync æµå¼å†™å…¥ PostgreSQL `book_position` è¡¨ã€‚
  - **Time Log Sync**: é˜…è¯»æ—¶é•¿ (`reading_time_log`) ä¸éœ€è¦æ˜¾å¼è°ƒç”¨ APIã€‚å‰ç«¯ç»„ä»¶å°†å¿ƒè·³æ•°æ®å†™å…¥æœ¬åœ° SQLiteï¼Œç”± PowerSync åå°è‡ªåŠ¨åŒæ­¥è‡³ PostgreSQLã€‚
  
#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`Reader`
  - Props:
    ```ts
    interface ReaderProps {
      bookId: string
      initialLocation?: string // From SQLite
    }
    ```
  - **Interaction**:
    - **Page Turn**: Writes `cfi` to SQLite `book_position` table immediately.
    - **Sync**: PowerSync SDK watches SQLite changes and pushes to server automatically.
    - **Offline**: No extra logic needed; SQLite is always available.
  
### âœ” Definition of Done (DoD)
- [ ] SQLite Schema defined for `book_position`
- [ ] PowerSync Sync Rules configured for `book_position` and `reading_time_log`
- [ ] Reader component reading/writing from/to SQLite
- [ ] Conflict resolution (LWW) verified via PowerSync configuration

---

### 2.4 Notes & Highlights

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰
- `notes`ï¼š`id`ã€`user_id`ã€`book_id`ã€`content`ã€`chapter`ã€`location`ã€`pos_offset`ã€`tsv`ã€`updated_at`ã€`version`ã€`deleted_at`ã€‚
- `tags`ï¼š`id`ã€`user_id`ã€`name`ã€`updated_at`ã€`version`ã€`deleted_at`ã€‚
- `note_tags`ï¼šè¿æ¥è¡¨ï¼Œ`note_id`ã€`tag_id`ï¼›`ON CONFLICT DO NOTHING`ã€‚
- æƒé™å­—æ®µï¼š`user_id`ï¼›å¹¶å‘å­—æ®µï¼š`version`ã€‚

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰
- **PowerSync Surface**ï¼š`download_config` åŒæ­¥ `notes`, `highlights`, `tags`, `note_tags`, `highlight_tags`ï¼›`upload_config` å…è®¸æºå¸¦ `device_id`, `updated_at`, `is_deleted` å­—æ®µçš„ UPSERTã€‚
- **REST ç«¯ç‚¹**ï¼š`/api/v1/notes/*`, `/api/v1/highlights/*`, `/api/v1/tags/*` ä»…ä¿ç•™ä¸‹åˆ—ç”¨é€”ï¼šç®¡ç†å‘˜å·¥å…·ã€å¤–éƒ¨é›†æˆã€PowerSync å¤±æ•ˆæ—¶çš„åº”æ€¥å›é€€ã€‚
- **ä¸€è‡´æ€§è§„åˆ™**ï¼š
  - åªè¯»é”ä¾æ—§é€šè¿‡ RLS/è§¦å‘å™¨é˜»æ–­å†™å…¥ï¼›PowerSync ä¸Šä¼ å¤±è´¥ä¼šè¿”å›å¯¹åº”çš„ 4xx ä»£ç ã€‚
  - è½¯åˆ é™¤ä¾èµ– `_deleted` + `_deleted_at` å­—æ®µï¼›æœåŠ¡ç«¯æ¥æ”¶åˆ é™¤åé€šè¿‡ PowerSync ä¸‹å‘ã€‚
  - å†²çªï¼šç¬”è®°/é«˜äº®é‡‡ç”¨ Conflict Copyï¼ˆç”±è§¦å‘å™¨å†™ `conflict_of`ï¼‰ã€‚

#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`NoteEditor`
  - Props åŒä¸Šã€‚
  - äº¤äº’ï¼šä¿å­˜â†’å†™ SQLite (`notes` è¡¨)â†’PowerSync è‡ªåŠ¨åŒæ­¥ï¼›åœ¨ `onError` ä¸­åªå¤„ç†æœ¬åœ°éªŒè¯æˆ– PowerSync å¤±è´¥äº‹ä»¶ã€‚
- ç»„ä»¶ï¼š`TagPicker`
  - Propsï¼š
    ```ts
    interface TagPickerProps {
      tags: Array<{ id: string; name: string; etag: string }>
      onCreate: (name: string) => void
      onUpdate: (id: string, name: string, etag: string) => void
    }
    ```

### âœ” Definition of Done (DoD)
- [ ] PowerSync ä¸‹è½½/ä¸Šä¼ è§„åˆ™æ¶µç›– Notes/Tags CRUD ä¸æœç´¢æ‰€éœ€å­—æ®µ
- [ ] è½¯åˆ é™¤ä¸ `_deleted` æŠ•é€’åŠå‰ç«¯å¤„ç†ç”¨ä¾‹
- [ ] `tsv` ç´¢å¼•ç”Ÿæˆä¸æ£€ç´¢æµ‹è¯•è¦†ç›–
- [ ] ETag/Idempotency ä¸€è‡´æ€§æ ¡éªŒ
- [ ] RLS ä¸å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•
- [ ] è¿ç§»è„šæœ¬ä¸å›æ»šè®¡åˆ’é½å¤‡
---

### 2.5 AI Knowledge Engine

> **æ¶æ„å†³ç­–**ï¼šAI åŠŸèƒ½**å¿…é¡»**é€šè¿‡ REST API å®ç°ï¼ˆé PowerSyncï¼‰ï¼Œå› ä¸ºï¼š
> 1. AI åŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½ä½¿ç”¨
> 2. SSE æµå¼å“åº”æ— æ³•é€šè¿‡ PowerSync å®ç°
> 3. éœ€è¦æœåŠ¡ç«¯è®¡è´¹å’Œé™æµæ§åˆ¶
>
> **å¯¹è¯è®°å½•å­˜å‚¨**ï¼šAI å¯¹è¯å†å²é€šè¿‡ PowerSync åŒæ­¥åˆ°æœ¬åœ° SQLiteï¼Œå®ç°ç¦»çº¿æŸ¥çœ‹å†å²å¯¹è¯ã€‚

#### A. æŠ€æœ¯æ ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| åç«¯æ¡†æ¶ | **FastAPI** | å¼‚æ­¥æ”¯æŒã€SSE æµå¼å“åº” |
| RAG æ¡†æ¶ | **LlamaIndex** | å‘é‡æ£€ç´¢ã€Query Rewriteã€Rerank |
| PDF è§£æ | **IBM Docling** | æå–ç« èŠ‚ç»“æ„ã€è¡¨æ ¼ã€å›¾è¡¨ |
| å‰ç«¯ AI SDK | **Vercel AI SDK** | ç»Ÿä¸€æµå¼æ¥å£ã€`onFinish` Token è®¡æ•° |
| å‘é‡å­˜å‚¨ | **PostgreSQL + pgvector** | ä¸ä¸»æ•°æ®åº“ç»Ÿä¸€ |
| LLM è°ƒç”¨ | **OpenAI / Claude API** | å¯é…ç½®æ¨¡å‹ |

#### B. ä¸‰ç§ AI æ¨¡å¼

| æ¨¡å¼ | è§¦å‘åœºæ™¯ | æŠ€æœ¯å®ç° | è´¹ç”¨ |
|------|---------|----------|------|
| **èŠå¤©æ¨¡å¼** | é€šç”¨å¯¹è¯/é—²èŠ | çº¯ LLMï¼Œæ—  RAGï¼Œæ— ä¹¦åº“ä¸Šä¸‹æ–‡ | ä½ (çº¦ 0.3-1 Credits/æ¬¡) |
| **ç¿»è¯‘æ¨¡å¼** | é€‰ä¸­æ–‡æœ¬ â†’ ç¿»è¯‘ | çº¯ LLMï¼Œæ—  RAG | ä½ (çº¦ 0.5 Credits/æ¬¡) |
| **é—®ç­”æ¨¡å¼** | ä¹¦ç±å†…å¯¹è¯/æé—® | RAG Pipeline | ä¸­ (çº¦ 2-5 Credits/æ¬¡) |

**èŠå¤©æ¨¡å¼æµç¨‹**ï¼š
```
ç”¨æˆ·åœ¨ AI åŠ©æ‰‹ç•Œé¢å‘èµ·å¯¹è¯ï¼ˆæœªå…³è”ä¹¦ç±ï¼‰
    â†“
POST /api/v1/ai/chat
    â†“
ç›´æ¥è°ƒç”¨ LLM (æ— å‘é‡æ£€ç´¢ï¼Œæ— ä¹¦åº“ä¸Šä¸‹æ–‡)
    â†“
SSE æµå¼è¿”å›å›ç­”
```

> **èŠå¤©æ¨¡å¼è¯´æ˜**ï¼š
> - ä¸æ¶‰åŠç”¨æˆ·ä¹¦åº“å†…å®¹ï¼Œçº¯é€šç”¨ AI å¯¹è¯
> - é€‚ç”¨äºï¼šå†™ä½œè¾…åŠ©ã€çŸ¥è¯†é—®ç­”ã€å¤´è„‘é£æš´ç­‰é€šç”¨åœºæ™¯
> - å…¥å£ï¼šAI åŠ©æ‰‹é¢æ¿ â†’ æ–°å»ºå¯¹è¯ï¼ˆä¸å…³è”ä¹¦ç±ï¼‰

**ç¿»è¯‘æ¨¡å¼æµç¨‹**ï¼š
```
ç”¨æˆ·é€‰ä¸­æ–‡æœ¬ â†’ ç‚¹å‡»"ç¿»è¯‘"æŒ‰é’®
    â†“
POST /api/v1/ai/translate
    â†“
ç›´æ¥è°ƒç”¨ LLM (æ— å‘é‡æ£€ç´¢)
    â†“
SSE æµå¼è¿”å›ç¿»è¯‘ç»“æœ
```

**é—®ç­”æ¨¡å¼ RAG æµç¨‹**ï¼š
```
ç”¨æˆ·æé—®
    â†“
1. Query Rewrite (åŸºäºä¸Šä¸‹æ–‡é‡å†™æŸ¥è¯¢)
    â†“
2. Vector Search (pgvector Top-K æ£€ç´¢)
    â†“
3. IBM Docling è§£æ (æå–ç« èŠ‚/è¡¨æ ¼ç»“æ„)
    â†“
4. Rerank (Cross-Encoder é‡æ’åº)
    â†“
5. LLM ç”Ÿæˆå›ç­” (å«å¼•ç”¨ä¸è·³è½¬é”šç‚¹)
    â†“
6. SSE æµå¼è¾“å‡º
    â†“
7. onFinish: Token è®¡æ•° â†’ Credits æ‰£è´¹
```

#### C. IBM Docling é›†æˆ

> **ç”¨é€”**ï¼šå°† PDF è§£æä¸ºç»“æ„åŒ–æ–‡æ¡£ï¼Œæå–ç« èŠ‚ã€è¡¨æ ¼ã€å›¾è¡¨ã€‚

```python
from docling.document_converter import DocumentConverter

converter = DocumentConverter()

def parse_book_for_rag(book_id: str, pdf_path: str) -> list[dict]:
    """è§£æä¹¦ç±ä¸º RAG å¯ç”¨çš„ç»“æ„åŒ–å—"""
    result = converter.convert(pdf_path)
    document = result.document
    
    chunks = []
    for item in document.iterate_items():
        if item.label in ["paragraph", "table", "figure"]:
            chunks.append({
                "book_id": book_id,
                "content": item.text,
                "type": item.label,
                "page": item.prov[0].page if item.prov else None,
                "bbox": item.prov[0].bbox if item.prov else None,
            })
    return chunks
```

#### D. Vercel AI SDK å‰ç«¯é›†æˆ

> **Token è®¡æ•°**ï¼šä½¿ç”¨ `onFinish` å›è°ƒè·å–çœŸå® Token æ¶ˆè€—ï¼Œç”¨äº Credits æ‰£è´¹ã€‚

```typescript
import { useChat } from 'ai/react';

function AIChat({ conversationId }: { conversationId: string }) {
  const { messages, input, handleInputChange, handleSubmit } = useChat({
    api: '/api/v1/ai/conversations/' + conversationId + '/messages',
    onFinish: (message, { usage }) => {
      // usage.totalTokens åŒ…å«çœŸå® Token æ¶ˆè€—
      console.log('Token usage:', usage?.totalTokens);
      // åç«¯å·²åœ¨ SSE ç»“æŸæ—¶æ‰£è´¹ï¼Œæ­¤å¤„ä»…ç”¨äº UI æ˜¾ç¤º
    },
  });
  
  return (/* UI ç»„ä»¶ */);
}
```

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰

**`ai_conversations` è¡¨**ï¼ˆå¯ç”¨ RLSï¼‰ï¼š
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|:-----|:-----|:-----|
| `id` | UUID, PK | ä¼šè¯ ID |
| `user_id` | UUID, FK | ç”¨æˆ· ID |
| `title` | TEXT | ä¼šè¯æ ‡é¢˜ |
| `book_id` | UUID, Nullable | å…³è”ä¹¦ç±ï¼ˆå¯é€‰ï¼‰ |
| `related_context` | JSONB | ä¸Šä¸‹æ–‡ï¼ˆé€‰ä¸­æ–‡æœ¬ã€ç¬”è®°å¼•ç”¨ç­‰ï¼‰ |
| `conversation_history` | JSONB | æ¶ˆæ¯å†å²æ•°ç»„ |
| `version` | INTEGER, Default: 1 | ä¹è§‚é”ç‰ˆæœ¬å·ï¼ˆç”¨äº ETag/If-Matchï¼‰ |
| `deleted_at` | TIMESTAMPTZ, Nullable | è½¯åˆ é™¤æ—¶é—´ |
| `created_at` | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMPTZ | æ›´æ–°æ—¶é—´ |

**æ¶ˆæ¯ç»“æ„**ï¼ˆå­˜å‚¨åœ¨ `conversation_history` JSONB ä¸­ï¼‰ï¼š
```typescript
interface AIMessage {
  role: 'user' | 'assistant' | 'system';
  text: string;
  refs?: Array<{
    type: 'highlight' | 'note' | 'location';
    cfi?: string;
    bookId?: string;
    content?: string;
  }>;
  created_at: string; // ISO8601
}
```

**RLS ç­–ç•¥**ï¼ˆç”¨æˆ·éš”ç¦»ï¼‰ï¼š
```sql
ALTER TABLE ai_conversations ENABLE ROW LEVEL SECURITY;
CREATE POLICY ai_conversations_user ON ai_conversations
  FOR ALL USING (user_id = current_setting('app.user_id')::uuid);
```

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰

**ç«¯ç‚¹æ¸…å•**ï¼ˆè¯¦è§ 05 å¥‘çº¦ï¼‰ï¼š
| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|:-----|:-----|:-----|
| `/api/v1/ai/conversations` | GET | åˆ—å‡ºä¼šè¯ï¼ˆåˆ†é¡µï¼Œcursor-basedï¼‰ |
| `/api/v1/ai/conversations` | POST | åˆ›å»ºä¼šè¯ + é¦–æ¡æ¶ˆæ¯ |
| `/api/v1/ai/conversations/{id}` | GET | è·å–ä¼šè¯è¯¦æƒ…ï¼ˆè¿”å› ETagï¼‰ |
| `/api/v1/ai/conversations/{id}` | PATCH | ä¿®æ”¹æ ‡é¢˜/å…ƒæ•°æ®ï¼ˆéœ€ If-Matchï¼‰ |
| `/api/v1/ai/conversations/{id}` | DELETE | è½¯åˆ é™¤ä¼šè¯ |
| `/api/v1/ai/conversations/{id}/messages` | POST | è¿½åŠ æ¶ˆæ¯ï¼ˆè§¦å‘ AI å›å¤ï¼ŒSSE æµå¼ï¼‰ |
- è§„åˆ™ï¼š
  - AI Chat ä¸å—åªè¯»é”å½±å“ã€‚
  - Credits ä¸è¶³ â†’ è¿”å› `INSUFFICIENT_CREDITS`ã€‚
  - è®¡è´¹é¡ºåºï¼šæœˆåº¦èµ ç¤¼ â†’ åŠ æ²¹åŒ… â†’ Wallet â†’ æ‹’ç»ã€‚
  - ä¼šè¯ç‰ˆæœ¬å†²çªï¼šä½¿ç”¨ `ETag/If-Match` æˆ– Session Versionï¼Œå†²çªè¿”å› 409ã€‚
- RAG æµç¨‹ï¼š
  1) Query Rewriteï¼šåŸºäºç”¨æˆ·ä¸Šä¸‹æ–‡é‡å†™æŸ¥è¯¢ (LlamaIndex QueryTransform)ã€‚
  2) Vector Searchï¼šPostgreSQL pgvector æ£€ç´¢ Top-K ç‰‡æ®µã€‚
  3) Docling Parseï¼šå¯¹ PDF æºæå–ç« èŠ‚/è¡¨æ ¼ç»“æ„ã€‚
  4) Re-rankï¼šLlamaIndex Reranker + Cross-Encoder é‡æ’åºã€‚
  4) LLM ç”Ÿæˆï¼šä»¥é‡æ’åçš„è¯æ®ç”Ÿæˆå›ç­”ï¼ŒåŒ…å«å¼•ç”¨ä¸è·³è½¬é”šç‚¹ã€‚
  5) æµå¼è¾“å‡ºï¼šä½¿ç”¨ SSE/WebSocket æ¨é€ï¼›æ”¯æŒâ€œåœæ­¢/ç»§ç»­â€ã€‚
  7) Token è®¡è´¹ï¼šonFinish å›è°ƒè·å– Token æ•°ï¼Œæ‰£é™¤ Creditsã€‚
> Status: Contract Availableï¼›Backend = To Implementï¼ˆæŒ‰æ­¤ç®¡çº¿å®ç°ï¼‰ã€‚

#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`AIConversationsPanel`
  - Propsï¼š
    ```ts
    interface AIConversationsPanelProps {
      sessionId?: string
      onMessage?: (msg: { id: string; role: 'user' | 'assistant'; content: string }) => void
      onStop?: () => void
    }
    ```

### âœ” Definition of Done (DoD)
- [ ] API å¥‘çº¦ä¸ SSE/WebSocket è¡Œä¸ºå¯¹é½
- [ ] Credits æ‰£è´¹é¡ºåºä¸ä¸è¶³é”™è¯¯ç”¨ä¾‹
- [ ] RAG å„é˜¶æ®µå¯æ›¿æ¢/Mock çš„æµ‹è¯•ç­–ç•¥
- [ ] ETag/Session Version å†²çªå¤„ç†æµ‹è¯•
- [ ] å‰ç«¯æ¶ˆæ¯æµä¸åœæ­¢/ç»§ç»­å¥‘çº¦å®ç°
- [ ] è´¦å•è”åŠ¨ä¸å°è´¦è®°å½•éªŒè¯
---

### 2.6 Billing & Account

#### A. æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Schemaï¼‰
- `credit_accounts`ã€`credit_ledger`ã€`payment_sessions`ã€`payment_webhook_events`ã€`user_stats`ï¼ˆå­—æ®µè¯¦è§ 04 å·æ–‡æ¡£ï¼‰ã€‚

#### B. åç«¯é€»è¾‘ä¸ API å¥‘çº¦ï¼ˆBackend & Contractï¼‰
- ç«¯ç‚¹ï¼š`GET /billing/balance`ã€`GET /billing/ledger`ã€`POST /billing/sessions`ã€`POST /billing/webhook/{gateway}`ã€‚
- è§„åˆ™ï¼šåªè¯»é”ç”± `user_stats` ä¸ `system_settings` è®¡ç®—ï¼›OCR é˜¶æ¢¯æ‰£è´¹ä¸å°è´¦è®°è½½ï¼›Webhook å…¥è´¦ä¸ç­¾åæ ¡éªŒã€‚

#### F. å‰ç«¯ç»„ä»¶å¥‘çº¦ï¼ˆFrontend Contractï¼‰
- ç»„ä»¶ï¼š`BalanceCard`
  - Propsï¼š
    ```ts
    interface BalanceCardProps {
      balance: number
      currency: string
      walletAmount?: number
      walletCurrency?: string
    }
    ```
- ç»„ä»¶ï¼š`CheckoutPanel`
  - Propsï¼š
    ```ts
    interface CheckoutPanelProps {
      gateway: 'stripe' | 'wechat' | 'alipay' | string
      amountMinor: number
      currency: string
      onSessionCreated: (session: { id: string; paymentUrl: string }) => void
    }
    ```
  - äº¤äº’ï¼šåˆ›å»ºä¼šè¯â†’è·³è½¬ç¬¬ä¸‰æ–¹â†’Webhook å…¥è´¦â†’åˆ·æ–°ä½™é¢ä¸å°è´¦ã€‚
- **æ•°æ®å¯¼å‡º (Escape Hatch)**ï¼šåœ¨è®¾ç½®é¡µæä¾›â€œå¯¼å‡ºå…¨éƒ¨æ•°æ®â€æŒ‰é’®ï¼Œæ‰“åŒ…ä¸‹è½½æ‰€æœ‰ç¬”è®° (Markdown) å’Œå…ƒæ•°æ® (JSON)ï¼Œç”Ÿæˆè¿‡ç¨‹çº¯æœ¬åœ°è¿›è¡Œã€‚

### 2.7 å…¨å±€æœç´¢ä¸ç´¢å¼• (Global Search & Local FTS)
#### A. æŠ€æœ¯æ–¹æ¡ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| æœç´¢å¼•æ“ | **SQLite FTS5** | æœ¬åœ°å…¨æ–‡æœç´¢ï¼Œç¦»çº¿å¯ç”¨ |
| ä¸­æ–‡åˆ†è¯ | **Intl.Segmenter** | æµè§ˆå™¨/iOS åŸç”Ÿ API |
| ç´¢å¼•å­˜å‚¨ | **local SQLite** | æœ¬åœ°è¡¨ï¼Œä¸å‚ä¸ PowerSync åŒæ­¥ |

#### B. ä¸­æ–‡åˆ†è¯ç­–ç•¥ (Smart Segmentation)
*   **é—®é¢˜**ï¼šSQLite FTS5 é»˜è®¤ä¸æ”¯æŒä¸­æ–‡åˆ†è¯ã€‚
*   **è§£å†³æ–¹æ¡ˆ**ï¼š**å‰ç«¯é¢„åˆ†è¯**ã€‚å†™å…¥ SQLite å‰ï¼Œä½¿ç”¨ `Intl.Segmenter` (ç°ä»£æµè§ˆå™¨/iOSåŸç”Ÿ) å°†ä¸­æ–‡åˆ‡åˆ†ä¸ºå¸¦ç©ºæ ¼çš„è¯ç»„ã€‚
*   **ç¤ºä¾‹**ï¼šç”¨æˆ·è¾“å…¥â€œç»æµå­¦åŸç†â€ -> å­˜å…¥ `segmented_text` ä¸º â€œç»æµ ç»æµå­¦ åŸç†â€ã€‚


#### C. æ•°æ®åº“æ¨¡å‹ (Local-Only SQLite)
```sql
CREATE TABLE global_search_index (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_type TEXT NOT NULL,
    source_id TEXT NOT NULL,
    book_id TEXT NOT NULL,
    chunk_index INTEGER DEFAULT 0,
    raw_text TEXT NOT NULL,
    segmented_text TEXT NOT NULL,
    location_data TEXT,
    UNIQUE(source_type, source_id, chunk_index)
);

CREATE VIRTUAL TABLE global_search_fts USING fts5(
    segmented_text, content='global_search_index', content_rowid='id'
);
```

### Definition of Done - Global Search
- [ ] FTS5 ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] ä¸­æ–‡é¢„åˆ†è¯æ­£å¸¸

---

### 2.8 Admin & Operations (åå°ç®¡ç†)
#### A. åŠŸèƒ½æ¦‚è§ˆ
- **å•†ä¸šå‚æ•°é…ç½®**ï¼šå®æ—¶è°ƒæ•´æ±‡ç‡ (`wallet_exchange_rate`)ã€OCR é˜¶æ¢¯é˜ˆå€¼ (`ocr_page_thresholds`)ã€å…è´¹é…é¢ (`free_book_limit`) ç­‰ï¼ˆè¯¦è§ 01 æ–‡æ¡£ç¬¬ 5 èŠ‚ï¼‰ã€‚
- **åˆè§„æ–‡æ¡£ç®¡ç†**ï¼šç¼–è¾‘æœåŠ¡æ¡æ¬¾ (TOS)ã€éšç§åè®® (Privacy Policy)ã€‚
- **ç”¨æˆ·ç®¡ç†**ï¼šæŸ¥çœ‹/å°ç¦ç”¨æˆ·ã€èµ é€ Credits (è¡¥å•)ã€‚
- **ç³»ç»Ÿç›‘æ§**ï¼šOCR é˜Ÿåˆ—å †ç§¯æŠ¥è­¦ã€Celery Worker çŠ¶æ€ã€‚

#### B. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **å•†ä¸šå‚æ•°çƒ­æ›´æ–° (Hot Reload)**ï¼š
  - æ‰€æœ‰å‚æ•°å­˜å‚¨åœ¨ `system_settings` è¡¨ (Key-Value/JSONB)ã€‚
  - API è¯»å–æ—¶å¿…é¡»æœ‰ **TTL ç¼“å­˜ (e.g., 5åˆ†é’Ÿ)**ï¼Œé¿å…é«˜é¢‘æ‰“åº“ã€‚
  - Admin ä¿®æ”¹åï¼Œå‘å¸ƒ Redis Pub/Sub äº‹ä»¶ `config_updated`ï¼Œé€šçŸ¥æ‰€æœ‰ API å®ä¾‹æ¸…é™¤ç¼“å­˜ã€‚
- **åè®®æ–‡æ¡£ç®¡ç†**ï¼š
  - å­˜å‚¨ï¼šTOS å’Œ Privacy Policy å­˜å‚¨åœ¨ `system_settings` è¡¨ä¸­ï¼ŒKey ä¸º `compliance_tos_zh_cn`, `compliance_privacy_zh_cn` (å¤šè¯­è¨€æ”¯æŒ)ã€‚
  - ç¼–è¯‘ï¼šAdmin ç¼–è¾‘ Markdown æºç  -> ä¿å­˜æ—¶åŒæ—¶ç”Ÿæˆ HTML ç¼“å­˜ -> API æä¾› `GET /api/v1/public/compliance/{type}` ä¾› App ç«¯ Webview æ¸²æŸ“ã€‚

#### C. ç®¡ç†ç«¯ç»„ä»¶å¥‘çº¦ (Frontend Contract)
- ç»„ä»¶ï¼š`ConfigEditor` (ç”¨äºç¼–è¾‘ JSONB å‚æ•°)
  - Props: `{ configKey, schema, value, onSave }`
  - åŠŸèƒ½ï¼šåŸºäº JSON Schema éªŒè¯è¾“å…¥ï¼Œé˜²æ­¢é…ç½®é”™è¯¯çš„ JSON å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚
- ç»„ä»¶ï¼š`MarkdownEditor` (ç”¨äºç¼–è¾‘åè®®)
  - ...

### âœ” Definition of Done (DoD)
- [ ] Admin å¯è¯»å†™ `system_settings` è¡¨ä¸­çš„å•†ä¸šå‚æ•°
- [ ] API ä¾§å®ç°é…ç½®ç¼“å­˜ä¸æ¸…é™¤æœºåˆ¶
- [ ] Admin ç•Œé¢å¯ç¼–è¾‘ TOS/Privacy å¹¶æ­£ç¡®æŒä¹…åŒ–
- [ ] å…¬å¼€ API ç«¯ç‚¹ (`/public/compliance/*`) å¯è·å–æœ€æ–°åè®®å†…å®¹
- [ ] é‚®ç®±"é˜²è¾“é”™"ç¡®è®¤å¼¹çª—äº¤äº’å®ç°


### âœ” Definition of Done (DoD)
- [ ] æ”¯ä»˜ä¼šè¯åˆ›å»ºä¸ Webhook å…¥è´¦è”åŠ¨ç”¨ä¾‹
- [ ] äº‹åŠ¡ä¸€è‡´æ€§ï¼šæ‰£è´¹ä¸ä¸šåŠ¡å†™å…¥åŒäº¤æ˜“æµ‹è¯•
- [ ] RLS ä¸è´¦æœ¬éš”ç¦»æ ¡éªŒ
- [ ] é”™è¯¯ç æ˜ å°„ä¸æ–‡æ¡ˆä¸€è‡´æ€§
- [ ] å‰ç«¯ä½™é¢/å°è´¦ç»„ä»¶å¥‘çº¦å¯¹é½
- [ ] Alembic è¿ç§»ä¸å›æ»šè®¡åˆ’é½å¤‡

---

### 2.9 TTS å¬ä¹¦ (Text-to-Speech)

> **æ¶æ„å†³ç­–**ï¼šé‡‡ç”¨**çº¯å‰ç«¯ç¦»çº¿æ–¹æ¡ˆ**ï¼ŒApp å†…ç½®é«˜ä¿çœŸä¸­æ–‡ TTS æ¨¡å‹ï¼Œæ— éœ€åç«¯æœåŠ¡ã€‚

#### A. æŠ€æœ¯æ–¹æ¡ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| TTS å¼•æ“ | **Sherpa-onnx (WASM)** | å¼€æºã€é«˜æ€§èƒ½ã€æ”¯æŒå¤šè¯­è¨€ |
| è¿è¡Œç¯å¢ƒ | **Web Worker** | ç‹¬ç«‹çº¿ç¨‹ï¼Œä¸é˜»å¡ UI |
| ä¸­æ–‡æ¨¡å‹ | **å†…ç½®** (~45MB) | App å‘å¸ƒæ—¶æ‰“åŒ…ï¼Œé¦–æ¬¡å¯åŠ¨å¯ç”¨ |
| è‹±æ–‡/æ—¥æ–‡æ¨¡å‹ | **DLC æŒ‰éœ€ä¸‹è½½** | ç”¨æˆ·é¦–æ¬¡é€‰æ‹©è¯­è¨€æ—¶ä¸‹è½½ |
| å­˜å‚¨ä½ç½® | **OPFS** (Origin Private FS) | æœ¬åœ°æŒä¹…åŒ–ï¼Œè·¨ä¼šè¯å¤ç”¨ |

#### B. ç”¨æˆ·ä½“éªŒæµç¨‹
```
å…¥å£ä¸€ï¼šä¹¦ç±å¡ç‰‡ â‹® èœå• â†’ "å¬ä¹¦"
å…¥å£äºŒï¼šé˜…è¯»å™¨å†… â†’ å·¥å…·æ  â†’ ğŸ§ æŒ‰é’®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– TTS æ’­æ”¾æ§åˆ¶å™¨ (åº•éƒ¨æ‚¬æµ®)                               â”‚
â”‚                                                            â”‚
â”‚  ç¬¬ 3 ç«  Â· ç»æµå­¦åŸºç¡€                                       â”‚
â”‚  â–¶ â•â•â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• 12:34 / 45:21    â”‚
â”‚                                                            â”‚
â”‚  [â® ä¸Šæ®µ] [âª -15s] [â¸ æš‚åœ] [â© +15s] [â­ ä¸‹æ®µ]           â”‚
â”‚  [ğŸ”Š éŸ³é‡] [âš¡ 1.0x] [ğŸ¤ éŸ³è‰²]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### C. æ•°æ®åº“æ¨¡å‹ (Local-Only SQLite)
```sql
-- æœ¬åœ° TTS è®¾ç½® (ä¸å‚ä¸ PowerSync åŒæ­¥)
CREATE TABLE local_tts_settings (
    id INTEGER PRIMARY KEY CHECK (id = 1),  -- å•ä¾‹
    voice_id TEXT DEFAULT 'zh_cn_female_01', -- å½“å‰éŸ³è‰²
    speed REAL DEFAULT 1.0,                  -- æ’­æ”¾é€Ÿåº¦ 0.5-2.0
    volume REAL DEFAULT 1.0,                 -- éŸ³é‡ 0-1
    auto_scroll BOOLEAN DEFAULT TRUE,        -- è‡ªåŠ¨æ»šåŠ¨æ–‡æœ¬
    updated_at TEXT DEFAULT (datetime('now'))
);

-- æœ¬åœ° TTS æ¨¡å‹ç¼“å­˜
CREATE TABLE local_tts_models (
    model_id TEXT PRIMARY KEY,               -- e.g., 'zh_cn_female_01'
    language TEXT NOT NULL,                  -- 'zh', 'en', 'ja'
    display_name TEXT NOT NULL,              -- 'ä¸­æ–‡å¥³å£° (æ ‡å‡†)'
    file_path TEXT NOT NULL,                 -- OPFS è·¯å¾„
    file_size INTEGER NOT NULL,              -- å­—èŠ‚æ•°
    is_bundled BOOLEAN DEFAULT FALSE,        -- æ˜¯å¦å†…ç½®æ¨¡å‹
    downloaded_at TEXT
);
```

#### D. æ”¯æŒçš„éŸ³è‰²
| è¯­è¨€ | éŸ³è‰² ID | æ˜¾ç¤ºåç§° | å¤§å° | ç±»å‹ |
|-----|---------|---------|------|------|
| ä¸­æ–‡ | `zh_cn_female_01` | ä¸­æ–‡å¥³å£° (æ ‡å‡†) | ~45MB | å†…ç½® |
| ä¸­æ–‡ | `zh_cn_male_01` | ä¸­æ–‡ç”·å£° (æ ‡å‡†) | ~45MB | DLC |
| è‹±æ–‡ | `en_us_female_01` | English Female | ~30MB | DLC |
| æ—¥æ–‡ | `ja_jp_female_01` | æ—¥æœ¬èªå¥³æ€§ | ~35MB | DLC |

#### E. å‰ç«¯ç»„ä»¶å¥‘çº¦
```typescript
interface TTSController {
  // çŠ¶æ€
  isPlaying: boolean;
  currentPosition: { chapter: number; paragraph: number };
  progress: number; // 0-1
  duration: number; // é¢„ä¼°æ€»æ—¶é•¿ (ç§’)
  
  // æ§åˆ¶
  play(): void;
  pause(): void;
  seekTo(chapter: number, paragraph: number): void;
  setSpeed(speed: number): void;
  setVoice(voiceId: string): void;
  
  // äº‹ä»¶
  onParagraphChange: (para: number) => void;  // ç”¨äºé«˜äº®å½“å‰æ®µè½
  onComplete: () => void;
}
```

### âœ” Definition of Done (DoD) - TTS
- [ ] Sherpa-onnx WASM æˆåŠŸåŠ è½½å¹¶åœ¨ Web Worker è¿è¡Œ
- [ ] ä¸­æ–‡å†…ç½®æ¨¡å‹æ­£å¸¸å‘å£°ï¼Œæ— æ˜æ˜¾å»¶è¿Ÿ
- [ ] DLC æ¨¡å‹ä¸‹è½½ã€å­˜å‚¨ã€åŠ è½½æµç¨‹å®Œæ•´
- [ ] é˜…è¯»å™¨å†…æ®µè½é«˜äº®ä¸è¯­éŸ³åŒæ­¥
- [ ] æ’­æ”¾æ§åˆ¶å™¨ UI å®Œæ•´å®ç°

---

### 2.10 æƒå¨è¯å…¸ (Dictionary)

> **æ¶æ„å†³ç­–**ï¼šé‡‡ç”¨**å†…ç½® SQLite Sidecar æ•°æ®åº“**ï¼Œå®Œå…¨ç¦»çº¿å¯ç”¨ï¼Œä¸å‚ä¸ PowerSync åŒæ­¥ã€‚

#### A. æŠ€æœ¯æ–¹æ¡ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| æ•°æ®åº“ | **SQLite Sidecar** | `dict_master.db` (~40MB) |
| è¿è¡Œæ¨¡å¼ | **åªè¯»** | App å†…ç½®ï¼Œä¸å¯ç¼–è¾‘ |
| è¯å…¸æ¥æº | å¼€æºè¯å…¸æ•´åˆ | ç°ä»£æ±‰è¯­è¯å…¸ + WordNet + ECDICT |
| åŠ è½½æ–¹å¼ | **é¢„è£…æ‰“åŒ…** | Web: IndexedDB åˆå§‹åŒ–; Native: Assets |

#### B. ç”¨æˆ·ä½“éªŒæµç¨‹
```
é˜…è¯»å™¨å†…é€‰ä¸­æ–‡å­— â†’ å¼¹å‡ºå·¥å…·æ 
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“–  ğŸ“  ğŸ”  ğŸ“š                           â”‚  â† é«˜äº®/ç¬”è®°/æœç´¢/è¯å…¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç‚¹å‡» ğŸ“š è¯å…¸æŒ‰é’®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯å…¸ Â· "ç»æµ"                                               â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  ã€æ‹¼éŸ³ã€‘jÄ«ng jÃ¬                                             â”‚
â”‚  ã€è¯æ€§ã€‘åè¯                                                 â”‚
â”‚  ã€é‡Šä¹‰ã€‘                                                     â”‚
â”‚    1. ç»ä¸–æµæ°‘ï¼Œæ²»ç†å›½å®¶ã€‚                                    â”‚
â”‚    2. ç¤¾ä¼šç‰©è´¨ç”Ÿäº§ã€åˆ†é…ã€äº¤æ¢å’Œæ¶ˆè´¹çš„æ´»åŠ¨å’Œå…³ç³»çš„æ€»å’Œã€‚       â”‚
â”‚  ã€ä¾‹å¥ã€‘å¸‚åœºç»æµæ˜¯ä¸€ç§èµ„æºé…ç½®æ–¹å¼ã€‚                         â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  [æ·»åŠ åˆ°ç¬”è®°]                              [å…³é—­]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### C. æ•°æ®åº“ Schema (`dict_master.db`)
```sql
-- è¯æ¡è¡¨
CREATE TABLE entries (
    id INTEGER PRIMARY KEY,
    word TEXT NOT NULL,                    -- è¯æ¡
    language TEXT NOT NULL,                -- 'zh', 'en'
    phonetic TEXT,                         -- å‘éŸ³/æ‹¼éŸ³
    pos TEXT,                              -- è¯æ€§ (noun, verb, adj...)
    definitions TEXT NOT NULL,             -- JSON æ•°ç»„: ["é‡Šä¹‰1", "é‡Šä¹‰2"]
    examples TEXT,                         -- JSON æ•°ç»„: ["ä¾‹å¥1", "ä¾‹å¥2"]
    etymology TEXT,                        -- è¯æº
    frequency INTEGER DEFAULT 0            -- è¯é¢‘ (ç”¨äºæ’åº)
);

-- ç´¢å¼• (é¢„å»ºï¼Œåªè¯»)
CREATE INDEX idx_entries_word ON entries(word);
CREATE INDEX idx_entries_language ON entries(language, word);

-- FTS å…¨æ–‡æœç´¢ (ç”¨äºæ¨¡ç³ŠæŸ¥è¯¢)
CREATE VIRTUAL TABLE entries_fts USING fts5(
    word, definitions,
    content='entries',
    content_rowid='id'
);
```

#### D. è¯å…¸å†…å®¹æ¥æº
| è¯­è¨€ | è¯å…¸ | è¯æ¡æ•° | è®¸å¯è¯ |
|-----|------|-------|-------|
| ä¸­æ–‡ | CC-CEDICT + å¼€æºæ±‰è¯­è¯å…¸ | ~120,000 | CC BY-SA |
| è‹±æ–‡ | WordNet 3.1 | ~150,000 | WordNet License |
| è‹±æ±‰ | ECDICT | ~770,000 | MIT |

#### E. å‰ç«¯ç»„ä»¶å¥‘çº¦
```typescript
interface DictionaryService {
  // æŸ¥è¯
  lookup(word: string, language?: 'zh' | 'en'): Promise<DictEntry[]>;
  
  // æ¨¡ç³Šæœç´¢
  search(query: string, limit?: number): Promise<DictEntry[]>;
}

interface DictEntry {
  word: string;
  phonetic?: string;
  pos?: string;
  definitions: string[];
  examples?: string[];
}
```

### âœ” Definition of Done (DoD) - Dictionary
- [ ] `dict_master.db` æˆåŠŸæ‰“åŒ…åˆ° App å¹¶å¯è¯»å–
- [ ] ä¸­æ–‡è¯æ¡æŸ¥è¯¢è¿”å›æ­£ç¡®é‡Šä¹‰
- [ ] è‹±æ–‡è¯æ¡æŸ¥è¯¢è¿”å›æ­£ç¡®é‡Šä¹‰
- [ ] æ¨¡ç³Šæœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] é˜…è¯»å™¨é€‰è¯å¼¹çª—é›†æˆè¯å…¸åŠŸèƒ½

---

## 3. ç»Ÿä¸€çº¦æŸä¸å®ç°å¤‡æ³¨
- [MUST] ç¦æ­¢ç¡¬ç¼–ç æ•°å€¼ä¸ä»·æ ¼ï¼›æ‰€æœ‰é˜ˆå€¼ä¸å®šä»·ä»é…ç½®ä¸å®šä»·è¡¨è¯»å–ï¼ˆè§ 04ï¼‰ã€‚
- [MUST] å‰ç«¯å¥‘çº¦ç»Ÿä¸€ï¼š
  - æ‰€æœ‰ POST å¿…é¡»å¸¦ `Idempotency-Key`
  - æ‰€æœ‰ PATCH å¿…é¡»å¸¦ `If-Match`
  - æ‰€æœ‰ GET å»ºè®®å¸¦ `If-None-Match`ï¼ˆå¼±ç¼“å­˜å¯é€‰ï¼‰
- [MUST] RLSï¼šæ¯æ¬¡æ•°æ®åº“æ“ä½œè®¾ç½®ä¼šè¯å˜é‡å®ç°è¡Œçº§éš”ç¦»ã€‚
- [å¾…ç¡®è®¤/å¾…å®ç°] Reader/AI æµå¼ç»†èŠ‚ã€Shelves å®Œæ•´ CRUD ä¸å‰ç«¯é€‚é…å°†éšåç»­è¿­ä»£è¡¥é½ï¼Œå¹¶ä¸ 05 å¥‘çº¦ä¿æŒä¸€è‡´ã€‚



