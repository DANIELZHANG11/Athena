# PowerSync 同步规则配置 - Open Edition
# @see https://docs.powersync.com/usage/sync-rules
# @see 09 - APP-FIRST架构改造计划.md - Phase 1
#
# 使用 bucket_definitions 定义数据同步规则

bucket_definitions:
  # ============ 用户数据桶 ============
  # 每个用户有自己的数据桶，包含所有个人数据
  user_data:
    # 参数化桶 - 按用户 ID 分区
    parameters: SELECT token_parameters.user_id as user_id
    
    data:
      # 书籍元数据
      # 注意：is_image_based 在前端根据 is_digitalized 和 initial_digitalization_confidence 计算
      # is_image_based = !is_digitalized || (is_digitalized && confidence < 0.8)
      # is_digitalized = true 表示文字型（有文字层）
      - SELECT 
          id, user_id, title, author, 
          cover_image_key as cover_url,
          original_format as file_type, 
          size as file_size, 
          content_sha256, 
          minio_key as storage_key,
          metadata_confirmed,
          is_digitalized,
          initial_digitalization_confidence,
          (meta->>'page_count')::integer as page_count,
          ocr_status, 
          conversion_status, 
          converted_epub_key,
          created_at, updated_at, deleted_at
        FROM books
        WHERE user_id = bucket.user_id
      
      # 阅读进度
      - SELECT 
          id, user_id, book_id, device_id, 
          progress, last_position, last_location, finished_at, updated_at
        FROM reading_progress
        WHERE user_id = bucket.user_id
      
      # 阅读会话
      - SELECT 
          id, user_id, book_id, device_id,
          is_active, total_ms, created_at, updated_at
        FROM reading_sessions
        WHERE user_id = bucket.user_id
      
      # 笔记
      - SELECT 
          id, user_id, book_id, device_id,
          content, page_number, position_cfi, color,
          is_deleted, deleted_at, created_at, updated_at
        FROM notes
        WHERE user_id = bucket.user_id
      
      # 高亮
      - SELECT 
          id, user_id, book_id, device_id,
          text, page_number, position_start_cfi, position_end_cfi, color,
          is_deleted, deleted_at, created_at, updated_at
        FROM highlights
        WHERE user_id = bucket.user_id
      
      # 书签
      - SELECT 
          id, user_id, book_id, device_id,
          title, page_number, position_cfi,
          is_deleted, deleted_at, created_at, updated_at
        FROM bookmarks
        WHERE user_id = bucket.user_id
      
      # 书架
      - SELECT 
          id, user_id, name, description, cover_url,
          sort_order, is_deleted, deleted_at, created_at, updated_at
        FROM shelves
        WHERE user_id = bucket.user_id
      
      # 书架书籍关联
      # 2025-12-15: 已添加 user_id 列，现在可以通过 PowerSync 同步
      - SELECT 
          id, user_id, shelf_id, book_id, sort_order, added_at
        FROM shelf_books
        WHERE user_id = bucket.user_id
      
      # 用户设置
      - SELECT 
          id, user_id, device_id, settings_json, updated_at
        FROM user_settings
        WHERE user_id = bucket.user_id
