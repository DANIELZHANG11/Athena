# 雅典娜项目文档与代码交叉审计报告

报告目标

- 交叉验证《技术文档》《商业模型 V9.1》《设计标准》与当前代码库，明确一致点与不一致点，并分级问题严重度

项目概述

- 目标与范围：跨端电子书管理与阅读，支持 AI 对话/检索/OCR，统一设计与可访问性，支持 PWA 与桌面端
- 后端栈：FastAPI + PostgreSQL + Redis + Celery，S3 兼容对象存储（SeaweedFS 网关），契约与管理后台动态下发配置
- 前端栈：Vite + React + Tailwind v4（@import + @theme inline + @layer base），少量主页与基础 UI 组件，PWA 插件已接入
代码端现状（关键模块）

- 对象存储与上传
  - S3 客户端： api/app/storage.py:10-21 使用 boto3 ，默认 MINIO_ENDPOINT=seaweed:8333 指向 SeaweedFS 网关，保留 MINIO_* 前缀以兼容客户端库
  - 预签名上传/下载： api/app/storage.py:38-57 ，公共域名重写： api/app/storage.py:95-113
  - 书籍接口：上传初始化/完成、下载、转换、书架 CRUD 等（见下述 DB 对齐情况）
- 配额只读锁与上传限制
  - 全局配额检查： api/app/dependencies.py:6-74 动态读取 system_settings 与 user_stats ，计算 can_upload/is_readonly
  - 写操作阻断（403）： require_write_permission 应用于笔记/高亮等写接口， require_upload_permission 应用于上传初始化（如 api/app/books.py:85-98 、 api/app/notes.py:143-151 、 api/app/highlights ）
- OCR 与扣费风控
  - 页数阶梯与策略： api/app/ocr.py:61-83 （≤600:1；600–1000:2；1000–2000:3；>2000:拒绝）
  - 额度扣减与并发： api/app/ocr.py:85-103 （PRO 免费额度/月；并发通过 Redis ocr:active_jobs 与 ocr_concurrency_limit ）
  - 任务优先级： api/app/ocr.py:113-121 （简化映射为 9/7/5/1）
- 计费与产品
  - 钱包/Credits/兑换/IAP 验证（占位）： api/app/billing.py:23-253,255-383,385-458
  - 定价规则读取与后台 CRUD： api/app/pricing.py:17-56,70-190
- 管理后台动态配置
  - 系统设置、功能开关、服务提供者、Prompt 模板等： api/app/admin_panel.py:36-67,70-100,102-169,171-203,205-238,240-314
- 数据库迁移与脚本
  - 基线表： api/alembic/versions/0100_squash_baseline.py:36-49,59-70,72-187 （含 books/minio_key、conversion_jobs 等）
  - 增量： 0101 源 ETag、 0104 数字化分析列、 0105 AI/SRS/credit_products 与 users 语言/时区
  - V9.1 扩展脚本（非 Alembic）： api/scripts/apply_v9_schema.py:16-109 新增 user_stats/invites 、为 pricing_rules/users/ocr_jobs 增列并初始化 system_settings
- 前端主页与样式
  - 首页： web/src/pages/HomePage.tsx:13-26 ；CTA 按钮使用内联样式
  - 统一按钮组件存在： web/src/components/ui/Button.tsx:1-15 ，但首页未复用
  - 设计 Token： web/src/styles/figma.css:81-120,122-131,146-155 （@theme inline；字体栈与基础样式）
  - 导航栏 Liquid Glass： web/src/components/layouts/MainLayout.tsx:11-23
  - Vite PWA 与代理： web/vite.config.ts:4-28 （PWA 插件已接入；代理为 http://localhost ，未对齐文档中的 VITE_API_BASE_URL 与 HMR ws）
  - 可访问性 E2E： web/cypress/e2e/axe.cy.ts:3-14 存在；CI 仅在可选输入时执行
文档与实现一致性（核心点）

- 存储层
  - 技术文档声明 SeaweedFS（S3 网关），保留 MINIO_* 前缀兼容（ 雅典娜技术文档.md:30 ）；代码默认指向 SeaweedFS（ api/app/storage.py:10 ）；一致
  - 文档仍存在 MinIO/CDN 术语（如 雅典娜技术文档.md:60,160,550,1898-1906 ），命名历史与兼容性说明在技术文档中已提到；功能不受影响
- 只读锁（Trap）与上传限制（Hook）
  - 文档：超限进入只读锁，写操作返回 403 ，上传受限；一致实现： api/app/dependencies.py:76-84 ，相关接口均挂载
- OCR 阶梯扣费与单卡并发
  - 文档页数策略与 PRO 免费额度、全局并发 = 1；代码一致： api/app/ocr.py:61-83,101-103,113-121
- 设计系统与 Tailwind v4
  - 文档主张 @import "tailwindcss" + @theme inline + @layer base 与 FIGMA Token；前端已按此接入： web/src/index.css:1 、 web/src/styles/figma.css:81-120,122-131
  - 导航 Liquid Glass、A11Y 落地存在（ MainLayout.tsx:11-23 、 axe.cy.ts ）；一致
不一致汇总（按严重度）

- 严重
  - DB 字段缺失导致接口风险
    - OCR 读 books.meta.page_count ，但迁移未定义 meta 列（ api/app/ocr.py:31 vs api/alembic/versions 全部未见该列） → 运行时将始终回退 page_count=1 <font color="red">**[审查确认：属实。代码确实读取 meta 列，但数据库迁移脚本中未定义该列，将导致 500 错误。]**</font>
    - conversion_jobs 表迁移为 user_id 列（ api/alembic/versions/0100_squash_baseline.py:59-70 ），代码大量使用 owner_id 查询（如 api/app/books.py:295-305,316-377,806-839,842-858 ）→ 读写不匹配，接口可能 404 或空结果 <font color="red">**[审查确认：属实。代码使用 owner_id，迁移脚本定义 user_id，字段名不匹配。]**</font>
  - 内容实体表迁移缺口
    - 代码包含 notes/tags/highlights/note_tags/highlight_tags 相关 CRUD（ api/app/notes.py:143-355,357-538 ），但 Alembic 基线未创建这些表 → 部署不可用 <font color="red">**[审查确认：属实。Alembic 基线确实缺失这些核心业务表，需立即补全。]**</font>
- 中
  - 设计 Token 名称不一致
    - 组件引用 --color-system-blue/--color-label/--color-secondary-label （ web/src/components/ui/Button.tsx:10-13 、 web/src/components/layouts/NavItem.tsx:14-16 ），FIGMA Token 文件未定义这些变量（ web/src/styles/figma.css:81-120 ）→ 变量回退或无效，样式不稳定 <font color="red">**[审查确认：属实。figma.css 未定义这些系统色变量，需对齐。]**</font>
  - 开发代理与 HMR 未对齐设计标准
    - 文档建议 server.host=true 、 hmr.ws 与 VITE_API_BASE_URL 代理；当前 web/vite.config.ts:20-27 仅代理到 http://localhost ，未使用环境变量/HMR ws → 本地联调与桌面预览可能异常
  - 定价平台字段未贯通
    - 脚本已为 pricing_rules 增加 platform/sku_id （ api/scripts/apply_v9_schema.py:47-61 ），但 api/app/pricing.py 管理端 CRUD 与列表未读写/展示该字段（ api/app/pricing.py:77-99,102-176,179-190 ）→ 无法按平台差异化定价 <font color="red">**[审查确认：属实。API 确实未处理 platform 和 sku_id 字段。]**</font>
- 轻
  - 主页按钮未复用统一组件
    - 设计标准要求复用统一按钮组件；首页 CTA 使用内联按钮（ web/src/pages/HomePage.tsx:23 ），未用 Button.tsx （ web/src/components/ui/Button.tsx:1-15 ）
  - PWA 离线阅读未落地
    - 文档要求缓存书籍/封面与离线笔记/高亮；当前仅接入 VitePWA 插件（ web/vite.config.ts:3-19 ），没有 SW 与 IndexedDB 对应书籍缓存策略（ web/src/services/db.ts:1-31 仅 KV）
  - CI 质量门禁
    - 文档要求 axe 为门禁；当前 quality-gates.yml 仅在手动输入 run_e2e=true 时跑 E2E（ /.github/workflows/quality-gates.yml:69-82 ），未强制
与文档的命名/术语差异（非功能）

- SeaweedFS vs MinIO
  - 技术文档已明确用 SeaweedFS S3 网关，且为兼容继续沿用 MINIO_* 前缀（ 雅典娜技术文档.md:30,203 ）；代码采用 S3 客户端并默认指向 seaweed:8333 （ api/app/storage.py:10 ）
  - 契约与文案仍有 “发布到 MinIO/CDN”（ contracts/api/v1/admin.yaml:460 ）字样 → 建议统一术语，但属命名层面
一致性要点（确认无误）

- 只读锁与上传受限逻辑全面挂载（ dependencies.py:76-84 ；在 books/notes/highlights 路由使用）
- OCR 阶梯扣费策略与并发控制已实现；优先级队列简化但符合意图
- 管理端可动态下发系统设置/提供者/功能开关/Prompt 模板
- FIGMA 模式与字体栈、Liquid Glass、基础 A11Y 检查存在



## 解决方案：
严重不一致（必须优先）

- books 缺少 meta.page_count ，OCR页数始终退化为1
  - 方案
    - 新增 Alembic 迁移：为 books 增加 meta JSONB ，并在入库/分析阶段写入 page_count
    - 后端写入点
      - 上传完成后获取页数并固化： api/app/books.py:154-173,174-184 增加解析与 meta 更新
      - 深度分析与标准化： api/app/books.py:187-226 生成 digitalize_report_key 时补写 meta.page_count
      - OCR读取点固化： api/app/ocr.py:28-41 改为安全读取 meta->'page_count' （为空则按 1）
    - 文档同步：在《技术文档》“上传/解析”章节明确 books.meta.page_count 为 OCR 计费依据
    - 验证：构造 ≤600/800/1200页三类样本，观察 ocr_jobs.deduction_amount/strategy 是否正确写入
- conversion_jobs 列名不一致（迁移为 user_id ，代码用 owner_id ）
  - 方案
    - 后端统一使用 user_id ，逐处替换
      - 读取/写入点： api/app/books.py:286-306,308-314,316-377,769-804,806-839,842-858,878-993
    - 迁移维持 user_id 原样不改（避免历史表结构扩散）
    - 文档同步：将涉及转换任务的示例与表结构统一为 user_id
    - 验证：创建转换任务→列表→模拟完成，确保关联用户与输出键可读
- 内容实体表迁移缺口（notes/tags/highlights）
  - 方案
    - 新增 Alembic 迁移：创建 notes/tags/highlights 及其关联表 note_tags/highlight_tags ，列含 tsv 与版本/时间戳
    - 对齐现有实现的字段与索引
      - 参考写入/更新语句： api/app/notes.py:169-181,304-316,383-396,487-501,532-538
    - 文档同步：在《技术文档》数据库章节补齐表定义与索引
    - 验证：CRUD 全流程 + 搜索索引联动（index_* 调用返回正常）
中等不一致（次优先）

- 前端设计 Token 名称不一致（组件用 --color-system-blue/--color-label 等）
  - 方案
    - 短期：在 web/src/styles/figma.css 增加兼容别名映射（例如 --color-system-blue: var(--color-primary) 、 --color-label: var(--color-foreground) 、 --color-secondary-label: #717182 、 --color-system-fill: var(--color-input-background) ），不破坏现有 Token
    - 中期：逐步将组件引用改为 FIGMA Token（ --color-primary 、 --color-foreground 等），以设计系统为 SSOT
    - 文档同步：在《设计标准》加入“组件颜色 Token 映射表”
    - 验证：检查 Button/NavItem 渲染颜色在明暗模式均正确
- 开发代理与 HMR 未对齐
  - 方案
    - 更新 Vite server.proxy 使用 VITE_API_BASE_URL 环境变量；开启 hmr: { protocol: 'ws' } ；桌面端 Tauri devPath 与 CSP 对齐
      - 改动点： web/vite.config.ts:20-27 按《设计标准》第十三章调整
    - 文档同步：补充 .env 样例与多端调试说明
    - 验证：本地代理与桌面预览热重载正常，API 走统一基址
- 定价平台字段未贯通（platform/sku_id）
  - 方案
    - 后端： api/app/pricing.py:77-99,102-176,179-190 增加 platform/sku_id 的读写与返回
    - 契约：更新 contracts/api/v1/pricing.yaml 与 admin.yaml 字段
    - 文档同步：在《商业模型》“多平台定价”处标注两个字段
    - 验证：Admin 列表/创建/修改能看到并编辑平台与 SKU
轻微不一致（排期可并行）

- 主页 CTA 未复用统一 Button 组件
  - 方案：将 web/src/pages/HomePage.tsx:23 按《设计标准》替换为 Button 组件（variant=primary）
  - 文档同步：在《首页实现基线》标注“复用统一按钮组件”
  - 验证：视觉与动效一致，A11Y 聚焦环正确
- PWA 离线阅读未落地
  - 方案
    - Service Worker：缓存从 books.presign_get_source/presign 返回的书籍与封面；旁路缓存策略 + 版本化
    - IndexedDB：离线创建的笔记/高亮本地存储，恢复网络后后台同步
    - 文档同步：在《PWA 与离线支持》细化缓存清单与同步流程
    - 验证：离线可读已下载书籍；离线笔记/高亮在恢复网络后自动同步
- CI 门禁未强制
  - 方案：将 axe 与 E2E 冒烟设为质量门禁固定步骤；确保测试环境是 SeaweedFS/OpenSearch（参考 CICD验证规则.md:27-29 ）
  - 验证：PR 必须通过 axe 严重/高违规=0 与核心旅程 E2E
术语与命名统一

- SeaweedFS（S3 网关）为实际实现，保留 MINIO_* 环境变量前缀仅作兼容
  - 方案：统一文档与契约文案为“对象存储（S3 兼容，默认 SeaweedFS 网关）”，保留历史命名说明
  - 改动点： contracts/api/v1/admin.yaml:460 等文案；《技术文档》涉及 MinIO 直述改为“对象存储（S3 兼容）”
  - 验证：环境变量与运行时行为不受影响，认知一致
验证与回归控制

- 单元/集成
  - 后端：为 OCR 阶梯、只读锁、转换任务、邀请奖励、定价平台字段补充单测；对 books.meta.page_count 写入/读取做断言
- E2E
  - 旅程：登录→上传→OCR→高亮→AI 对话→主题切换→离线阅读
- 回滚策略
  - 数据库迁移向后兼容（IF NOT EXISTS）；代码改造逐步启用开关；CSS 通过别名映射避免视觉突变

  ## 方案修订

- 总体策略
  - 数据库层以现有迁移为准，新增列与改名走可回滚、向后兼容路径
  - 后端逐步启用，必要时短期双写/双读过渡，保证线上零停机
  - 前端颜色变量采用“按设计标准真实值补齐”的策略，避免语义混乱
  - 验证场景具体化，覆盖扣费、只读锁、对象存储、离线能力
1. books.meta 数据迁移与回填

- 数据迁移
  - DDL：为 books 增加 meta JSONB DEFAULT '{}'::jsonb （IF NOT EXISTS）
  - 索引： CREATE INDEX idx_books_meta_page ON books ((meta->>'page_count'))
- 数据回填
  - 回填策略优先“标记待分析 + 后台渐进补齐”，避免迁移长事务
  - 新增后台任务队列：
    - 扫描 books.meta->'page_count' IS NULL → 逐本读取对象（ minio_key ），快速探测 PDF 页数或 EPUB 章节数
    - 写回 meta.page_count ；记录 digitalize_report_key 便于审计
  - 入口联动：
    - 上传完成路径在已有轻量分析处补写页数（ api/app/books.py:154-173,174-184 ）
    - 深度分析路径也补写（ api/app/books.py:187-226 ）
- 验证
  - 随机抽样 N=100 本旧书目补齐率 ≥ 95%
  - 任务失败重试与死信队列观测；对无法解析的书籍写 meta.page_count=1 并标注 needs_manual=true
2. conversion_jobs 列名一致化（owner_id ↔ user_id）

- 现状核对
  - 先检查生产/测试数据库的实际列名（ user_id 还是 owner_id ）
- 决策树
  - 若已是 user_id ：仅代码统一改读写为 user_id
  - 若仍是 owner_id ：
    - 首选“重命名列迁移”： ALTER TABLE conversion_jobs RENAME COLUMN owner_id TO user_id
    - 如历史兼容需要保留两列：短期“加新列 user_id + 触发器镜像写入”，待稳定后删除旧列
- 过渡与验证
  - 双读策略：短期 SELECT 同时容忍两列，优先 user_id
  - 迁移前快照与回滚脚本；端到端流程：创建→列表→模拟完成→读 output_key 一致
3. notes/tags/highlights 表创建与约束

- 表与外键
  - notes(id, user_id, book_id, content, …) ； tags(id, user_id, name, …) ； highlights(id, user_id, book_id, …)
  - 关联表： note_tags(note_id, tag_id) 、 highlight_tags(highlight_id, tag_id)
  - 外键约束： ON DELETE CASCADE （notes/highlights 级联删除关联标签）
- 索引策略
  - 常用索引： idx_notes_user_updated(user_id, updated_at DESC) 、 idx_highlights_user_updated(user_id, updated_at DESC)
  - 搜索索引： GIN(tsv) ；组合查询需要的 (user_id, book_id, deleted_at IS NULL)
  - 去重与并发：必要唯一约束（如 (user_id, name) on tags，排除 deleted_at IS NOT NULL ）
- RLS（行级安全）
  - 开启 RLS；为每表添加 POLICY：仅 current_setting('app.user_id') 可读写自身数据
  - 后台任务/管理端使用 app.role='admin' 绕过 RLS（已有模式同 billing.webhook ）
- 验证
  - CRUD 覆盖；并发写入版本冲突（ETag）校验通过；删除级联与 RLS 生效
4. 前端 CSS Token：用真实值补齐而非别名映射

- 原则
  - 不采用 --color-system-blue: var(--color-primary) 这类语义混淆映射
  - 直接按《设计标准》定义缺失变量的 Light/Dark 实值
- 变量补齐（示例）
  - --color-system-blue: #007AFF ；暗色在 .dark 中设为 #0A84FF
  - --color-label: rgba(0,0,0,0.85) ； .dark --color-label: rgba(255,255,255,0.85)
  - --color-secondary-label 、 --color-system-fill 等同标准 1.2/1.5 节
- 组件迁移
  - 短期： Button/NavItem 等继续用现有变量名，配合新增真实值即刻生效
  - 中期：代码重构为统一 FIGMA Token（如 --color-primary ），并在设计标准提供映射表
- 验证
  - 明暗模式切换颜色正确；A11Y 对比度达标；全局按钮与导航项视觉一致
5. 验证场景具体化（含检查点）

- OCR 阶梯扣费
  - ✓ 构造 550 页 PDF → 预期 deduction_amount=1 ，策略 free_quota （PRO 且月度未用尽）
  - ✓ 构造 800 页 PDF → 预期 deduction_amount=2 ，策略 addon_quota
  - ✓ 构造 1500 页 PDF → 预期 deduction_amount=3 ，策略 addon_quota
  - ✓ 检查 ocr_jobs.page_count/deduction_amount/deduction_strategy 正确
- 只读锁与上传限制
  - 超限用户：创建笔记/高亮返回 403； upload_init 返回 403；已下载书籍可读
- 对象存储
  - presigned_put/get 可用；公开域名重写生效；ETag 回写并去重成功
- 主页与设计
  - CTA 按钮风格与 Token 一致；导航 Liquid Glass 与焦点环正确；axe “serious/critical”=0
6. PWA 离线缓存与同步策略

- 缓存键设计
  - 书籍与封面： book-${bookId}-${etag} ，防旧版本残留
  - 预览/派生资产独立前缀： converted-${bookId}-${etag} 等
- 清理策略
  - LRU（限制存储上限，如 1GB），超限逐出最久未访问；提供“离线管理”页面手动删除
- 离线写入与冲突
  - IndexedDB 持久化离线 notes/highlights 队列，记录 base_version
  - 重连同步采用乐观并发：若后端版本变化，生成 note_versions 分支保留用户离线编辑；UI 提示“合并/保留两个版本”
- 验证
  - 断网场景可读缓存书籍；创建笔记后重连自动同步；版本冲突产生版本记录并可回滚
风险与回滚

- 数据库迁移
  - 全部 IF NOT EXISTS 与在线、短事务操作；大批量回填走后台任务，支持重试
- 列名改造
  - 先检查现网表结构；如需改名，提供回滚脚本与短期双写保护
- 前端颜色
  - 直接定义实值不会破坏现有 Token；视觉回归通过 axe/快照比对