**模型概述**
- 名称：雅典娜商业模型 V9.1（动态配置 + 读写分离锁 + 硬件风控）
- 目标：构建一套针对全球市场的“高留存、高转化”商业闭环。通过“免费同步”降低准入门槛以最大化 DAU，利用“只读锁”与“权益分层”精准收割重度用户，实现用户价值与平台收益的完美平衡。
- **核心原则：所有数值（价格、额度、阈值、汇率、提示语、阶梯规则）必须通过 Admin 后台动态下发，严禁硬编码。**

**设计哲学（The Trap & The Hook）**
- **同步免费，上传受限（The Hook）**：
  - 承诺“多端同步”功能本身永久免费。
  - **限制点**：同步的前提是“上传到云端”。一旦用户达到免费阈值（50本或1GB），**禁止再上传新书**。
  - **逻辑闭环**：
    - **新设备**：无法上传新书，但可下载并阅读云端已有的书籍（含元数据、笔记、AI记录）。
    - **旧设备**：已上传的书籍可继续阅读，但无法上传新书。
- **超限熔断与只读锁（The Trap）**：
  - 当用户达到阈值（50本/1GB）且未付费时，触发“熔断机制”。
  - **写操作阻断（Soft Lock）**：
    - **本地行为**：用户在本地终端可能仍能进行笔记/高亮操作（取决于前端实现）。
    - **云端拒收**：当这些操作尝试同步到云端时，后端接口（`POST /api/v1/notes` 等）将返回 `403 Forbidden`。
    - **用户感知**：前端捕获错误并提示“同步失败：空间已满，您的笔记仅保存在本地，请升级会员以保障数据安全”。
  - **允许阅读**：已下载到本地的书籍可继续阅读，不影响基础体验。
  - **允许AI**：只要账户内有 Credits（含月度赠送），仍可进行 AI 对话、翻译（消耗库存 Credits）。
- **硬件底线（The Cost）**：
  - 鉴于服务器仅有单卡 RTX 3060 (12G)，算力极其有限。
  - **严禁无限量**：OCR 必须严格执行“按本计费 + 页数阶梯风控”的双重限制。

**资源与货币体系（全配置化）**
- **通用信用点（Credits）**
  - 用途：AI 对话（RAG/闲聊）、翻译。
  - 兑换：后台配置汇率（如 ¥1 = 400 credits）。
- **OCR 额度（按“本”计费，按“页”风控）**
  - **预处理与元数据解析**：
    - **格式判定**：上传完成后，后端自动识别文件 MIME 类型。
    - **PDF 处理**：直接提取页数 (`page_count`) 并写入元数据；前端使用 PDF.js 渲染。
    - **非标准格式转换**：对于非 EPUB/PDF 格式（如 MOBI/TXT），调用 `Calibre` 转换为 EPUB；转换后提取页数并写入元数据；前端使用 EPUB.js 渲染。
    - **元数据固化**：所有书籍必须在 `books` 表中拥有准确的 `page_count` 字段，作为 OCR 计费依据。
  - **核心策略**：基于书籍页数（Metadata）决定消耗的“次数”。
    - **<= 600页**：消耗 1 次“标准额度”（优先扣除免费额度，无免费额度则扣除加油包额度）。
    - **600 - 1000页**：消耗 2 次“加油包额度”（**不可**使用免费额度，强制扣除付费加油包次数）。
    - **1000 - 2000页**：消耗 3 次“加油包额度”（**不可**使用免费额度，强制扣除付费加油包次数）。
    - **> 2000页**：不支持 OCR 或需人工处理（配置项 `ocr_max_pages`）。
  - **调度策略（单卡优化）**：
    - **书籍串行**：全局任务队列中，同一时间**仅允许一本电子书**进入 GPU 处理流程（避免显存溢出）。
    - **页级并行**：对当前处理的这一本书，利用 12G 显存进行 Batch 处理（如一次并行识别 10 页）。
    - **优先级队列（Celery Priority）**：
      1. **P0**：付费会员 + 付费加油包任务
      2. **P1**：付费会员 + 免费赠送额度任务
      3. **P2**：免费会员 + 付费加油包任务
      4. **P3**：免费会员 + 免费体验任务（如有）

**产品层级**
- **免费层（Free）**
  - 阈值：`free_book_limit` (默认50本) 或 `free_storage_limit` (默认1GB)。
  - 权益：全端免费同步（在阈值内）。
  - 超限后果：触发“只读锁”（禁止上传、禁止笔记同步）。
  - **裂变奖励（邀请码机制）**：
    - 机制：老用户生成唯一邀请码；新用户注册后，在**个人中心（User Profile）**显眼位置填入邀请码。
    - 触发：填入校验通过后，**实时**触发双方奖励更新。
    - 奖励：双方均获得 `invite_bonus_storage` (500MB) **且** `invite_bonus_books` (5本)。
    - 叠加规则：奖励额度永久叠加至基础额度之上。例如邀请 2 人后，总额度变为 (50+10)本 / (1GB+1GB)。**熔断判定仍遵循“先达到者”原则**。
- **Pro 会员（Membership）**
  - 定价：`price_membership_yearly_first` (¥58/首年)；`price_membership_yearly_renew` (¥98/续费)。
  - 权益：
    - **解除“只读锁”**：恢复无限上传、无限笔记同步权限。
    - **月度赠送**：每月自动获赠 `monthly_gift_credits` (500点) + `monthly_gift_ocr_count` (3次标准额度)。**月底清零，不累计**。
    - **优先队列**：享受 P0/P1 级 OCR 调度优先级。
- **加油包（Add-ons）**
  - AI 加油包：`price_addon_ai` (¥9.9) → `addon_ai_credits` (4000点)。
  - OCR 加油包：`price_addon_ocr` (¥8.8) → `addon_ocr_count` (10次标准额度)。
  - **购买逻辑**：用户在购买时可选择**数量（Quantity）**，总价 = 单价 * 数量。

**运营配置化（Admin 核心需求）**
**所有以下参数必须在 Admin 面板可读写，并实时生效：**
1.  **定价与汇率（多平台策略）**：
    - `wallet_exchange_rate`: 钱包余额到 Credits 汇率。
    - `pricing_rules`: 需扩展 `platform` 字段 (`web`, `ios`, `android`)。
    - **苹果税/谷歌税解决方案**：
      - **Web 端**：保持原价（¥58/¥9.9/¥8.8）。
      - **iOS/Android 端**：配置独立价格（如 ¥78/¥12/¥12），溢价覆盖 30% 佣金成本。
      - **合规策略**：App 内**只字不提** Web 端充值，严禁引导。依靠外部营销（邮件/公众号）触达用户。
2.  **加油包配置（SKU 管理）**：
    - `addon_packages`: JSON 列表，定义所有可售卖的加油包 SKU。
      - 字段：`id`, `name`, `type` (OCR/AI), `amount` (次数/点数), `price`, `platform` (web/ios)。
      - 功能：Admin 可随时增删改 SKU，前端动态渲染商品列表。
3.  **阈值与限制**：
    - `free_book_limit`: 免费用户书籍数上限。
    - `free_storage_limit`: 免费用户存储空间上限 (MB)。
    - `ocr_page_thresholds`: OCR 页数阶梯配置 (如 `{"standard": 600, "double": 1000, "triple": 2000}`)。
    - `invite_bonus_storage`: 邀请赠送空间。
    - `invite_bonus_books`: 邀请赠送本数。
4.  **风控参数**：
    - `credit_overdraft_limit`: 允许透支的 Credits 额度。
    - `ocr_concurrency_limit`: OCR 书籍级并发数（默认1）。
5.  **提示语模板**：
    - `msg_storage_full`: "您的空间已满，无法上传新书..."
    - `msg_sync_failed_quota`: "同步失败：空间已满，您的笔记仅保存在本地..."
    - `msg_ocr_large_book`: "该书超过600页，需消耗2次加油包额度..."

**引擎逻辑（扣费与风控）**
- **存储检查**：每次调用 `upload_init` 前，必须检查 `current_usage` vs `total_quota` (基础+奖励)。
- **写入检查**：每次调用 `create_note` / `create_highlight` / `update_shelf` 前，必须检查是否处于“超限状态”。
- **OCR 扣费（复杂逻辑）**：
  - **前置检查**：读取书籍页数 `page_count`。
  - **策略判定**：
    - `<= 600`：尝试扣除 `free_quota` (1次) -> 失败则扣除 `addon_quota` (1次)。
    - `600 < p <= 1000`：**直接**扣除 `addon_quota` (2次)。
    - `1000 < p <= 2000`：**直接**扣除 `addon_quota` (3次)。
  - **余额不足**：返回前端提示购买加油包。

**技术落地映射表（Existing vs New）**

| 模块 | 功能点 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **Database** | `system_settings` 表 | **Existing** | 已存在，需增加上述新的 Key。 |
| **Database** | `pricing_rules` 表 | **Modify** | 需增加 `platform` 字段。 |
| **Database** | `user_stats` 表 | **New** | 需新建，用于实时缓存用户用量（storage/books）。 |
| **Database** | `invites` 表 | **New** | 需新建，用于记录裂变关系与奖励状态。 |
| **Database** | `users` 表 | **Modify** | 需扩展字段记录 `expire_at` 和 `monthly_gift_reset_at`。 |
| **API** | `admin_panel.py` | **Existing** | 接口已就绪，需适配新的配置 Key。 |
| **API** | `books.py` | **Modify** | 需增加 `upload_init` 的配额检查逻辑。 |
| **API** | `notes.py` | **Modify** | 需增加写操作的 `Soft Lock` 检查逻辑。 |
| **API** | `ocr.py` | **Modify** | 需重构为支持阶梯扣费、优先级队列和 Redis 锁。 |
| **API** | `billing.py` | **Modify** | 需接入 IAP 验证逻辑 (`verifyReceipt`) 和 Webhook 处理。 |
| **Task** | `scheduler` | **New** | 需新增定时任务：清理过期会员、重置月度赠送。 |

**数据库 Schema 定义（详细字段）**

1.  **`user_stats` (新增表 - 用户用量缓存)**
    *   `user_id` (UUID, PK): 关联 `users.id`。
    *   `storage_used` (BigInt, Default 0): 当前已用存储空间（字节）。
    *   `book_count` (Integer, Default 0): 当前已上传书籍数量。
    *   `invite_count` (Integer, Default 0): 成功邀请的人数。
    *   `extra_storage_quota` (BigInt, Default 0): 额外获得的存储额度（来自邀请/活动）。
    *   `extra_book_quota` (Integer, Default 0): 额外获得的书籍额度。
    *   `updated_at` (Timestamp): 最后更新时间。

2.  **`invites` (新增表 - 裂变记录)**
    *   `id` (UUID, PK): 主键。
    *   `inviter_id` (UUID, FK): 邀请人 ID。
    *   `invitee_id` (UUID, FK, Nullable): 被邀请人 ID（注册成功后回填）。
    *   `invite_code` (String, Unique): 邀请码（如 "ATHENA888"）。
    *   `status` (String): 状态 (`pending`, `completed`)。
    *   `reward_granted` (Boolean, Default False): 奖励是否已发放。
    *   `created_at` (Timestamp): 创建时间。
    *   `completed_at` (Timestamp, Nullable): 完成时间。

3.  **`pricing_rules` (修改表 - 多平台定价)**
    *   **[新增]** `platform` (String, Default 'web'): 适用平台 (`web`, `ios`, `android`)。
    *   **[新增]** `sku_id` (String, Nullable): 对应 App Store / Google Play 的 Product ID。

4.  **`users` (修改表 - 会员状态)**
    *   **[新增]** `membership_expire_at` (Timestamp, Nullable): 会员过期时间。
    *   **[新增]** `monthly_gift_reset_at` (Timestamp, Nullable): 下次月度赠送重置时间。
    *   **[新增]** `free_ocr_usage` (Integer, Default 0): 本月已用免费 OCR 次数。

5.  **`ocr_jobs` (修改表 - 审计与扣费)**
    *   **[新增]** `page_count` (Integer): 书籍总页数。
    *   **[新增]** `deduction_strategy` (String): 扣费策略 (`free_quota`, `addon_quota`).
    *   **[新增]** `deduction_amount` (Integer): 扣除的次数（1, 2, 3）。