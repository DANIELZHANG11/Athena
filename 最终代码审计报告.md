# 雅典娜计划：最终代码审计报告 (Final Code Audit Report)

**审计时间**: 2025-11-19
**审计对象**: 现有后端代码库 (api/app)
**审计基准**: 《雅典娜计划：生产级架构终极审查与整改方案 (V2)》

---

## 1. 审计概览 (Executive Summary)

经过对现有代码的深度核查，确认**整改方案中的大部分关键安全与架构问题已得到修复**。特别是涉及资金安全的“双花漏洞”和涉及数据库稳定性的“运行时 DDL”已彻底解决。

然而，**实时协同 (Yjs)** 和 **搜索同步可靠性** 两个核心功能模块**尚未达到生产标准**，仍处于不可用或高风险状态。

| 模块 | 审查项 | 状态 | 评级 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **Billing** | 双花漏洞 (Double Spending) | ✅ **已修复** | **Pass** | 使用了 `UPDATE ... RETURNING` 原子操作。 |
| **Auth** | 运行时 DDL | ✅ **已修复** | **Pass** | `auth.py` 中已移除所有 `CREATE TABLE` 语句。 |
| **Admin** | 权限后门 | ✅ **已修复** | **Pass** | `admin.py` 已移除 `DEV_MODE` 绕过逻辑。 |
| **Services** | 核心服务层 | ✅ **已实现** | **Pass** | `services.py` 已集成 PaddleOCR, BGE-M3, EdgeTTS。 |
| **Tasks** | 异步任务 | ✅ **已优化** | **Pass** | 实现了 SRS 生成任务，并调用了真实服务。 |
| **WebSockets** | **Yjs 协同协议** | ❌ **未修复** | **Critical** | 仍使用 JSON 协议，无法支持 Yjs 前端协同。 |
| **Search** | **同步可靠性** | ❌ **未修复** | **High** | 仍使用 `threading` + `urllib`，无重试机制。 |

---

## 2. 详细审计发现 (Detailed Findings)

### ✅ 已修复的核心问题 (Resolved Issues)

#### 1. 计费原子性 (Billing Atomicity)
*   **文件**: `api/app/billing.py`
*   **验证**: 代码已更新为：
    ```python
    UPDATE credit_accounts SET balance = balance - :amt ... WHERE ... AND balance >= :amt RETURNING balance
    ```
*   **结论**: 有效防止了并发扣费导致的余额负数问题。

#### 2. 数据库 DDL 清理 (DDL Cleanup)
*   **文件**: `api/app/auth.py`, `api/app/ws.py`
*   **验证**: `verify_email_code` 和 `websocket_endpoint` 中不再包含 `CREATE TABLE IF NOT EXISTS` 语句。
*   **结论**: 消除了运行时修改数据库结构的风险，符合生产规范。

#### 3. 服务层实现 (Service Layer Integration)
*   **文件**: `api/app/services.py`
*   **验证**: 文件已创建，并包含了 `PaddleOCREngine`, `LocalEmbedder`, `EdgeTTSEngine` 的真实实现代码。
*   **结论**: 摆脱了纯 Mock 状态，具备了真实的业务处理能力。

---

### ❌ 仍需紧急修复的问题 (Outstanding Critical Issues)

#### 1. 实时协同完全失效 (Yjs Protocol Mismatch)
*   **严重等级**: **Critical (P0)**
*   **文件**: `api/app/ws.py`
*   **问题描述**: 前端 `Yjs` 库通过 WebSocket 发送的是 **二进制 (Binary)** 的 CRDT 更新数据。但后端 `ws.py` 依然尝试使用 `json.loads(data)` 解析消息。
*   **后果**: 前后端协议不匹配，WebSocket 连接建立后会立即报错，**所有多人协作、笔记同步功能将无法使用**。
*   **整改建议**:
    *   引入 `ypy-websocket` 库。
    *   重写 `websocket_endpoint` 以处理二进制流，并对接 Yjs 的 `YRoom` 进行状态合并。

#### 2. 搜索同步不可靠 (Search Sync Unreliability)
*   **严重等级**: **High (P1)**
*   **文件**: `api/app/search_sync.py`
*   **问题描述**: 代码仍使用 `threading.Thread` 启动后台线程，并使用 `urllib` 发送 HTTP 请求。
    ```python
    threading.Thread(target=_put, args=(url, doc), daemon=True).start()
    ```
*   **后果**:
    *   **数据丢失**: 如果 OpenSearch 暂时不可用（如重启、网络波动），请求失败后没有重试机制，数据将永久丢失。
    *   **不可监控**: 线程崩溃无法被 Celery 或 Sentry 捕获。
*   **整改建议**:
    *   废弃 `threading` 模式。
    *   将 `index_note`, `index_book` 等函数改写为 Celery Task (`@shared_task`)。
    *   配置 `autoretry_for=(Exception,)` 以确保最终一致性。

---

## 3. 最终结论 (Conclusion)

代码库已跨越了“原型”阶段，核心的资金安全和架构规范已达标。但为了支撑 **“知识内化”** 这一核心价值，必须立即解决 **WebSockets (Yjs)** 的协议兼容性问题，否则产品的核心体验（协同阅读、笔记同步）将无法闭环。

**建议立即执行以下操作：**
1.  重构 `ws.py` 以支持 Yjs 二进制协议。
2.  将 `search_sync.py` 迁移至 Celery 任务队列。
