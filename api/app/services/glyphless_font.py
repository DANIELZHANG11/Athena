"""
GlyphLess Font for Transparent Text Layer

无字形字体，用于创建透明文字层（完全复制自 OCRmyPDF-EasyOCR）
"""

import importlib.resources
from pikepdf import Dictionary, Name, Pdf

# 从 OCRmyPDF-EasyOCR 复制的 GlyphLess Font 二进制数据
# 这是一个最小化的 TrueType 字体，没有任何字形（glyph）
# 用于创建透明的、可搜索的文字层
GLYPHLESS_FONT = b'\x00\x01\x00\x00\x00\x0c\x00\x80\x00\x03\x00 cmap\x00\x00\x00\x8c\x00\x00\x00\x1aOS/2\x00\x00\x00\xa8\x00\x00\x00`head\x00\x00\x01\x08\x00\x00\x006hhea\x00\x00\x01@\x00\x00\x00$hmtx\x00\x00\x01d\x00\x00\x00\x08loca\x00\x00\x01l\x00\x00\x00\x06maxp\x00\x00\x01t\x00\x00\x00 name\x00\x00\x01\x94\x00\x00\x00\xc5post\x00\x00\x02\\\x00\x00\x00 \x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\xbe\xd0_\x0f<\xf5\x00\x0b\x08\x00\x00\x00\x00\x00\xd0\xd2\x9c]\x00\x00\x00\x00\xdb\xdf\x0c\xd4\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x05\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00GlyphLessFont\x00\x00\x00\x00\x02\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe8\x00\x00\x03\xe8\x00\x00\x00d\x00\x00\x00d\x00\x00\x00d\x00\x00\x03\xe8\x00\x00\x03\xe8\x00\x00\x00\x00\x00\x02\x03\xe8\x00\x00\x03\xe8\x00\x00\x03\xe8\xff\xff\x00P\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf4\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x01\x90\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x12\x00\x00\x00\x00\x00\x02\x00\x00\x00\x01\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x01\x00\x00\x00\x02\x00\x04\x00\x01\x00\x00\x00 \x00\x03\x00\x01\x00\x00\x00$\x00\x06\x00\x16\x00\x00GlyphLessFont\x00\x00\x00\x00\x00R\x00e\x00g\x00u\x00l\x00a\x00r\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00G\x00l\x00y\x00p\x00h\x00L\x00e\x00s\x00s\x00F\x00o\x00n\x00t\x00\x00\x00\x00\x00V\x00e\x00r\x00s\x00i\x00o\x00n\x00 \x001\x00.\x000\x00\x00\x00\x00\x00\x00\x00\x00\x00G\x00l\x00y\x00p\x00h\x00L\x00e\x00s\x00s\x00F\x00o\x00n\x00t\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x80'

CHAR_ASPECT = 2  # 字符宽高比


def register_glyphlessfont(pdf: Pdf):
    """
    在 PDF 中注册 GlyphLess Font
    
    创建一个透明的、无字形的字体，用于 OCR 文字层。
    这个字体的所有字符都没有视觉形状，但可以被选中和搜索。
    
    完全复制自 OCRmyPDF-EasyOCR 的实现。
    
    Args:
        pdf: pikepdf.Pdf 对象
    
    Returns:
        字体对象的间接引用
    """
    PLACEHOLDER = Name.Placeholder

    basefont = pdf.make_indirect(
        Dictionary(
            BaseFont=Name.GlyphLessFont,
            DescendantFonts=[PLACEHOLDER],
            Encoding=Name("/Identity-H"),
            Subtype=Name.Type0,
            ToUnicode=PLACEHOLDER,
            Type=Name.Font,
        )
    )
    
    cid_font_type2 = pdf.make_indirect(
        Dictionary(
            BaseFont=Name.GlyphLessFont,
            CIDToGIDMap=PLACEHOLDER,
            CIDSystemInfo=Dictionary(
                Ordering="Identity",
                Registry="Adobe",
                Supplement=0,
            ),
            FontDescriptor=PLACEHOLDER,
            Subtype=Name.CIDFontType2,
            Type=Name.Font,
            DW=1000 // CHAR_ASPECT,
        )
    )
    
    basefont.DescendantFonts = [cid_font_type2]
    cid_font_type2.CIDToGIDMap = pdf.make_stream(b"\x00\x01" * 65536)
    
    basefont.ToUnicode = pdf.make_stream(
        b"/CIDInit /ProcSet findresource begin\n"
        b"12 dict begin\n"
        b"begincmap\n"
        b"/CIDSystemInfo\n"
        b"<<\n"
        b"  /Registry (Adobe)\n"
        b"  /Ordering (UCS)\n"
        b"  /Supplement 0\n"
        b">> def\n"
        b"/CMapName /Adobe-Identify-UCS def\n"
        b"/CMapType 2 def\n"
        b"1 begincodespacerange\n"
        b"<0000> <FFFF>\n"
        b"endcodespacerange\n"
        b"1 beginbfrange\n"
        b"<0000> <FFFF> <0000>\n"
        b"endbfrange\n"
        b"endcmap\n"
        b"CMapName currentdict /CMap defineresource pop\n"
        b"end\n"
        b"end\n"
    )
    
    font_descriptor = pdf.make_indirect(
        Dictionary(
            Ascent=1000,
            CapHeight=1000,
            Descent=-1,
            Flags=5,  # Fixed pitch and symbolic
            FontBBox=[0, 0, 1000 // CHAR_ASPECT, 1000],
            FontFile2=PLACEHOLDER,
            FontName=Name.GlyphLessFont,
            ItalicAngle=0,
            StemV=80,
            Type=Name.FontDescriptor,
        )
    )
    
    font_descriptor.FontFile2 = pdf.make_stream(GLYPHLESS_FONT)
    cid_font_type2.FontDescriptor = font_descriptor
    
    return basefont
