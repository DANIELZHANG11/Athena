
## **《“雅典娜计划”UI/UX设计系统 v4.0》**

### **设计哲学:**
静谧的智慧 – 极简呈现，按需浮现。

### **核心目标:**
本规范为“雅典娜计划”全平台应用提供统一、可执行标准。严格遵循前后端分离，无状态认证，兼容 React/Vite/TypeScript。AI 生成代码一致性 95%+。

### **技术栈（新增）**
- Web/桌面：Tailwind CSS v4 + Framer Motion + Radix UI（对话框/选择/弹层等）。
- 辅助库：lucide-react（图标）、cmdk（命令面板）、embla-carousel-react（轮播）、recharts（图表）、react-day-picker（日历）、vaul（抽屉）、sonner（toast）、input-otp（验证码）、react-resizable-panels（可调整面板）。
- 移动端原生：遵循平台原生（SwiftUI/Jetpack Compose）；React Native采用 NativeWind + Moti/Reanimated 实现一致动效与样式。
- 统一规范：组件尺寸、色彩与动效曲线在各端保持一致，作为设计系统的单一事实来源。
 - Tailwind v4 用法：统一使用 `@import "tailwindcss"` + `@theme inline` + `@layer base`；设计 Token 在 `web/src/styles/figma.css` 定义并与组件样式贯通。

### **移动端 APP 适配规范（完整）**
- 技术适配：React Native + NativeWind（样式）+ Moti/Reanimated（动效）+ React Navigation（导航）+ Gesture Handler（手势）。
- Liquid Glass：顶部/底部栏可使用 BlurView（Expo/React Native Blur），不支持 saturate 时以半透明纯色降级，保证对比度 AA。
- 字体与回退：
  - iOS：系统 SF Pro；中文 `PingFang SC`；回退 `Noto Sans SC/Source Han Sans SC`（OFL）。
  - Android：系统 Roboto；中文 `Noto Sans SC`；回退 `Source Han Sans SC`（OFL）。
  - 不捆绑付费商用字体；统一设计 Token 与 Web 一致。
- 组件映射（Web → RN 等价）：
  - Dialog/Sheet/Drawer：Radix UI → `react-native-modal` / `react-navigation` Stack/Drawer + `react-native-gesture-handler`。
  - Popover/Tooltip：Radix UI → `react-native-popover-view` / `react-native-tooltip-menu`。
  - Select/Dropdown：Radix Select/Dropdown → `react-native-picker-select` / `react-native-paper` Menu。
  - Accordion/Collapsible：Radix → `react-native-collapsible` / `react-native-reanimated` 自定义。
  - Tabs/Menubar/Navigation Menu：Radix → `@react-navigation/material-top-tabs` / Bottom Tabs。
  - Checkbox/Radio/Switch：Radix → `react-native-paper` 或自定义 + `react-native-aria`。
  - Scroll Area/Resizable Panels：Radix → `react-native-reanimated` 滑块/面板（如 `react-native-bottom-sheet`、`react-resizable-panels` 无 RN 版，用 Reanimated 实现）。
  - Carousel：`embla-carousel-react` → `react-native-reanimated-carousel`。
  - Chart：`recharts`（Web）→ `react-native-svg` + Victory/Skia Charts（RN）。
  - Calendar：`react-day-picker`（Web） → `react-native-calendars`。
  - Toast：`sonner`（Web） → `react-native-toast-message` 或 `react-native-root-toast`。
  - OTP：`input-otp`（Web） → `react-native-otp-input` / `react-native-otp-textinput`。
  - Command Palette（cmdk）：移动端以搜索/命令页呈现（Modal + 列表），键盘快捷替代为触控入口。
- 导航与布局：
  - 移动端：底部 Tab Bar（5 个核心入口，不承载动作）；页面推送式导航；抽屉用于全局菜单。
  - 断点与 Token 与 Web 一致；触达区域 ≥ 44x44px；列表/阅读器启用虚拟滚动。
- 动效与性能：
  - 默认 `--motion-easing-default` 转换为 Reanimated/Moti 曲线；支持 `prefers-reduced-motion` 等效用户设置降级为淡入淡出。
  - 大型阴影与模糊在低端设备降级；图片懒加载与占位；首屏 < 2s 目标。
- 可访问性（A11Y）：
  - VoiceOver/TalkBack 读屏顺序与焦点管理；触控与键盘导航并存（物理键盘场景）。
  - 组件提供 `accessibilityLabel`、`accessibilityRole`；对比度遵循 WCAG AA。
- 统一设计 Token：半径、间距、色彩、动效时长与曲线在 RN 端复用；通过 NativeWind 变量或 ThemeProvider 下发。

---

### **第一章：色彩系统（对标 Apple HIG）**
> 一致性声明：色彩命名与取值以当前 FIGMA 设计 Tokens 为准；如有差异，以 FIGMA 为唯一 SSOT 并在本文件实时同步。

#### **1.1 系统背景色（命名与值对齐）**
-   `systemBackground`: Light `#FFFFFF`, Dark `#000000`
-   `secondarySystemBackground`: Light `#F2F2F7`, Dark `#1C1C1E`
-   `tertiarySystemBackground`: Light `#FFFFFF`, Dark `#2C2C2E`

#### **1.2 文本/标签色（命名与值对齐）**
-   `label`: Light `rgba(0,0,0,0.85)`, Dark `rgba(255,255,255,0.85)`
-   `secondaryLabel`: Light `rgba(60,60,67,0.6)`, Dark `rgba(235,235,245,0.6)`
-   `tertiaryLabel`: Light `rgba(60,60,67,0.3)`, Dark `rgba(235,235,245,0.3)`
-   `quaternaryLabel`: Light `rgba(60,60,67,0.18)`, Dark `rgba(235,235,245,0.18)`

#### **1.3 强调色（Tint Color）**
-   `systemBlue`（雅典娜主强调色，所有可交互元素统一使用）：Light `#007AFF`, Dark `#0A84FF`
-   `systemGreen`: Light `#34C759`, Dark `#30D158`
-   `systemRed`: Light `#FF3B30`, Dark `#FF453A`
-   `systemPurple`（AI专属点缀，仅用于非交互性品牌标识）：Light `#5856D6`, Dark `#5E5CE6`

#### **1.4 笔记高亮色板**
-   `highlightYellow`: `#FFCC00`
-   `highlightGreen`: `#34C759`
-   `highlightBlue`: `#007AFF`

#### **1.5 分隔与填充**
-   `separator`: Light `rgba(60,60,67,0.29)`, Dark `rgba(84,84,88,0.6)`
-   `systemFill`: Light `rgba(120,120,128,0.2)`, Dark `rgba(120,120,128,0.36)`

---

### **第二章：字体系统（HIG 合规）**
> 一致性声明：字体栈与字号层级以 FIGMA 标注为准；中文/英文统一基线与行高在 FIGMA 更新后同步。

#### **2.1 核心字体选型**
-   **UI系统字体栈（含中文回退，不捆绑商用字体）**：
    ```css
    /* 统一 UI 字体栈（Web） */
    --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
               "PingFang SC", "Microsoft YaHei", "Noto Sans SC", "Source Han Sans SC",
               "Noto Sans", sans-serif;
    ```
-   **阅读正文字体（开源可商用）**：Source Serif 4（默认）
-   **可选阅读字体（用户可切换）**：Noto Serif、Literata、系统内置 Serif 字体（平台自适应）

#### **2.2 文本样式**
-   `.typography-large-title`: 系统字体栈, 2.125rem, 700, 1.2
-   `.typography-title-1`: 系统字体栈, 1.75rem, 600, 1.25
-   `.typography-body`: Source Serif 4, 1.125rem, 400, 1.7
-   `.typography-caption`: 系统字体栈, 0.75rem, 400, 1.3

#### **2.3 阅读器设置（新增）**
-   必须提供“字体选择器”：在多种开源可商用字体与系统内置字体之间切换；预览即时渲染，持久化到用户偏好。

---

### **第三章：间距与布局**
> 一致性声明：间距与栅格断点以 FIGMA 布局网格为准；组件容器外边距与内边距按 FIGMA 注释执行。

#### **3.1 间距 Token**
-   `--space-xxs`: 0.125rem (2px)
-   `--space-s`: 0.5rem (8px)
-   `--space-m`: 1rem (16px)
-   `--space-l`: 1.5rem (24px)
-   `--space-xl`: 2rem (32px)
-   `--space-xxl`: 3rem (48px)

#### **3.2 布局系统**
-   **断点:** `mobile` (<640px), `pad` (640-1024px), `desktop` (>1024px)。
-   **栅格:** 12 列, gutter `--space-m`。
-   **布局示例:**
    -   **Mobile:** 垂直滚动。
    -   **Pad:** `grid-template-columns: 1fr 3fr;` (侧导航 + 内容)。
    -   **Desktop:** `grid-template-columns: 1fr 2fr 3fr;` (书架 + 列表 + 详情)。

---

### **第四章：视觉元素**
> 一致性声明：圆角/阴影/图标尺寸与色值以 FIGMA Tokens 为准；任何偏差以 FIGMA 为唯一 SSOT。

#### **4.1 圆角**
-   `--radius-s`: 6px (输入框)
-   `--radius-m`: 10px (卡片)
-   `--radius-l`: 12px (阅读器)

#### **4.2 阴影**
-   `--shadow-s`: `0 1px 2px rgba(0,0,0,0.04)` (微小悬浮)
-   `--shadow-m`: `0 4px 12px rgba(0,0,0,0.08)` (标准卡片)
-   `--shadow-l`: `0 10px 28px rgba(0,0,0,0.1)` (模态)

#### **4.3 图标**
-   **库:** Lucide Icons。
-   **尺寸:** `icon-size-s` (16px), `icon-size-m` (24px), `icon-size-l` (32px)。
 -   **核心原则:** 清晰性、一致性（统一Lucide描边风格）、有意义（语义明确）。
 -   **描边宽度:** 全局统一 `stroke-width="2"`；如需强调或弱化，必须在组件规范中单独注明。
 -   **尺寸Token标准:**
   - `--icon-size-s: 16px`（行内文本、紧凑按钮）
   - `--icon-size-m: 24px`（导航栏、主要操作按钮）
   - `--icon-size-l: 32px`（空状态、标题等大尺寸场景）
 -   **颜色（最高法则：克制与一致）:**
   - 默认（95%场景）：`color: currentColor`，图标颜色继承父文本（通常为 `var(--color-label)` 或 `var(--color-secondary-label)`），自然融入黑/白/灰文本流。
   - 交互（可点击/选中）：`var(--color-system-blue)`，用于按钮图标与底部 Tab Bar 当前项。
   - 特殊状态：危险/删除 → `var(--color-system-red)`；成功/完成 → `var(--color-system-green)`。
   - 品牌点缀（AI专属）：AI相关少量场景可用 `var(--color-system-purple)`；必须克制、一致且有意义。
   - 强制禁令：严禁按功能分类随意赋色（如书库棕色、笔记黄色）；图标颜色仅反映“状态”，不反映“类别”。
 -   **集成示例（lucide-react）:**
   ```tsx
   import { Sparkles, Menu } from 'lucide-react'

   export function NavItem({ active, label }){
     return (
       <div className="nav-item">
         <Menu size={24} color={active ? 'var(--color-system-blue)' : 'currentColor'} />
         <span>{label}</span>
       </div>
     )
   }
   ```

#### **4.4 Liquid Glass 效果**
-   **Token:** `--liquid-glass-blur` (10px), `--liquid-glass-saturate` (180%), `--liquid-glass-opacity` (0.8)。
-   **实现:** `backdrop-filter: blur(var(--liquid-glass-blur)) saturate(var(--liquid-glass-saturate));`

---

### **第五章：动效与交互**
> 一致性声明：动效曲线与时长以 FIGMA 动效规格为准；本文件已对齐主页动效基准并随 FIGMA 更新同步。

#### **5.1 动效 Token**
-   `--motion-duration-fast`: 150ms (按钮点击)
-   `--motion-duration-medium`: 300ms (面板滑入)
 -   `--motion-easing-default`: `cubic-bezier(0.22, 1, 0.36, 1)` (主页基线曲线)

#### **5.2 组件状态**
-   `:hover`: 缩放 1.02 + 阴影提升。
-   `:focus`: 焦点环 2px `color-accent-primary`。
-   `:disabled`: 透明度 0.5。

---

#### **5.3 模式切换与 Liquid Glass (新增)**
- **模式切换动画**：全局启用颜色平滑过渡。
  ```css
  /* 应用于 body 或 :root */
  body {
    transition: background-color var(--motion-duration-medium) ease,
                color var(--motion-duration-medium) ease;
  }
  ```
- **用户偏好存储**：结合 `prefers-color-scheme` 与 `localStorage`。
  ```ts
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
  const saved = localStorage.getItem('theme')
  const theme = saved ?? (prefersDark ? 'dark' : 'light')
  document.documentElement.dataset.theme = theme
  ```
- **Liquid Glass 动态参数**：暗模式降低饱和度，保持模糊与不透明度一致；兼容 `-webkit` 前缀。
  ```css
  .glass {
    --blur: 10px;
    --opacity: 0.8;
    backdrop-filter: blur(var(--blur)) saturate(180%);
    -webkit-backdrop-filter: blur(var(--blur)) saturate(180%);
  }
  [data-theme="dark"] .glass {
    backdrop-filter: blur(var(--blur)) saturate(150%);
    -webkit-backdrop-filter: blur(var(--blur)) saturate(150%);
  }
  ```
- **视觉一致性与对比度**：严格遵循 WCAG 2.2 AA；AI生成组件需校验文本与背景对比度（≥4.5:1），保持按钮/输入的“悬浮感”和“可点击感”。
- **兼容性测试**：在 Cypress/Playwright 中新增用例，验证主题切换后组件可见性、对比度与 `backdrop-filter` 前缀存在。
- **AI生成提示**：默认支持平滑过渡；使用设计 Token；根据当前模式自动选择 Liquid Glass 参数与前缀。

#### **5.4 跨端设计标准（新增）**
- **Web / Desktop / Mobile 一致性**：统一颜色、字体、间距与动效Token；导航模式遵循平台习惯（Web侧栏 + 面包屑、Desktop窗口级菜单、Mobile底部导航）。
- **组件适配原则**：
  - 文本与组件最小触达区（Mobile ≥ 44x44px）。
  - 列表与阅读器在 Mobile 启用虚拟滚动；Desktop 提供分栏布局。
  - 弹窗在 Mobile 改为全屏抽屉；Desktop 为居中模态。
- **文件与命名**：统一 `Component.platform.variant.tsx`（如 `Reader.mobile.tsx`），通过入口 `index.tsx` 自动选择平台版本。
- **输入法与光标**：在 Mobile 保持较大输入框与占位文本；Desktop 加强键盘操作与快捷键提示。

#### **5.5 组件三态与全局反馈（新增）**
- **三态定义**：
  - Loading：骨架屏（Skeleton）+ 进度条（长耗时任务）。
  - Empty：引导文案 + 快速操作按钮（如“添加书籍”）。
  - Error：图标 + 可重试按钮 + 错误详情折叠。
- **模式化实现**：所有数据展示组件（列表、卡片、阅读器、AI Panel）必须暴露 `isLoading`、`isEmpty`、`error` 属性；在 Storybook 覆盖三态用例。
- **全局反馈**：
  - Toast：短消息（成功/失败）；Banner：持久提示（如离线模式）。
  - 全局错误边界：捕获React运行时错误并展示回退UI；同时上报到 Sentry。
- **可访问性**：Loading/Empty/Error 元素需具备 `aria-busy`、`aria-live` 或适当 `role`，保证屏幕阅读器可用。

#### **5.5.1 配额超限与只读锁状态 (V9.1 新增)**
- **只读模式 (Read-only Mode)**:
  - **触发**: 用户存储或书量超限。
  - **全局提示**: 顶部 Banner (Warning 色系) 常驻显示：“存储空间已满，无法同步新笔记。请升级或清理空间。”
  - **操作禁用**: 笔记/高亮按钮置灰或点击弹出 Toast 提示；书架编辑入口隐藏。
  - **同步失败**: 触发 `403` 时，前端静默失败并更新本地状态为“未同步(云端拒绝)”，UI 显示红色云朵图标。
- **上传限制**:
  - **触发**: 免费用户达到 50 本或 1GB。
  - **上传入口**: 点击“上传书籍”后，弹出模态框展示当前用量，引导升级 Pro 或邀请好友。
  - **文案**: “免费额度已用完。邀请好友各得 500MB，或升级 Pro 无限畅享。”

#### **5.6 AI 流式输出 UI/UX（新增）**
- **逐字流式**：消息气泡内逐字呈现，提供“停止生成/继续”按钮；显示 `token/s` 与预计剩余时间。
- **引用联动**：AI输出中的引用标签（高亮/笔记/位置）可点击，触发阅读器跳转与高亮。
- **可编辑与版本**：允许对AI输出进行编辑并保存至 `note_versions`，展示版本号与变更摘要；支持“回滚”。
- **失败与重试**：网络类错误自动指数退避；权限错误直接提示并引导登录或升级权限。
- **节流与预算**：展示用户本日Token预算与当前会话使用量；到达阈值时提示并建议改用检索或摘要模式。

#### **5.7 低端移动设备适配与降级（新增）**
- **性能预算**：目标首屏 < 2s；长列表启用虚拟滚动；禁用昂贵阴影与模糊（Liquid Glass 在低端设备自动降级为不透明背景）。
- **图片与字体**：图片按需加载与占位；字体子集化，优先系统字体；关闭非必要的可变字体轴。
- **动画降级**：检测 `prefers-reduced-motion` 或设备性能评分，降级为淡入淡出；避免大面积 `box-shadow` 与 `filter`。
- **网络优化**：启用请求合并与缓存；弱网条件下提示离线可用书籍，并延迟非关键资源请求。
- **故障回退**：阅读器在资源不足时自动切换到纯文本模式；AI面板在弱网时改为非流式一次性输出。

#### **5.8 新用户旅程（新增）**
- **旅程目标**：新用户在 3 分钟内完成“添加首本书→首个高亮→首次AI对话→设定阅读目标”，形成正反馈。
- **里程碑编排**：
  1) 欢迎页与安装引导（PWA/桌面）；
  2) “添加书籍”任务卡（空态增强）；
  3) 阅读器内“引导高亮”教练标（Coach Mark）；
  4) AI 面板首问引导模板；
  5) 目标设定弹窗（GoalSettingModal）。
- **进度存储**：使用 `user_onboarding_progress`（JSONB）记录完成步骤；前端通过 `useJourney()` Hook 读取/写入，支持多端同步与断点续跳。
- **反馈与奖励**：完成每一步触发 Toast + 勋章动画（Reduced Motion 自动降级）；在 Profile 展示“已完成旅程”徽章。
- **可访问性保障**：所有引导组件具备 `role`/`aria-describedby` 与键盘操作；教练标支持“跳过”与“稍后提醒”。
- **度量与优化**：埋点记录“旅程完成率、用时、放弃点”；仪表盘按设备与入口来源分层分析，迭代旅程文案与步骤顺序。

#### **5.9 可访问性文化与自动化（新增）**
- **文化落地**：将 A11Y 作为代码评审（Code Review）必查项；PR 模板必须包含“焦点顺序、对比度、键盘可用性”说明。
- **组件基线**：设计系统中的所有组件默认提供可访问属性（`aria-*`、语义标签），并在 Storybook 加入 A11Y 页面与用例。
- **焦点管理**：路由切换触发 `skip-to-content` 与主标题聚焦；模态对话框锁定焦点并支持 `Esc/Enter/Space`。
- **颜色与动效**：保证 WCAG AA 对比度；遵守 `prefers-reduced-motion`，在低端/减少动效环境自动降级动效。
- **自动化校验**：在 CI 中加入 `axe` 检查并作为门禁（见 13.9）；本地开发提供 `pnpm a11y:scan` 快捷命令。
- **文案与国际化**：避免仅以颜色表达信息；所有图标提供 `aria-label`；多语言场景下保证翻译长度对齐布局与阅读顺序。

#### **5.10 首页实现基线（新增）**
- 容器与间距：`max-w-6xl/7xl` + `px-6`，区块 `py-24/32`；与 `HomePage`/`Hero`/`FeatureCards` 保持一致（`web/src/pages/HomePage.tsx:14-26`）。
- 标题与文案：主标题 `text-6xl md:text-7xl`，字重 700，行高 1.05；段落 `text-xl md:text-2xl`（`web/src/landing/Hero.tsx:23-35`）。
- 动效规格：统一使用 `cubic-bezier(0.22, 1, 0.36, 1)`；首屏 Logo 缩放/位移动画 `duration: 1.5`，序进延迟 1.3/1.6s（`web/src/landing/Hero.tsx:10-35`）。
- 设备展示 Parallax：`useScroll` + `useTransform`，偏移范围 `[-60, 0]`，容器 offset `['start end','end start']`（`web/src/landing/DeviceShowcase.tsx:14-17,29-48`）。
- 书库 Marquee：类 `.marquee-row/.marquee-track`，线性 90s 无限滚动，双份卡片拼接以实现无缝（`web/src/landing/BookGrid.tsx:49-55,65-69`；样式见 `web/src/styles/figma.css:151-155`）。
- 图标与尺寸：`lucide-react` 图标在特性卡片中 `w-10 h-10`，圆形容器 `w-20 h-20` 阴影提升（`web/src/landing/FeatureCards.tsx:21-37`）。
- CTA 与按钮：优先复用统一按钮组件 `web/src/components/ui/Button.tsx:1-15`；避免在页面中使用内联样式按钮（当前 `HomePage` 的“开始浏览”按钮应替换，`web/src/pages/HomePage.tsx:21-24`）。
- 头部 Liquid Glass：粘性头部使用 `backdrop-filter: blur(12px)` + 半透明背景与边框（`web/src/components/layouts/MainLayout.tsx:12-23`）。


### **第六章：组件契约**

#### **示例1: Button 组件**
-   **Props (TypeScript):**
    ```typescript
    interface ButtonProps {
      variant?: 'primary' | 'secondary' | 'ghost' | 'danger';
      size?: 'sm' | 'md' | 'lg';
      isLoading?: boolean;
      disabled?: boolean;
      iconLeft?: React.ReactNode;
      onClick?: () => void;
      children: React.ReactNode;
    }
    ```
 -   **图标约束:** `iconLeft`/`iconRight` 仅接受基于 Lucide 的 React 节点（lucide-react）。

#### **示例2: ContextualAIToolbar 组件（新增）**
- 触发：当用户在阅读器中选中文本时，于选区附近浮现。
- 样式：水平、紧凑的黑色操作栏，采用图标按钮；遵循 iOS/macOS 选择文本后的操作栏范式。
  - MVP 按钮：
  - “智能摘要”（Sparkles 图标）
  - “生成笔记”（FileText + Sparkles 组合图标）
  - “提取关键词”（Tags 图标）
  - “翻译”（Languages 图标）
- 交互：点击任一按钮，将“当前选中文本 + 预设 Prompt 指令”发送至 AI 后端；结果在独立 AI 对话界面展示。
- Props (TypeScript):
  ```typescript
  interface ContextualAIToolbarProps {
    visible: boolean;
    anchorRect: { x: number; y: number; width: number; height: number };
    selectedText: string;
    onInvoke: (
      action: 'smart-summary' | 'generate-note' | 'extract-keywords' | 'translate',
      payload: { selectedText: string }
    ) => void;
  }
  ```

### **第七章：核心界面平台适配规范（新增）**
- 主导航：
  - 移动端（iOS/Android）：底部标签栏（Tab Bar），5个核心入口，专用于导航，不承载动作。
  - 桌面/Web/Pad：左侧边栏（Sidebar），支持分组、折叠与快速检索。
- AI对话界面：
  - 移动端：抽屉 + 底部工作表（Bottom Sheet）模式；上下文管理器以工作表呈现。
  - 桌面/Web/Pad：三栏式布局（左：历史；中：主聊天；右：上下文管理器）。
- 列表与详情：
  - 移动端：导航推送式（新页面覆盖旧页面）。
  - 桌面/Pad：主从式布局（列表与详情并排）。

### **第八章：性能预算与优雅降级（新增）**
- 动效降级：检测 `prefers-reduced-motion`，开启时将复杂动效降级为淡入淡出；禁用非必要动画。
- 视觉效果降级：在低端设备或不支持 `backdrop-filter` 时，将 Liquid Glass 自动降级为半透明纯色背景；保证文本对比度符合 WCAG AA。
- 性能预算：TTI < 3s；列表采用虚拟滚动，图片使用懒加载，路由级代码分割；弱网条件下延迟非关键请求。

#### **示例2: Reader 组件**
-   **Props (TypeScript):**
    ```typescript
    interface ReaderProps {
      bookId: string;
      initialCfi?: string;
      onLocationChange?: (cfi: string) => void;
      onHighlightCreate?: (highlight: { cfi: string; text: string; color: string }) => void;
    }
    ```
    
    // 命令式句柄，用于联动AI引用跳转与高亮
    export interface ReaderHandle {
      scrollToCfi: (cfi: string) => void;
      highlightCfi: (cfi: string, color?: string) => void;
    }
    
    // 使用示例
    /*
    const readerRef = useRef<ReaderHandle>(null);
    <Reader ref={readerRef} bookId={bookId} />
    
    // 在AIPanel引用点击时
    onReferenceClick={(ref) => {
-   **Props (TypeScript):**
    ```typescript
    interface BookCardProps {
      bookId: string;
      title: string;
      author: string;
      coverUrl?: string;
      isLocallyAvailable: boolean;
      isDownloading: boolean;
      downloadProgress: number;
      onClick: () => void;
    }
    ```

#### **示例5: PWAInstallPrompt 组件 (新增)**
-   **用途:** 在符合条件的浏览器中，提示用户将Web应用安装到主屏幕。
-   **Props (TypeScript):**
    ```typescript
    interface PWAInstallPromptProps {
      isVisible: boolean;
      onInstall: () => void;
      onDismiss: () => void;
    }
    ```

---

#### **示例6: GoalSettingModal 组件 (新增)**
-   **用途:** 设定阅读目标（分钟/书籍数）与周期（日/月/年）。
-   **Props (TypeScript):**
    ```typescript
    type GoalType = 'minutes' | 'books';
    type GoalPeriod = 'daily' | 'monthly' | 'yearly';

    interface GoalSettingModalProps {
      isOpen: boolean;
      initialGoal?: { type: GoalType; period: GoalPeriod; targetValue: number };
      onSave: (goal: { type: GoalType; period: GoalPeriod; targetValue: number }) => void;
      onCancel: () => void;
    }
    ```

#### **示例7: ProgressTracker 组件 (新增)**
-   **用途:** 展示当前目标完成进度，进度条+百分比文本。
-   **Props (TypeScript):**
    ```typescript
    interface ProgressTrackerProps {
      goal: { type: 'minutes' | 'books'; period: 'daily' | 'monthly' | 'yearly'; targetValue: number };
      currentValue: number; // 例如当日累计阅读分钟数
    }
    ```

#### **示例8: ReadingTimeChart 组件 (新增)**
-   **库选择:** 使用 Recharts (MIT)。
-   **用途:** 展示每日/每周阅读时长趋势，对应`user_daily_reading_stats`。
-   **Props (TypeScript):**
    ```typescript
    interface ReadingTimeChartProps {
      data: Array<{ date: string; minutes: number }>; // 已转换为camelCase
      granularity?: 'daily' | 'weekly' | 'monthly';
    }
    ```

#### **示例9: BooksFinishedChart 组件 (新增)**
-   **用途:** 展示月度/年度完成书籍数量。
-   **Props (TypeScript):**
    ```typescript
    interface BooksFinishedChartProps {
      data: Array<{ month: string; finished: number }>;
    }
    ```

#### **示例10: HighlightQualityDistribution 组件 (新增)**
-   **用途:** 展示SRS复习质量分布（基于`srs_reviews.quality`）。
-   **Props (TypeScript):**
    ```typescript
    interface HighlightQualityDistributionProps {
      data: Array<{ label: string; value: number }>;
    }
    ```

---

### **第九章：可访问性**

-   **验收清单:**
    1.  图像 alt/aria-label。
    2.  键盘聚焦 Enter/Space。
    3.  表单 label 关联。
    4.  对比度 WCAG AA。
    5.  Reduced Motion 支持。

---

### **第十章：性能与测试**

-   **性能规则:** 虚拟滚动 `react-window`；GPU 加速 `will-change: transform`。
-   **测试清单:** 单元: Jest + RTL；E2E: Cypress；A11Y: axe-core。

---

### **第十一章：国际化与多语言**

-   **机制:** JSON 文件。
-   **字体回退:** 语言动态切换。
-   **RTL:** 自动反转。
-   **日期/货币:** Intl API。

---

### **第十二章：PWA 与离线支持 (新增)**

-   **机制:** 使用Service Worker缓存应用外壳和静态资源。
-   **离线阅读:** 已下载的书籍（`books.is_locally_available = true`）及其封面、元数据将被Service Worker缓存，实现完全离线阅读。
-   **离线操作:** 用户在离线状态下创建的笔记、高亮将存储在本地IndexedDB中。
-   **同步策略:** 设备重新联网后，Service Worker在后台自动将本地变更同步至服务器，并解决冲突。

---

### **第十三章：开发者体验与实时预览 (新增)**

#### **11.1 前端热重载与预览 (Vite)**
- 采用 Vite 默认 HMR；确保开发环境启用 WebSocket。
- **环境变量**：在 `.env` 中配置 `VITE_API_BASE_URL` 指向后端，如 `http://localhost:8000`。
- **开发代理与HMR设置**：
  ```ts
  // frontend/vite.config.ts
  import { defineConfig } from 'vite'
  import react from '@vitejs/plugin-react'

  export default defineConfig({
    plugins: [react()],
    server: {
      host: true,
      port: 5173,
      hmr: { protocol: 'ws' },
      proxy: {
        '/api': {
          target: process.env.VITE_API_BASE_URL || 'http://localhost:8000',
          changeOrigin: true,
          ws: true,
        },
      },
    },
  })
  ```

#### **11.2 桌面端实时预览 (Tauri Live Reload)**
- Tauri 在开发模式下直接加载前端开发服务器，实现桌面端实时预览与调试。
- **配置示例**：
  ```json
  // src-tauri/tauri.conf.json
  {
    "build": {
      "distDir": "../frontend/dist",
      "devPath": "http://localhost:5173"
    },
    "tauri": {
      "security": {
        "csp": "default-src 'self' http://localhost:5173 ws://localhost:5173"
      }
    }
  }
  ```

#### **11.3 Docker 开发环境代理 (Nginx → Vite)**
- `docker-compose.dev.yml` 中 `static-server` 通过 Nginx 反向代理至 `http://host.docker.internal:5173`，以使用 Vite HMR（配置见 3.2）。
- API 路径 `/api/` 通过容器网络代理到 `api:8000`，保持与生产一致的路径结构。

#### **11.4 AI辅助开发工具建议**
- VS Code 插件：`Codeium`、`Continue.dev`，支持代码补全、生成与上下文感知。
- 建议在PR模板中要求：AI生成的React组件需同时生成 `.stories.tsx`。

#### **11.5 UI组件独立预览 (Storybook)**
- 初始化：`pnpm dlx storybook@latest init`。
- 运行：`pnpm storybook`。
- 可选：使用开源 `aislino` 进行组件级实时预览与交互测试。
- 示例：
  ```ts
  // frontend/src/components/BookCard.stories.tsx
  import { BookCard } from './BookCard'
  export default { title: 'Cards/BookCard', component: BookCard }
  export const Default = { args: { title: '书名', coverUrl: '...' } }
  ```

#### **11.6 端到端测试 (E2E：Cypress / Playwright)**
- Cypress：`pnpm cypress open` / `pnpm cypress run`。
- Playwright：`pnpm exec playwright test`。
- 建议覆盖：登录→打开书籍→高亮→AI对话→切换明暗模式。

#### **11.7 环境变量与配置**
- 前端：`.env`、`.env.production` 中维护 `VITE_API_BASE_URL`、`VITE_STATIC_BASE_URL`。
- 生产：`VITE_API_BASE_URL` 指向 API 网关；静态资源走 CDN 域名。

#### **11.8 常用命令参考**
- Web 开发：`pnpm dev`（Vite）
- 桌面开发：`pnpm tauri dev`
- Storybook：`pnpm storybook`
- E2E：`pnpm cypress open` / `pnpm exec playwright test`

#### **11.9 发布质量门禁（新增）**
- **门禁度量与阈值**：
  - 契约测试：`contracts` 校验与消费者/提供者测试必须通过。
  - 类型检查：`pnpm typecheck` 无错误；TS `strict` 模式。
  - 代码规范：`pnpm lint` 无 `error`；`prettier:check` 通过。
  - Secret Scanning：在 CI/PR 阶段执行 `trufflehog`（或等效）进行密钥泄露扫描，未通过即阻断。
  - OSS License Check：执行 `pip-licenses` / `npm-license-checker`；发现不合规许可证时阻断或发出高优先级警告。
  - 单元覆盖率：总体 ≥ 80%，变更文件行覆盖率 ≥ 90%。
  - 端到端冒烟：核心用户旅程（登录→打开书籍→高亮→AI对话）通过。
  - 包体预算：`dist/*.js.gz` 不超过基线 +10%；`main.js.gz` ≤ 200KB。
  - 可访问性：`axe` 关键违规数 = 0（严重/高等级）。
  - 安全扫描：`semgrep` 高等级 = 0；依赖审计无高危。
  - 数据迁移检查（可选）：`sqlfluff lint` 通过。
- **PR 门禁策略**：保护 `main/release/*` 分支，必须通过 `quality-gate` 状态检查方可合并与发布。
- **CI 示例（GitHub Actions）**：
  ```yaml
  name: Quality Gate
  on:
    pull_request:
      branches: [ main ]
  jobs:
    quality-gate:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-node@v4
          with: { node-version: '20', cache: 'pnpm' }
        - uses: pnpm/action-setup@v4
          with: { version: 9 }
        - run: pnpm install --frozen-lockfile
        - name: Contract Lint
          run: npx @redocly/cli lint contracts/api/v1/swagger.yaml
        - name: Typecheck
          run: pnpm typecheck
        - name: Lint
          run: pnpm lint && pnpm prettier:check
        - name: Unit Test with Coverage
          run: pnpm test:ci -- --coverage
        - name: Enforce Coverage Threshold
          run: node scripts/coverage-gate.mjs 80 90 # 总体/变更文件阈值
        - name: Build
          run: pnpm build
        - name: Bundle Size Gate
          run: npx bundlesize
        - name: E2E Smoke (Playwright)
          run: pnpm exec playwright test --config e2e-smoke.config.ts
        - name: Accessibility Gate (axe)
          run: pnpm exec axe-ci http://localhost:5173 --threshold serious=0,critical=0 || exit 1
        - name: Security Scan (Semgrep)
          run: pipx run semgrep --config p/ci --error
        - name: Summary Comment
          if: always()
          run: node scripts/quality-summary.mjs
  ```
- **项目脚本建议**：
  - `scripts/coverage-gate.mjs`：读取 `coverage/coverage-summary.json`，校验总体与变更文件覆盖率。
  - `e2e-smoke.config.ts`：仅覆盖关键用户旅程，控制耗时 ≤ 3 分钟。
  - `scripts/quality-summary.mjs`：汇总各门禁指标并在PR中留言。
- **度量留存**：对比历史基线（上一版本构建输出、覆盖率、axe违规数）并在仪表盘展示趋势，用于发布回归预警。

---
### **导航栏规范（新增）**
- 位置与样式：顶部粘性、Liquid Glass 背景（blur 12px / saturate 180% / opacity 0.6），下边框 1px。
- 字体：使用上文 `--font-ui` 系统字体栈；字号 14–16px；中文与英文统一基线高度。
- LOGO：左侧 32px 方形，点击返回首页；右侧为语言切换与登录。
- 交互与可访问性：焦点环 3px（系统蓝），Tab 键可导航；暗色模式保持对比度 ≥ 4.5:1。
- **主页动效基准（对齐 FIGMA）**：
  - Logo 缩放上浮：1.5s；标题滑入：0.8s（延迟 1.3s）；描述滑入：0.8s（延迟 1.6s）。
  - 设备汇聚：每张 1.4s；延迟 2.0s 起按左右距离递增；滚动联动 `useScroll([0.2,0.6])`。
  - 卡片滚动：两排从右向左循环，总时长 55s；悬停整体卡片 `scale(1.10)` + 阴影提升。
- **字体映射（新增）**：
  - 中文（简体）：优先系统 `PingFang SC / Microsoft YaHei`，回退 `Noto Sans SC / Source Han Sans SC`（OFL）。
  - 英文及西文：系统栈 `-apple-system / Segoe UI / Roboto / Helvetica Neue / Arial`；回退 `Noto Sans`（OFL）。
  - 说明：不捆绑商用字体；默认使用系统字体与开源字体回退，避免版权风险。
- **样式管线**：PostCSS 使用 `@tailwindcss/postcss`；Tailwind v4 原子类与主题 Token 与 FIGMA 样式一致。