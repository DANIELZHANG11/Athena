<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kokoro-JS TTS æµ‹è¯•</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #444;
    }
    select, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    button {
      background: #4A90D9;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #3A7BC8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-bar-fill {
      height: 100%;
      background: #4A90D9;
      transition: width 0.3s ease;
    }
    .status {
      color: #666;
      font-size: 14px;
    }
    .audio-player {
      width: 100%;
      margin-top: 16px;
    }
    .log {
      background: #1a1a2e;
      color: #00ff41;
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 16px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 4px;
    }
    .log-time {
      color: #888;
    }
    .log-error {
      color: #ff6b6b;
    }
    .log-success {
      color: #4ecdc4;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .info-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>ğŸ¤ Kokoro-JS TTS æµ‹è¯•</h1>
  
  <div class="card">
    <h3>æ¨¡å‹çŠ¶æ€</h3>
    <div class="progress-bar">
      <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
    </div>
    <p class="status" id="statusText">ç‚¹å‡» "åˆå§‹åŒ–æ¨¡å‹" å¼€å§‹</p>
    <div class="info-grid" id="infoGrid" style="display: none;">
      <div class="info-item">
        <div class="info-label">åç«¯</div>
        <div class="info-value" id="deviceInfo">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">è¯­éŸ³æ•°é‡</div>
        <div class="info-value" id="voiceCount">-</div>
      </div>
      <div class="info-item">
        <div class="info-label">é‡‡æ ·ç‡</div>
        <div class="info-value" id="sampleRate">-</div>
      </div>
    </div>
    <button id="initBtn" onclick="initTts()">åˆå§‹åŒ–æ¨¡å‹</button>
  </div>

  <div class="card">
    <h3>è¯­éŸ³åˆæˆ</h3>
    <label for="voiceSelect">é€‰æ‹©è¯­éŸ³</label>
    <select id="voiceSelect" disabled>
      <option value="">-- è¯·å…ˆåˆå§‹åŒ–æ¨¡å‹ --</option>
    </select>
    
    <label for="textInput">è¾“å…¥æ–‡æœ¬</label>
    <textarea id="textInput" placeholder="è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬...">ä½ å¥½ï¼Œæ¬¢è¿ä½¿ç”¨é›…å…¸å¨œé˜…è¯»å™¨ï¼è¿™æ˜¯ä¸€ä¸ªåŸºäº Kokoro TTS çš„è¯­éŸ³åˆæˆæµ‹è¯•ã€‚</textarea>
    
    <label for="speedInput">è¯­é€Ÿ: <span id="speedValue">1.0</span></label>
    <input type="range" id="speedInput" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeedLabel()">
    
    <button id="speakBtn" onclick="speak()" disabled>ğŸ”Š åˆæˆè¯­éŸ³</button>
    
    <audio id="audioPlayer" class="audio-player" controls style="display: none;"></audio>
  </div>

  <div class="card">
    <h3>æ—¥å¿—</h3>
    <div class="log" id="logArea">
      <div class="log-entry"><span class="log-time">[å‡†å¤‡å°±ç»ª]</span> ç­‰å¾…åˆå§‹åŒ–...</div>
    </div>
  </div>

  <script type="module">
    // å¯¼å…¥ TTS æœåŠ¡
    import { kokoroJsTts, KOKORO_JS_VOICES } from './src/services/tts/kokoroJsTtsService.ts';
    
    // æš´éœ²ç»™å…¨å±€
    window.kokoroJsTts = kokoroJsTts;
    window.VOICES = KOKORO_JS_VOICES;
    
    function log(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const time = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : '';
      logArea.innerHTML += `<div class="log-entry ${className}"><span class="log-time">[${time}]</span> ${message}</div>`;
      logArea.scrollTop = logArea.scrollHeight;
    }
    window.log = log;
    
    function updateProgress(progress, message) {
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('statusText').textContent = message;
      log(`${progress}% - ${message}`);
    }
    window.updateProgress = updateProgress;
    
    function updateSpeedLabel() {
      document.getElementById('speedValue').textContent = document.getElementById('speedInput').value;
    }
    window.updateSpeedLabel = updateSpeedLabel;
    
    async function initTts() {
      const btn = document.getElementById('initBtn');
      btn.disabled = true;
      btn.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
      
      try {
        log('å¼€å§‹åˆå§‹åŒ– Kokoro-JS TTS...');
        
        await kokoroJsTts.init({
          onProgress: (progress, message) => {
            updateProgress(progress, message);
          }
        });
        
        log('åˆå§‹åŒ–æˆåŠŸï¼', 'success');
        
        // æ›´æ–° UI
        document.getElementById('infoGrid').style.display = 'grid';
        document.getElementById('deviceInfo').textContent = kokoroJsTts.device.toUpperCase();
        document.getElementById('voiceCount').textContent = kokoroJsTts.availableVoices.length || VOICES.length;
        document.getElementById('sampleRate').textContent = kokoroJsTts.sampleRate + ' Hz';
        
        // å¡«å……è¯­éŸ³é€‰æ‹©
        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = '';
        
        // æŒ‰è¯­è¨€åˆ†ç»„
        const zhVoices = VOICES.filter(v => v.language === 'zh');
        const enVoices = VOICES.filter(v => v.language === 'en');
        
        if (zhVoices.length > 0) {
          const zhGroup = document.createElement('optgroup');
          zhGroup.label = 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯­éŸ³';
          zhVoices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = `${v.name} (${v.gender === 'female' ? 'å¥³' : 'ç”·'})${v.recommended ? ' â­' : ''}`;
            zhGroup.appendChild(opt);
          });
          voiceSelect.appendChild(zhGroup);
        }
        
        if (enVoices.length > 0) {
          const enGroup = document.createElement('optgroup');
          enGroup.label = 'ğŸ‡ºğŸ‡¸ è‹±æ–‡è¯­éŸ³';
          enVoices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = `${v.name} (${v.gender === 'female' ? 'F' : 'M'})${v.recommended ? ' â­' : ''}`;
            enGroup.appendChild(opt);
          });
          voiceSelect.appendChild(enGroup);
        }
        
        voiceSelect.disabled = false;
        document.getElementById('speakBtn').disabled = false;
        btn.textContent = 'âœ… åˆå§‹åŒ–å®Œæˆ';
        
      } catch (error) {
        log('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = 'é‡æ–°åˆå§‹åŒ–';
      }
    }
    window.initTts = initTts;
    
    async function speak() {
      const btn = document.getElementById('speakBtn');
      const text = document.getElementById('textInput').value.trim();
      const voice = document.getElementById('voiceSelect').value;
      const speed = parseFloat(document.getElementById('speedInput').value);
      
      if (!text) {
        alert('è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'ğŸ”„ åˆæˆä¸­...';
      
      try {
        log(`å¼€å§‹åˆæˆ: "${text.substring(0, 30)}${text.length > 30 ? '...' : ''}" (è¯­éŸ³: ${voice}, è¯­é€Ÿ: ${speed})`);
        
        const startTime = performance.now();
        const result = await kokoroJsTts.speak(text, { voice, speed });
        const endTime = performance.now();
        
        log(`åˆæˆå®Œæˆ! æ—¶é•¿: ${result.duration.toFixed(2)}s, è€—æ—¶: ${((endTime - startTime) / 1000).toFixed(2)}s`, 'success');
        
        // æ’­æ”¾éŸ³é¢‘
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = result.url;
        audioPlayer.style.display = 'block';
        audioPlayer.play();
        
      } catch (error) {
        log('åˆæˆå¤±è´¥: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ”Š åˆæˆè¯­éŸ³';
      }
    }
    window.speak = speak;
    
    log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…åˆå§‹åŒ–...');
  </script>
</body>
</html>
