## 范围与原则

* 严格核对原文档是否存在、确需调整后再改动；所有改动遵循既有规范（Idempotency/If-Match/RLS/分页）。

* 输出 v7.1 并附变更日志；不新增无关内容。

## P0 修正（Blocker）

1. RLS 全覆盖（新增/补足）

* reading\_progress：在表定义处（行 2435 起）追加 ENABLE RLS 与 owner 策略。

* user\_sessions：在表定义处（行 2232 起）追加 ENABLE RLS 与 owner 策略。

* dict\_history：在表定义处（行 3008 起）追加 ENABLE RLS 与 owner 策略。

* payment\_gateways：在表定义处（行 3350 起）追加 ENABLE RLS 与 admin 策略。

* dictionary\_packages：当前文档缺失；在 TTS/词典切片“数据库变更与扩展”（行 6059）下新增 DDL 与 admin RLS 策略。

1. 用户自助资料更新 API（新建契约文件）

* 新增 contracts/api/v1/profile.yaml：

  * GET /api/v1/profile/me：返回用户资料与 ETag(version)。

  * PATCH /api/v1/profile/me：允许修改 display\_name/timezone/language；强制 If-Match 与 Idempotency-Key；成功返回新 ETag。

* UI/UX：在“第六章：组件契约”新增 AccountSettings 组件（保存调用 PATCH /api/v1/profile/me，遵守并发与幂等）。

1. 架构冗余与不一致

* internal\_vector\_cache：全局确认无残留（已无匹配），保持不新增。

* srs\_reviews：已统一为 source\_type/source\_id（行 1408–1424 与 3545）；仅复核保持一致，不改动。

1. 订阅与信用点关系

* 在第四章 4.2 Pro专章（行 207）之后追加段落：Pro 用户每月自动获赠 X 点信用点，当月清零，不足可随时购买加油包。

## P1 强化（High Priority）

1. SRE：服务等级与灾备目标

* 在“性能指标”章节（行 3742 起）新增“SLO/SLI 与错误预算”：定义 P95 延迟（核心 API ≤ 800ms），可用性（≥99.9%），错误率（≤0.1%），以及错误预算用法。

* 在“维护策略”（行 2162 起）新增“灾难恢复（DR）”：RPO ≤ 15 分钟、RTO ≤ 60 分钟；每日全量+每小时增量；每月恢复演练与验收。

1. 索引优化（DDL增强）

* reading\_progress：新增 `(user_id, book_id, updated_at DESC)` 复合索引。

* ai\_conversations：新增 `(user_id, last_user_message_at DESC)` 复合索引。

* payments：确认/补充 `(gateway_id)` 索引。

1. 安全与合规

* 在第一章“核心架构”新增“密钥管理与轮换策略”：静态 API Key 轮换周期（≤90 天）、RBAC、审计记录、泄露处置流程。

* 在 Admin Panel 章节新增“数据主体请求（GDPR/CCPA）支持规划”：导出/删除流程、日志去标识化、数据保留策略（分表分类）。

1. CI/CD 合规门禁

* 在第十三章 11.9 门禁中新增：

  * Secret Scanning：trufflehog（或等效）在 PR 阶段强制通过。

  * OSS License Check：pip-licenses / npm-license-checker；存在不合规许可证时阻断或警告。

## 交付物

* 文档：v7.1 全部改动 + 结尾新增 Changelog（本次修正条目列表）。

* 合同：contracts/api/v1/profile.yaml 新增并与第六章规范一致。

## 验证

* RLS 检索覆盖（Grep ENABLE ROW LEVEL SECURITY/CREATE POLICY）。

* 契约 lint + If-Match/Idempotency-Key 校验。

* 索引存在性校验（DDL明确）。

* SLO/DR 条目可查，CI 门禁新增项可查。

## 最终声明

* 完成上述改动与自检后，输出“封版就绪”声明。

