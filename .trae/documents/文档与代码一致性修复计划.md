## 修复范围
- 数据库与配额：补齐 Alembic 迁移以正式化 V9.1 表/字段
- 定价与平台：Pricing 增加 `platform/sku_id` 全链路支持
- PWA 离线：实现书籍离线缓存与离线笔记/高亮队列
- 前端主页：替换内联按钮为统一组件，对齐设计 Token
- 开发/CI：Vite 开发代理与 HMR，对齐质量门禁
- 文档修订：同步技术/设计文档与代码现状

## 实施步骤
1) 数据库迁移
- 新增 Alembic `0106_v9_schema`：`user_stats`、`invites`、`pricing_rules.platform/sku_id`、`users.membership_expire_at/monthly_gift_reset_at/free_ocr_usage`、`ocr_jobs.page_count/deduction_strategy/deduction_amount`
- 移除对 `api/scripts/apply_v9_schema.py` 的依赖，改为标准迁移

2) Pricing/计费
- API：`pricing.py` 列表/管理接口读/写 `platform/sku_id`，支持按 `platform` 过滤
- Contracts：更新 `contracts/api/v1/pricing.yaml`/`billing.yaml` 映射字段
- Admin：`admin_panel` 增加 SKU 管理端点（读/写 `addon_packages`）

3) 只读锁与配额
- 保持 `dependencies.require_upload_permission/require_write_permission` 逻辑不变
- 在 `notes/highlights/shelves/books` 所有写接口确保依赖该依赖（现已覆盖）

4) OCR 阶梯与调度
- 保持现有 `ocr.py` 阶梯逻辑；补充任务完成清理 `redis ocr:active_jobs` 与失败重试
- Scheduler：在每日任务中重置月度赠送与 `free_ocr_usage`

5) PWA 离线与前端
- Service Worker：拦截 `/api/v1/books/*/presign` 与实际书籍 GET，缓存到 Cache Storage
- IndexedDB：新增 `offline_queue` 表，离线创建的 `notes/highlights` 入队，联网后批量同步
- Vite：`server.host=true`、`port=5173`、`hmr.ws`，代理 `/api` 至 `VITE_API_BASE_URL`
- 主页：`HomePage` 替换内联按钮为 `components/ui/Button`，移除内联样式，使用 Token

6) CI/质量门禁
- 工作流：加入 `axe` 门禁（严重/高为 0）、`bundlesize`、`semgrep`、Secret 扫描、覆盖率阈值
- Windows Cypress 二进制缓存保持不变

7) 文档修订
- 技术文档：统一对象存储为“SeaweedFS（S3 网关）”，保留 `MINIO_*` 前缀兼容说明
- 设计标准：首页按钮/动效/Token 对齐；标注 PWA 离线范围与对比度要求
- 商业模型：标注 `platform` 与 SKU 策略、只读锁 UI 行为

## 交付与验证
- 单元/集成：Pricing/Invites/OCR/Notes/Books 新增与调整用例
- E2E：登录→上传→只读锁→AI→主题切换→离线阅读
- 指标：覆盖率≥80%、axe严重=0、包体预算达标、Semgrep高危=0
