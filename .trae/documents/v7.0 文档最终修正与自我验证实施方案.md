## 第一阶段：执行修正（按六项指令逐条落地）

### 1) 架构修正：移除 internal\_vector\_cache

* 影响位置：

  * 数据对应列表：`f:\reader\Athena\雅典娜技术文档.md:162`（列出 `internal_vector_cache`）

  * 表定义章节：`f:\reader\Athena\雅典娜技术文档.md:2985-2992`（“19. internal\_vector\_cache”整节）

* 修改动作：

  * 删除上述全部内容与引用；确保“缓存/检索/失效”逻辑仅引用 `shared_vectors` 与用户私有 `vectors`。

  * 交叉检：保留 `shared_vectors` ANN 索引与 `vectors.shared_vector_id` 设计不变（参见 `f:\reader\Athena\雅典娜技术文档.md:2958-2960, 2969-2975, 2956-2957`）。

### 2) 逻辑修正：统一 SRS 模块（srs\_reviews）

* 影响位置：

  * DDL（v1）：`f:\reader\Athena\雅典娜技术文档.md:1181-1196`

  * 二次表说明：`f:\reader\Athena\雅典娜技术文档.md:3229-3242`（目前含 `note_id`）

* 修改动作：

  * 将 srs\_reviews 统一为“多态关联”结构，移除 `note_id`/`card_id`，新增：

    * `source_type VARCHAR(20) CHECK (source_type IN ('NOTE','HIGHLIGHT')) NOT NULL`

    * `source_id UUID NOT NULL`

  * 索引：添加 `CREATE INDEX ON srs_reviews (user_id, source_type, source_id, reviewed_at)`；保留/调整性能视图触发。

  * 关联影响：将代码/文案中的“按卡片ID记录复习”改为“按原始来源(NOTE/HIGHLIGHT)记录复习”。

### 3) 商业逻辑修正：订阅与信用点关系补充

* 影响位置：`f:\reader\Athena\雅典娜技术文档.md:207-209`（“4.2 Pro专业版”后一段新增）

* 修改动作：在 4.2 小节末尾新增段落：

  * 示例文案（可替换具体额度）：

  * “Pro专业版订阅用户，除了享有无限书籍导入等核心权益外，每月将自动获赠 2,000,000 雅典娜信用点，用于AI对话、OCR等增值服务。当月未用完的赠送信用点将在下个月初清零。如果额度提前用完，Pro用户可以随时额外购买信用点加油包。”

### 4) 数据模式修正：补全 users.language 字段

* 影响位置：`f:\reader\Athena\雅典娜技术文档.md:1895-1919`（users 表）

* 修改动作：新增字段：

  * `language VARCHAR(10) NOT NULL DEFAULT 'en-US'`

* 交叉检：与“全球化展示/回退”逻辑一致（参见 `f:\reader\Athena\雅典娜技术文档.md:2196-2200`）；移除文档中任何默认值冲突。

### 5) 安全策略修正：为 highlights 启用 RLS

* 影响位置：

  * highlights DDL：`f:\reader\Athena\雅典娜技术文档.md:2327-2333`

  * RLS缺失（目前未检索到 ENABLE 行与策略）

* 修改动作：在 highlights DDL 后补充：

  * `ALTER TABLE public.highlights ENABLE ROW LEVEL SECURITY;`

  * `CREATE POLICY highlights_select ON public.highlights FOR SELECT USING (user_id = current_setting('app.user_id')::uuid);`

  * `CREATE POLICY highlights_insert ON public.highlights FOR INSERT WITH CHECK (user_id = current_setting('app.user_id')::uuid);`

  * `CREATE POLICY highlights_update ON public.highlights FOR UPDATE USING (user_id = current_setting('app.user_id')::uuid);`

  * `CREATE POLICY highlights_delete ON public.highlights FOR DELETE USING (user_id = current_setting('app.user_id')::uuid);`

* 参考：与 notes 策略写法保持一致（`f:\reader\Athena\雅典娜技术文档.md:3687-3695`）。

### 6) API契约修正：统一 DELETE 幂等性要求

* 影响位置：多处 OpenAPI `delete:` 段落；缺失 `Idempotency-Key` 的需补充：

  * 标签移除端点：`/api/v1/notes/{noteId}/tags/{tagId}#delete`、`/api/v1/highlights/{highlightId}/tags/{tagId}#delete`（参见 `f:\reader\Athena\雅典娜技术文档.md:618-633`）。

  * 高亮/笔记删除（通用摘录段）：`f:\reader\Athena\雅典娜技术文档.md:2515-2519, 2590-2594`。

  * 书架相关：`/api/v1/shelves/{shelfId}#delete` 与 `/api/v1/books/{bookId}/shelves/{shelfId}#delete`（参见 `f:\reader\Athena\雅典娜技术文档.md:5026-5036, 5045-5050`）。

* 修改动作：在上述所有 `delete:` 的 `parameters` 中新增：

  * `- in: header\n  name: Idempotency-Key\n  required: true\n  schema: { type: string }`

* 标准章节文字修订：

  * `f:\reader\Athena\雅典娜技术文档.md:458-461` 将“支持”改为“所有写操作（POST, PUT, PATCH, DELETE）都强制要求 Idempotency-Key”。

## 第二阶段：自我审查与验证（独立视角）

### 数据库层一致性

* 逐垂直切片交叉核对：Tags & Search、Admin Panel、SRS、AI对话、Notes/Highlights、Books & Shelves、阅读器进度同步。

* 核查点：

  * 字段名/类型/NULL/DEFAULT 一致（含 `users.language` 新增、`srs_reviews` 多态统一、`highlights.locator`、`reading_progress.last_location`）。

  * RLS：books/notes/highlights/tags/srs\_cards/srs\_reviews/ai\_conversations 等均启用并具备策略；CI Gate增加RLS校验。

### API层一致性

* 契约统一性：

  * `If-Match`（PATCH）强制携带、`ETag` 响应一致；

  * `Idempotency-Key`（POST/DELETE）强制携带；所有 `delete:` 段落均新增参数；

  * 游标分页/过滤/错误码统一。

### 工作流闭环

* 书籍上传→RAG→AI对话：

  * 上传→轻量识别→PENDING\_USER\_ACTION→深度处理 `process_book_deeply`→向量化（优先 `shared_vectors` 命中/写入）→用户私有 `vectors` 引用→ACTIVE→AI对话；无断点。

* 阅读→捕获→AI交互：

  * 心跳+乐观并发→`reading_progress` 更新→`locator` 消费创建高亮/笔记→RAG 并行检索 `notes/highlights`→引用追溯可跳转；格式一致。

### 架构与商业逻辑

* 架构：删除 `internal_vector_cache` 后无重叠与职责不清；缓存/索引/失效集中于 `shared_vectors`+`vectors`。

* 商业逻辑：订阅与信用点关系明确；计费、预算与赠送额度规则无歧义。

### 交付物

* 提交包含以上修改的统一补丁；更新所有相关段落的引用一致性；运行契约/DDL/RLS/索引自检脚本；输出最终审查报告与一致性清单。

