## 总体说明

* 基于当前代码与契约，按 8+1 文件在 `docs/zh-CN/` 重写；所有描述以实际实现为准，必要处标注「待修正」。

* 每份文档包含可执行规则、代码引用（file:line），以及 MUST 约束；避免空话。

## 00\_AI\_Coding\_Constitution\_and\_Rules.md（建议）

* 错误码统一：当前后端实际返回 `detail` 为字符串，如 `upload_forbidden_quota_exceeded`（api/app/dependencies.py:93-100）、`readonly_mode_quota_exceeded`（api/app/dependencies.py:93-100）、`book_too_large_for_ocr`、`insufficient_credits_for_ocr`、`server_busy_try_later`（api/app/ocr.py:83-112）。建议在文档中新增「当前实现错误码映射表」并标注统一枚举目标（如 QUOTA\_EXCEEDED），状态「待修正」。

* 幂等与乐观锁：列出已实现点并作为强制规则示例：

  * 幂等：书籍上传完成使用 `Idempotency-Key`（api/app/books.py:116-121）；笔记/标签幂等缓存（api/app/notes.py:156-193）。

  * 乐观锁：标签更新使用 `If-Match` 弱 ETag 与版本校验（api/app/notes.py:105-124）。

* RLS 执行：所有写入前设置 `app.user_id`（api/app/books.py:125-129、api/app/notes.py:165-167、api/app/billing.py:27-33,61-67）；此项已落地，可在宪法中保留为 MUST。

* 配置读取铁律：OCR 阈值/并发读取 `system_settings`（api/app/ocr.py:59-65）、配额读取（api/app/dependencies.py:38-42）。

## 01\_Product\_Soul\_and\_Business\_Model.md（建议）

* The Hook & Trap 端到端落地引用：

  * 上传阻断：`require_upload_permission`（api/app/dependencies.py:97-100）在 `POST /books/upload_init` 前使用（api/app/books.py:86-99）。

  * 写操作阻断：`require_write_permission`（api/app/dependencies.py:92-96）在 `POST /notes`（api/app/notes.py:143-196）。

* 阈值物化字段来源：`user_stats.storage_used/book_count`（api/alembic/versions/0113\_fix\_user\_stats.py:20-37），基础配额来自 `system_settings`（api/app/dependencies.py:38-42）。在文档的配额示例旁补充字段来源与单位，避免硬编码误解。

* OCR 阶梯扣费：与实际实现一致（api/app/ocr.py:62-83,86-107,116-118），建议文档补充「服务器忙并发限制」说明（Redis `ocr:active_jobs` 与 `ocr_concurrency_limit`）（api/app/ocr.py:108-112）。

* 如无以上补充需求，则保持现稿。

## 02\_Functional\_Specifications\_PRD.md

* 垂直切片与契约：逐功能列 DB 模型/关键字段 → API 路由/请求响应 → 前端组件 Props/交互。

* 片段示例（将写入文档）：

  * Auth：邮箱验证码登录与会话（api/app/auth.py:66-101,117-170,203-231；contracts/api/v1/auth.yaml）。

  * Books：`/upload_init`、`/upload_complete`、索引与元数据占位（api/app/books.py:86-99,101-192,176-181）。

  * Notes/Tags/Highlights：创建/分页/ETag 更新（api/app/notes.py:38-71,97-124,143-196,198-220）。

  * OCR Engine：页数来源、扣费策略、优先级与并发（api/app/ocr.py:29-41,62-83,86-112,116-131）。

  * Billing：余额、台账、创建支付会话、Webhook 签名（api/app/billing.py:23-53,56-85,118-154,156-249）。

* 每路由将附 OpenAPI 指向 `contracts/api/v1/*.yaml`；差异处标注「待修正」。

## 03\_System\_Architecture\_and\_Decisions.md

* 技术栈与基础设施：FastAPI/SQLAlchemy/PostgreSQL、SeaweedFS(S3)、OpenSearch、Redis、Celery；以 `docker-compose.yml` 与 `monitoring/*` 为事实来源。

* 域名与网关策略、Webhook 安全（HMAC，api/app/billing.py:156-170）。

* ADR：选择 Mock vs 真实模型的 CI/Prod 边界（与 00 宪法一致）。

## 04\_Database\_Schema\_and\_Migration\_Log.md

* 以 Alembic 版本反推结构，列关键变更：

  * `pricing_rules` 增加 `platform/sku_id`（api/alembic/versions/0108\_add\_pricing\_platform\_sku.py:17-36）。

  * `ocr_jobs` 增加 `book_id/user_id/page_count/deduction_strategy/deduction_amount`（api/alembic/versions/0109\_add\_ocr\_v9\_columns.py:17-63）。

  * `users` 增加 `membership_expire_at/monthly_gift_reset_at/free_ocr_usage`（api/alembic/versions/0110\_add\_users\_v9\_columns.py:17-47）。

  * `invites/user_stats/regional_prices` 新建（api/alembic/versions/0111\_add\_missing\_tables.py:19-52）；`user_stats` 补齐 `storage_used/book_count` 并回填（api/alembic/versions/0113\_fix\_user\_stats.py:20-37）。

* RLS 与会话变量：统一使用 `set_config('app.user_id', ...)`；在文档中给出示例 SQL。

## 05\_API\_Contracts\_and\_Protocols.md

* 协议规范：统一响应包 `{"status":"success","data":...}` 与错误 `HTTPException(detail=...)`；列标准错误码目标与当前实现映射表。

* 指向契约：逐模块链接 `contracts/api/v1/*.yaml`；标注需要统一的枚举。

* 幂等性：`Idempotency-Key` 用法（books/notes），乐观锁 `If-Match`/`ETag` 示例（api/app/notes.py:105-124）。

* 实时通道：WS/SSE（占位，若代码未实现则标注「待修正」）。

## 06\_UI\_UX\_Design\_System.md

* Design Tokens：按 `web/src/styles/figma.css` 列出 Apple/HIG 对齐变量与 Tailwind v4 utilities（web/src/styles/figma.css:3-58,60-111,154-169）。

* 组件规范：统一使用 `components/ui/*`，按钮 CTA 使用统一 Button（web/src/pages/HomePage.tsx:2,30-33）。

* Liquid Glass 头部：`MainLayout` 实现（web/src/components/layouts/MainLayout.tsx:13-25,49-55）；文档给出 CSS 规范与暗色变体建议。

* i18n：前端严格使用 `t('key')`，禁止硬编码（web/src/pages/HomePage.tsx:14,22-33）。

## 07\_DevOps\_and\_SRE\_Manual.md

* 本地开发：Vite HMR、API Base、Cypress/Playwright；CI 质量门禁（.github/workflows/\*）。

* 部署：Docker+Traefik+SeaweedFS/OpenSearch/Redis；密钥管理（scripts/infisical-inject.ps1）。

* 监控告警：Prometheus 配置与仪表盘（monitoring/prometheus.yml、monitoring/dashboards/api.json）。

* 安全门禁：合规签名（Webhook），依赖与密钥扫描（参考 quality gates 文档）。

## +1 PROJECT\_STATUS.md

* 后端：已完成模块与接口（Auth/Books/Notes/OCR/Billing/Admin/Providers 等），以实际路由列清单。

* 前端：已完成页面与组件（Home/Library/Reader/AI/Billing 等）与待办（按 UI 规范需要统一/去内联样式处标注）。

* 测试：API 关键用例（`test_ocr_membership_quota.py` 等）通过情况；前端 cypress 目录存在并需补完的旅程用例。

## 交付方式

* 确认后：在 `docs/zh-CN/` 新增/覆盖 8+1 文件；每份文档均包含代码引用与 MUST 规则；不改动业务逻辑，仅文档对齐。

* 若发现文档与实现不一致，统一以代码为准并在文档中标注「待修正」。

