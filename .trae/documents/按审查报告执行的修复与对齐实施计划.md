## 总体原则

* 以现有数据库迁移和 FIGMA Token 为单一事实来源；所有改动向后兼容（IF NOT EXISTS/RENAME）。

* 严重问题先修：数据库与接口一致性；中问题次之；轻问题并行。

* 每项变更均附带验证与回滚方案；修复同时更新《技术文档/设计标准》对应段落。

## 一、数据库与后端一致性修复

### 1. books.meta.page\_count 建立与回填

* 迁移：为 `books` 增加 `meta JSONB DEFAULT '{}'` 与索引 `idx_books_meta_page`。

* 回填：新增后台任务扫描 `meta.page_count IS NULL`，读取对象（`minio_key`）解析页数并写回；无法解析写 `1` 并打 `needs_manual=true`。

* 写入点：上传完成与深度分析流程中补写 `meta.page_count`；OCR 读取点改为优先读 `meta.page_count`。

* 验证：三类样本（≤600/800/1500页）检查 `ocr_jobs.page_count/deduction_amount/deduction_strategy`。

### 2. conversion\_jobs 列名统一

* 现网核对实际列名（`user_id`/`owner_id`）。

* 若为 `owner_id`：执行列重命名迁移（或短期双列镜像写入触发器），代码统一读写 `user_id`。

* 验证：创建→列表→模拟完成→读取 `output_key` 与用户绑定一致；提供回滚脚本。

### 3. notes/tags/highlights 表与约束

* 新增 Alembic 迁移：创建 `notes/tags/highlights`、`note_tags/highlight_tags`，含 `tsv`、版本/时间戳、`ON DELETE CASCADE`。

* 索引：`idx_*_user_updated`、`GIN(tsv)`、组合 `(user_id, book_id, deleted_at IS NULL)`；`(user_id,name)` 唯一约束（排除软删）。

* RLS：开启行级安全；用户仅访问自身；后台与管理端以 `app.role='admin'` 执行。

* 验证：CRUD、并发 ETag、级联删除、RLS 生效。

## 二、前端与设计系统对齐

### 4. FIGMA Token 补齐系统色实值

* 在 `figma.css` 直接按《设计标准》定义缺失变量（`--color-system-blue`、`--color-label`、`--color-secondary-label`、`--color-system-fill`），Light/Dark 实值。

* 组件短期继续使用当前变量名；中期逐步迁移到统一 FIGMA Token。

* 验证：明暗模式颜色正确、对比度达标、axe 严重/高违规=0。

### 5. Vite 代理与 HMR 对齐

* `vite.config.ts` 使用 `VITE_API_BASE_URL` 代理；开启 `hmr: { protocol: 'ws' }`；Tauri `devPath/CSP` 对齐。

* 文档补充 `.env` 样例与多端调试说明。

* 验证：本地/桌面热重载与 API 基址统一。

### 6. 主页 CTA 复用统一 Button 组件

* 将首页内联按钮替换为 `Button`（`variant='primary'`），对齐样式与 A11Y。

* 验证：视觉一致，焦点环与键盘可用。

## 三、业务与配置对齐

### 7. 定价平台字段贯通

* `pricing` 后台 API 增加 `platform/sku_id` 的读写与返回；更新契约与文档。

* 验证：管理端列表/创建/修改展示并可编辑。

### 8. PWA 离线缓存与同步

* Service Worker：缓存书籍/封面，键 `book-${bookId}-${etag}`；派生资产独立前缀；LRU 清理与离线管理页面。

* IndexedDB：离线 `notes/highlights` 队列，记录 `base_version`；重连乐观并发，冲突生成 `note_versions` 分支供合并/保留。

* 验证：断网可读、重新联网自动同步、冲突可回滚。

### 9. CI 质量门禁强化

* 固化 axe 与核心旅程 E2E 冒烟为门禁；测试环境改 SeaweedFS/OpenSearch。

* 验证：PR 必须通过门槛（axe 严重/高违规=0，E2E 通过）。

## 四、术语与文档统一

* 统一为“对象存储（S3 兼容，默认 SeaweedFS 网关）”，保留 `MINIO_*` 作为兼容前缀说明；更新契约与文档文案。

## 验证与回滚

* 每项改动配套单测/E2E；数据库迁移均 `IF NOT EXISTS/RENAME` 可回滚；前端视觉回归用快照与 axe。

## 交付节奏

* 批次一（严重）：1/2/3 完成并验证。

* 批次二（中）：4/5/7 完成并验证。

* 批次三（轻与体验）：6/8/9 与文案统一并行实施。

