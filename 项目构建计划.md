# 雅典娜 SAAS 从0到可用构建实施计划

## 目标
- 以技术文档为唯一事实来源，构建可运行的 MVP 并按 v7.1/v8.0 强化至工业级质量门禁与可靠性。
- 契约驱动（OpenAPI/SSOT）、零信任（JWT+RLS）、幂等与乐观并发、一切容器化。

## 环境准备
- Docker Compose 清理后重拉；私有镜像域名：`zukubq0aouv2k2.xuanyuan.run`。
- 密钥通过 Infisical 管理并仅服务端注入；Traefik 作为网关；AI 上游经海外代理（`system_settings.ai_proxy_url`）。

## 执行前（缓存清理与镜像拉取）
- 停止与清理：`docker compose down --volumes --remove-orphans`
- 全面清理：`docker system prune -a --volumes -f`
- 登录私仓：`docker login zukubq0aouv2k2.xuanyuan.run`
- 拉取：`docker compose pull`

## 里程碑与子任务（每项均含交付与验证）
1. 仓库体检与对齐
- 交付：差异清单（契约/DDL/RLS/索引/CI脚本）。
- 验证：`@redocly/cli`、`pytest -k contract`、`pnpm lint/typecheck` 通过。

2. 基础设施与编排
- 交付：Compose 服务/网络/卷、Traefik 路由与限流、Infisical 注入、Prom/Grafana/Loki/Jaeger。
- 验证：健康探针、指标抓取与日志入库、路由与限流命中。

3. 数据库与迁移
- 交付：Alembic 迁移（扩展、DDL、RLS、索引、触发器）。
- 验证：迁移/回滚成功、`sqlfluff lint` 通过、RLS 与查询性能正常。

4. 认证与会话（MVP闭环）
- 交付：`contracts/api/v1/auth.yaml` 路由与前端登录页。
- 验证：登录/刷新/会话查询、限流与失败路径。

5. Books & Shelves（上传/任务/下载）
- 交付：`books.yaml/shelves.yaml`、Celery 任务、MinIO 联通。
- 验证：上传→ACTIVE、唯一指纹与幂等、下载预签名有效。

6. Reader & 云同步（心跳）
- 交付：Reader/PWA/IndexedDB 与心跳端点；OCR 双层渲染。
- 验证：位置/进度正确、跨午夜拆分统计、离线可读。

7. Notes & Highlights（CRUD+并发+幂等）
- 交付：`notes.yaml/highlights.yaml`、触发器与索引、前端编辑器。
- 验证：409 并发处理、软删幂等、全文检索命中。

8. Tags & Search（ES+回退）
- 交付：`tags.yaml/search.yaml`、ES 同步任务。
- 验证：高亮片段、过滤与分页、ES中断回退提示。

9. AI 会话与知识内化（RAG）
- 交付：`ai.yaml`、SSE 流式、`ai_query_cache`、海外代理路由。
- 验证：流式≤5s、缓存命中≤500ms、上下文修订一致性。

10. 计费与支付（Credits + Wallet）
- 交付：`billing.yaml`、网关适配器、充值与账单页；新增“钱包余额（Wallet）”与“钱包→Credits 兑换”流程文档与接口规划；用户侧 `pricing/rules` 读取与估算展示。
- 验证：Webhook 签名校验、事务原子入账、余额视图刷新；钱包扣费（OCR/向量化）与账本明细；兑换账本与余额双向变更一致；估算费用与备注随管理员定价即时更新。
 - OCR 定价与扣费验收：管理员在后台配置 `OCR 每页 0.05 CNY`（中国区），前端备注与估算同步更新；模拟 OCR 任务按页扣减钱包并写入账本（debit）。

11. Admin Panel（运营）
- 交付：用户/角色、特性开关、Prompt 模板、AI 模型、系统设置、DLQ 重试、审计、定价规则配置（Pricing Rules）。
- 验证：admin-only RLS、ETag/If-Match、审计记录完整；定价规则 CRUD 与即时生效，前端备注动态渲染正确（按服务/单位/货币/地区）。

12. WebSocket & Yjs（协同）
- 交付：文档频道、冲突检测与版本快照、草稿自动恢复。
- 验证：冲突→草稿保存→自动合并；快照阈值触发。

13. TTS & 词典/翻译
- 交付：原生 TTS 控件与朗读心跳；离线词典/在线代理/AI 翻译。
- 验证：朗读控制条、查词历史入库、AI 翻译扣费与展示。

14. Landing & Marketing（Astro+i18n）
- 交付：主页/定价/登录，Design Tokens 复用，国际化与 hreflang、动态 OG 图片。
- 验证：Lighthouse>90、hreflang/robots/sitemap 正确、SSO 跳转顺畅。

15. CI/CD 与质量门禁
- 交付：`quality-gate` 工作流（合同/类型/Lint/覆盖率/E2E/axe/安全/体积）。
- 验证：PR 保护分支全部通过后方可合并。

## 通用验证策略
- 合同测试（Pact/Jest）、OpenAPI Lint；单元/集成（pytest/Jest）；E2E（Playwright/Cypress）。
- 可观测性：Prom/Loki/Sentry/Jaeger；覆盖率≥85%，变更≥80%。

## 风险与回滚
- 迁移先演练临时库并提供回滚；索引 `CONCURRENTLY`。
- Celery 幂等保障；缓存编辑触发精确失效与 TTL 缩短。

## 运维与合规
- Barman 备份（每日全量+每小时增量）、月度恢复演练；密钥≤90天轮换与告警。

—— 每完成一个子任务即交付代码/配置/迁移与验证证据，再推进下一项。