name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  web:
    name: Web Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: web/pnpm-lock.yaml
      - name: Install deps
        working-directory: web
        run: pnpm install --no-frozen-lockfile
      - name: Lint
        working-directory: web
        run: pnpm lint
      - name: Typecheck
        working-directory: web
        run: pnpm typecheck
      - name: i18n no-hardcode
        working-directory: web
        run: pnpm run i18n:no-hardcode || true
      - name: Install Cypress binary
        working-directory: web
        run: npx cypress install --force
      - name: Build
        working-directory: web
        run: pnpm build
      - name: Preview
        working-directory: web
        run: pnpm preview --port 4173 & sleep 3
      - name: E2E
        working-directory: web
        run: pnpm e2e

  api:
    name: API Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install requirements
        working-directory: api
        run: pip install -r requirements.txt
      - name: Compile Python sources
        run: python -m compileall -q api/app

  compose:
    name: Compose Config Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create env stubs for compose
        run: |
          : > .env.local
          : > .env.infisical
      - name: Validate compose
        run: docker compose --env-file .github/workflows/.env.ci -f docker-compose.yml config

  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_DB: athena_test
          POSTGRES_USER: athena
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U athena -d athena_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install requirements
        working-directory: api
        run: pip install -r requirements.txt
      - name: Install pytest and coverage
        run: pip install pytest pytest-cov
      - name: Apply database migrations
        working-directory: api
        env:
          DATABASE_URL: postgresql://athena:testpassword@localhost:5432/athena_test
        run: |
          alembic -c alembic.ini upgrade 0100_squash_baseline
          alembic -c alembic.ini upgrade head
      - name: Pytest with coverage (>=80%)
        env:
          DATABASE_URL: postgresql+asyncpg://athena:testpassword@localhost:5432/athena_test
          REDIS_URL: redis://localhost:6379
        run: pytest -q --cov=api.app --cov-report=term --cov-fail-under=80

  static-qa:
    name: Python Static QA
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install linters and scanners
        run: pip install flake8 ruff mypy bandit
      - name: flake8
        run: flake8 api || true
      - name: ruff
        run: ruff check api || true
      - name: mypy
        run: mypy api || true
      - name: bandit
        run: bandit -r api -ll || true

  contracts-strict:
    name: Contracts Strict Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Redocly
        run: npm i -g @redocly/cli
      - name: Lint contracts
        run: redocly lint contracts/api/v1/**/*.yaml || true

  trivy-scan:
    name: Trivy FS Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy scan (fs)
        uses: aquasecurity/trivy-action@0.13.1
        with:
          scan-type: fs
          format: table
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: '0'

  runtime-smoke:
    name: Runtime Smoke (optional)
    runs-on: ubuntu-latest
    env:
      STAGING_BASE: ${{ secrets.STAGING_BASE }}
    steps:
      - uses: actions/checkout@v4
      - name: Skip if STAGING_BASE empty
        if: env.STAGING_BASE == ''
        run: echo "No STAGING_BASE provided, skipping"
      - name: Health check
        if: env.STAGING_BASE != ''
        run: |
          curl -fsSL "$STAGING_BASE/health" | tee health.json
      - name: Billing balance
        if: env.STAGING_BASE != ''
        run: |
          curl -fsSL "$STAGING_BASE/api/v1/billing/balance" -H "Authorization: Bearer test" | tee balance.json || true