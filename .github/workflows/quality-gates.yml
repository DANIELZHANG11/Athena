name: Quality Gates

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  gates:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Ensure pnpm
        run: npm i -g pnpm

      - name: Install web deps
        working-directory: web
        run: |
          pnpm install --no-frozen-lockfile

      - name: Contracts lint
        working-directory: web
        run: |
          pnpm run contracts:lint

      - name: ESLint
        working-directory: web
        run: |
          pnpm run lint

      - name: Vitest coverage
        working-directory: web
        run: |
          (pnpm run test:ci || pnpm exec vitest run)

      - name: Ensure Cypress Binary (Windows)
        if: runner.os == 'Windows'
        working-directory: web
        shell: pwsh
        env:
          CYPRESS_CACHE_FOLDER: D:\\.cache\\Cypress
        run: |
          Write-Host "Cache folder: $env:CYPRESS_CACHE_FOLDER"
          npx cypress cache list || true
          npx cypress install --force
          npx cypress verify

      - name: Cypress E2E (axe & flows)
        uses: cypress-io/github-action@v6
        env:
          CYPRESS_CACHE_FOLDER: D:\\.cache\\Cypress
        with:
          working-directory: web
          install-command: pnpm install --no-frozen-lockfile
          start: pnpm preview --port 4173
          wait-on: 'http://localhost:4173'
          spec: |
            cypress/e2e/axe.cy.ts,
            cypress/e2e/billing.cy.ts,
            cypress/e2e/docs.cy.ts